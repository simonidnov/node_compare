var $jscomp={scope:{},findInternal:function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(b.call(c,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(b,a){return $jscomp.findInternal(this,b,a).v}},"es6-impl","es3");
var db=require("mongoose"),config=require("../config/config"),cc=require("coupon-code"),coupons_datas={offer:{type:"string"},label:{type:"string"},description:{type:"string"},code:{type:"string"},amount:{type:"number"},parts:{type:"number","default":1},partLen:{type:"number","default":4},admin_id:{type:"string"},user_id:{type:"string"},already_used:{type:"bool","default":!1},is_valid:{type:"bool","default":!0},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}};
0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});var couponsSchemas=new db.Schema(coupons_datas),Coupon=db.model("Coupons",couponsSchemas);module.exports={attributes:coupons_datas};module.exports.get=function(a,b,c){b={};"undefined"!==typeof a.params.offer&&(b.offer=a.params.offer);Coupon.find(b,function(a,b){a?c({status:405,datas:a}):c({status:200,datas:b})})};
module.exports.getOffers=function(a,b,c){Coupon.aggregate([{$group:{_id:"$offer",count:{$sum:1},already_used:{$sum:{$cond:["$already_used",1,0]}},is_valid:{$sum:{$cond:["$is_valid",1,0]}}}}],function(a,b){a?c({status:405,datas:a}):c({status:200,datas:b})})};
module.exports.getOffersCSV=function(a,b,c){if("undefined"===typeof a.params.offer)c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_NEED_OFFER_NAME",body_datas:a.params}});else var d={offer:a.params.offer};Coupon.find(d,function(a,b){a?c({status:405,datas:a}):c({status:200,datas:b})})};
module.exports.createOffer=function(a,b,c){b=a.body;"undefined"!==typeof b.data&&(b=a.body.data);"undefined"===typeof b.offer&&c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_NEED_OFFER_NAME",body_datas:b}});"undefined"===typeof b.label&&c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_NEED_LABEL"}});"undefined"===typeof b.description&&c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_NEED_DESCRIPTION"}});"undefined"===typeof b.quantity&&
c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_NEED_QUANTITY"}});"undefined"===typeof b.parts&&c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_PARTS"}});"undefined"===typeof b.partLen&&c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_PARTLEN"}});"undefined"===typeof b.amount&&c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_AMOUNT"}});for(var d=0,e=0,f=0;f<b.quantity;f++){var g={offer:b.offer,label:b.label,description:b.description,
code:cc.generate({parts:b.parts,partLen:b.partLen}),amount:b.amount,admin_id:a.session.Auth._id,parts:b.parts,partLen:b.partLen,already_used:!1,is_valid:!0};new_coupon=new Coupon(g);new_coupon.save(function(a,b){a?d++:e++});f===b.quantity-1&&c({status:200,errors:d,success:e,total:e,percent:b.quantity/e*100,quantity:b.quantity,response_display:{title:"Coupons cr\u00e9\u00e9s",message:b.quantity+" Coupons viennent d'\u00eatre cr\u00e9\u00e9s | "+d+" erreurs d\u00e9tect\u00e9es"}})}};
module.exports.create=function(a,b,c){b=a.body;delete b.options;delete b._id;delete b.user;new_coupon=new Coupon(a.body);new_coupon.save(function(a,b){a?c({status:405,message:a}):c({status:200,datas:b})})};module.exports.update=function(a,b,c){a.body.updated=Date.now();Coupon.updateOne({_id:a.body.coupon_id},{$set:a.body},function(a,b){a?c({status:304,message:a}):c({status:200,pages:b})})};
module.exports["delete"]=function(a,b,c){b={};"undefined"!==typeof a.body.offer&&(b.offer=a.body.offer);"undefined"!==typeof a.body.coupon_id&&(b._id=a.body.coupon_id);"undefined"!==typeof a.body.code&&(b.code=a.body.code);Coupon.deleteMany(b,function(a,b){a?c({status:405,message:a}):c({status:200,pages:b})})};
