const db=require("mongoose"),config=require("../config/config"),language_helper=require("../helpers/languages_helper");products_datas={label:{type:"string",unique:!0},description:{type:"string"},keywords:{type:"string"},category:{type:"string"},sub_category:{type:"string"},extra_category:{type:"string"},public_target:{type:"string"},typology:{type:"string"},app_id:{type:"string"},phonetik:{type:[]},thumb:{type:"string"},picture:{type:"string"},details:{type:"string"},price:{type:"number"},devise:{type:"string",enum:["€","£","$"]},type:{type:"string",enum:["physical","demateralized"]},attributs:{type:"Object"},medias:{type:"Array"},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now}},fs=require("fs"),0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const productsSchemas=new db.Schema(products_datas);productsSchemas.pre("find",function(e){e()});const Products=db.model("Products",productsSchemas);module.exports={attributes:products_datas},module.exports.get=function(e,t,s){var a={};void 0!==e.product_id&&(a._id=e.product_id),void 0!==e.phonetik&&(a.phonetik={$in:language_helper.wordlab(e.phonetik).split("-")}),Products.find(a,function(e,t){s(e?{status:304,datas:{title:"PRODUCT_GET_ERROR",message:"PRODUCT_GET_ERROR_MESSAGE",media:"PRODUCT_GET_ERROR_MEDIA",code:e.code,errmsg:e.errmsg}}:{status:200,datas:t})})},module.exports.create=function(e,t,s){function a(e,t,s){return s.indexOf(e)===t}delete t.options,delete t.device_infos;var i=language_helper.wordlab(t.label+" "+t.description).split("-");t.phonetik=i.filter(a),new_product=new Products(t),new_product.save(function(e,t){s(e?{status:304,datas:{title:"PRODUCT_CREATED_ERROR",message:"PRODUCT_CREATED_ERROR_MESSAGE",media:"PRODUCT_CREATED_ERROR_MEDIA",code:e.code,errmsg:e.errmsg}}:{status:200,datas:{infos:t,title:"PRODUCT_CREATED",message:"PRODUCT_CREATED_MESSAGE",media:"PRODUCT_CREATED_MEDIA"}})})},module.exports.update=function(e,t,s,a){function i(e,t,s){return s.indexOf(e)===t}delete s.options,delete s.device_infos,delete s._id,console.log(s),console.log(s.category),console.log(s.sub_category),console.log(s.extra_category),console.log(s.app_id),s.updated=Date.now();var d=language_helper.wordlab(s.label+" "+s.description).split("-"),o=d.filter(i);Products.updateOne({_id:t},{$set:s,phonetik:o},function(e,t){a(e?{status:304,datas:{title:"PRODUCT_UPDATED_ERROR",message:"PRODUCT_UPDATED_ERROR_MESSAGE",media:"PRODUCT_UPDATED_ERROR_MEDIA",code:e.code,errmsg:e.errmsg}}:{status:200,datas:{infos:t,title:"PRODUCT_UPDATED",message:"PRODUCT_UPDATED_MESSAGE",media:"PRODUCT_UPDATED_MEDIA"}})})},module.exports.delete=function(e,t,s){Products.deleteOne({_id:t},function(e,t){s(e?{status:304,datas:{title:"PRODUCT_DELETED_ERROR",message:"PRODUCT_DELETED_ERROR_MESSAGE",media:"PRODUCT_DELETED_ERROR_MEDIA",code:e.code,errmsg:e.errmsg}}:{status:200,datas:{infos:t,title:"PRODUCT_DELETED",message:"PRODUCT_DELETED_MESSAGE",media:"PRODUCT_DELETED_MEDIA"}})})},module.exports.getFile=function(e,t,s){fs.readFile("./uploads/"+e.params.filename,function(e,t){if(e)throw e;content=t,s({status:200,datas:content})})},module.exports.addFile=function(e,t,s){Products.updateOne({_id:e},{$push:{medias:{fieldname:t.filedname,originalname:t.originalname,encoding:t.encoding,mimetype:t.mimetype,destination:t.destination,filename:t.filename,path:t.path,size:t.size}}},function(e,t){s(e?{status:403,datas:{title:"PRODUCT_UPDATED_ERROR",message:"PRODUCT_UPDATED_ERROR_MESSAGE",media:"PRODUCT_UPDATED_ERROR_MEDIA",code:e.code,errmsg:e.errmsg}}:{status:200,datas:{infos:t,title:"PRODUCT_UPDATED",message:"PRODUCT_UPDATED_MESSAGE",media:"PRODUCT_UPDATED_MEDIA"}})})},module.exports.removeFile=function(e,t,s){fs.unlink("./uploads/"+t,function(){}),this.get(null,{_id:e},function(a){if(200===a.status){for(var i=[],d=0;d<a.datas[0].medias.length;d++)void 0!==a.datas[0].medias[d]&&void 0!==a.datas[0].medias[d][0]&&null!==a.datas[0].medias[d][0]&&a.datas[0].medias[d][0].filename!==t&&i.push(a.datas[0].medias[d]);Products.updateOne({_id:e},{medias:i},function(e,t){s(e?{status:403,datas:{title:"PRODUCT_UPDATED_ERROR",message:"PRODUCT_UPDATED_ERROR_MESSAGE",media:"PRODUCT_UPDATED_ERROR_MEDIA",code:e.code,errmsg:e.errmsg}}:{status:200,datas:{infos:t,title:"MEDIA_DELETED",message:"MEDIA_DELETED",media:"MEDIA_DELETED"}})})}else s({status:403,datas:{title:"PRODUCT_UPDATED_ERROR",message:"PRODUCT_UPDATED_ERROR_MESSAGE",media:"PRODUCT_UPDATED_ERROR_MEDIA",code:err.code,errmsg:err.errmsg}})})};