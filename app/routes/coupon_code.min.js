var express=require("express"),coupon_code=express.Router(),Json2csvParser=require("json2csv").Parser,fs=require("fs"),Auth_helper=require("../helpers/auth_helper"),Coupon_controller=require("../controllers/coupon_controller"),auth_helper=require("../helpers/auth_helper"),language_helper=require("../helpers/languages_helper"),uri_helper=require("../helpers/uri_helper"),lang=require("../public/languages/auth_lang");
coupon_code.use(function(c,a,d){a.setHeader("Access-Control-Allow-Origin","*");a.setHeader("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept");a.setHeader("Access-Control-Allow-Methods","GET, PUT, POST, DELETE");a.setHeader("Content-Type","application/json");d()});
coupon_code.get("/",function(c,a,d){Auth_helper.validate_admin(c,function(b){200===b.status?d():a.redirect(307,"/auth?message=NO_ACCESS_RIGHTS_COUPONS")})},function(c,a,d){Coupon_controller.get(c,a,function(b){a.status(b.status).send(b);a.end()})});
coupon_code.get("/update_amount",function(c,a,d){Auth_helper.validate_admin(c,function(b){200===b.status?d():a.redirect(307,"/auth?message=NO_ACCESS_RIGHTS_COUPONS")})},function(c,a,d){Coupon_controller.updateAmount(c,a,function(b){a.status(b.status).send(b);a.end()})});coupon_code.get("/valid",function(c,a,d){d()},function(c,a,d){"undefined"===typeof c.query.code&&a.status(400).send({status:400,message:"NEED_CODE"});Coupon_controller.get(c,a,function(b){a.status(b.status).send(b);a.end()})});
coupon_code.get("/download/:offer",function(c,a,d){Auth_helper.validate_admin(c,function(b){200===b.status?d():a.status(403).send({title:"UNAUTHORIZED",message:"NO_ACCESS_RIGHTS_COUPONS"})})},function(c,a,d){Coupon_controller.getOffersCSV(c,a,function(b){b=(new Json2csvParser({fields:["code","offer","amount"]})).parse(b.datas);var c="./uploads/file"+Date.now()+".csv";fs.writeFile(c,b,function(b,d){b?a.status(200).send(b):a.redirect(307,c.replace("./","/"))})})});
coupon_code.get("/offers",function(c,a,d){Auth_helper.validate_admin(c,function(b){200===b.status?d():a.redirect(307,"/auth?message=NO_ACCESS_RIGHTS_COUPONS")})},function(c,a,d){Coupon_controller.getOffers(c,a,function(b){a.status(b.status).send(b);a.end()})});coupon_code.post("/",function(c,a,d){a.status(200).send({message:"OUTCH PADAWAN ! YOU CANNOT CREATE ANY COUPON"});a.end()});
coupon_code.post("/create_offer",function(c,a,d){Auth_helper.validate_admin(c,function(b){200===b.status?d():a.redirect(307,"/auth?message=NO_ACCESS_RIGHTS_COUPONS")})},function(c,a,d){Coupon_controller.createOffer(c,a,function(b){a.status(b.status).send(b);a.end()})});coupon_code.put("/",function(c,a,d){console.log("PUT COUPON UPDATE !!!!!!!!!!");Coupon_controller.update(c,a,function(b){a.status(b.status).send(b);a.end()})});
coupon_code.put("/update_offer",function(c,a,d){console.log("PUT OFFER UPDATE !!!!!!!!!!");Coupon_controller.updateOffer(c,a,function(b){a.status(b.status).send(b);a.end()})});coupon_code["delete"]("/",function(c,a,d){Auth_helper.validate_admin(c,function(b){200===b.status?d():a.redirect(307,"/auth?message=NO_ACCESS_RIGHTS_COUPONS")})},function(c,a,d){Coupon_controller["delete"](c,a,function(b){a.status(b.status).send(b);a.end()})});module.exports=coupon_code;
