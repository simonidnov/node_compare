const db=require("mongoose"),config=require("../config/config"),cc=require("coupon-code"),coupons_datas={offer:{type:"string"},label:{type:"string"},description:{type:"string"},code:{type:"string"},amount:{type:"number"},parts:{type:"number",default:1},partLen:{type:"number",default:4},admin_id:{type:"string"},user_id:{type:"string"},already_used:{type:"bool",default:!1},is_valid:{type:"bool",default:!0},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const couponsSchemas=new db.Schema(coupons_datas),Coupon=db.model("Coupons",couponsSchemas);module.exports={attributes:coupons_datas},module.exports.get=function(e,t,s){var o={};void 0!==e.params.offer&&(o.offer=e.params.offer),Coupon.find(o,function(e,t){s(e?{status:405,datas:e}:{status:200,datas:t})})},module.exports.getOffers=function(e,t,s){Coupon.aggregate([{$group:{_id:"$offer",count:{$sum:1},already_used:{$sum:{$cond:["$already_used",1,0]}},is_valid:{$sum:{$cond:["$is_valid",1,0]}}}}],function(e,t){s(e?{status:405,datas:e}:{status:200,datas:t})})},module.exports.getOffersCSV=function(e,t,s){if(void 0===e.params.offer)s({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_NEED_OFFER_NAME",body_datas:e.params}});else var o={offer:e.params.offer};Coupon.find(o,function(e,t){s(e?{status:405,datas:e}:{status:200,datas:t})})},module.exports.createOffer=function(e,t,s){var o=e.body;void 0!==o.data&&(o=e.body.data),void 0===o.offer&&s({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_NEED_OFFER_NAME",body_datas:o}}),void 0===o.label&&s({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_NEED_LABEL"}}),void 0===o.description&&s({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_NEED_DESCRIPTION"}}),void 0===o.quantity&&s({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_NEED_QUANTITY"}}),void 0===o.parts&&s({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_PARTS"}}),void 0===o.partLen&&s({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_PARTLEN"}}),void 0===o.amount&&s({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_AMOUNT"}});for(var a=0,n=0,d=0;d<o.quantity;d++){var u={offer:o.offer,label:o.label,description:o.description,code:cc.generate({parts:o.parts,partLen:o.partLen}),amount:o.amount,admin_id:e.session.Auth._id,parts:o.parts,partLen:o.partLen,already_used:!1,is_valid:!0};new_coupon=new Coupon(u),new_coupon.save(function(e,t){e?a++:n++}),d===o.quantity-1&&s({status:200,errors:a,success:n,total:n,percent:o.quantity/n*100,quantity:o.quantity,response_display:{title:"Coupons créés",message:o.quantity+" Coupons viennent d'être créés | "+a+" erreurs détectées"}})}},module.exports.create=function(e,t,s){var o=e.body;delete o.options,delete o._id,delete o.user,new_coupon=new Coupon(e.body),new_coupon.save(function(e,t){s(e?{status:405,message:e}:{status:200,datas:t})})},module.exports.update=function(e,t,s){e.body.updated=Date.now(),Coupon.updateOne({_id:e.body.coupon_id},{$set:e.body},function(e,t){s(e?{status:304,message:e}:{status:200,pages:t})})},module.exports.delete=function(e,t,s){var o={};void 0!==e.body.offer&&(o.offer=e.body.offer),void 0!==e.body.coupon_id&&(o._id=e.body.coupon_id),void 0!==e.body.code&&(o.code=e.body.code),Coupon.deleteMany(o,function(e,t){s(e?{status:405,message:e}:{status:200,pages:t})})};