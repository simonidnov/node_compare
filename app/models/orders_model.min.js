var $jscomp={scope:{},findInternal:function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,f=0;f<d;f++){var e=a[f];if(b.call(c,e,f,a))return{i:f,v:e}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var f=a[d];f in c||(c[f]={});c=c[f]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6-impl","es3");
var db=require("mongoose"),config=require("../config/config"),basket_model=require("../models/basket_model"),wallets_model=require("../models/wallets_model"),coupon_model=require("../models/coupon_model"),Auth_model=require("../models/auth_model"),Products_controller=require("../controllers/products_controller"),Userproducts_controller=require("../controllers/userproducts_controller"),Email_controller=require("../controllers/email_controller"),order_datas={basket_id:{type:"string"},user_id:{type:"string"},
stripeToken:{type:"string"},devise:{type:"string"},amount:{type:"Number"},reduced_amount:{type:"Number"},coupons_code:{type:"Object"},bill_number:{type:"string"},metadata:{type:"Object"},response:{type:"Object"},refund:{type:"Object"},basketdatas:{type:"Object"},status:{type:"Boolean"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}},keyPublishable="",keySecret="";0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});
var ordersSchemas=new db.Schema(order_datas),Orders=db.model("Orders",ordersSchemas);module.exports={attributes:order_datas};module.exports.getUserOrders=function(a,b,c){"undefined"===typeof a.current_user._id?c({status:401,message:{message:"UNAUTHORISED_NEED_USER"}}):Orders.find({user_id:a.current_user._id},function(a,b){a?c({status:405,error:a}):c({status:200,datas:b})}).sort({created:-1})};
module.exports.get=function(a,b,c){b={};a.is_admin||("undefined"!==typeof a.session.Auth?b={user_id:a.session.Auth._id}:"undefined"!==typeof a.query.user_id?b={user_id:a.query.user_id}:"undefined"!==typeof a.query.options&&(b={user_id:a.query.options.user_id}));"undefined"!==typeof a.query._id&&(b._id=a.query._id);"undefined"===typeof b.user_id&&"undefined"===typeof a.is_admin&&c({status:401,datas:{message:"UNAUTHORISED_NEED_USER"}});Orders.find(b,function(a,b){a?c({status:405,datas:a}):c({status:200,
datas:b})}).sort({created:-1})};module.exports.getBill=function(a,b,c){var d={};b.is_admin||(d.user_id=a);"undefined"!==typeof b.bill_number&&(d.bill_number=b.bill_number);"undefined"!==typeof b._id&&(d._id=b._id);Orders.findOne(d,function(a,b){a?c({status:405,datas:a}):c({status:200,datas:b})})};
module.exports.buy_with_coupon=function(a,b,c){if("undefined"===typeof a.body.data.coupon_code)return c({status:400,message:"NEED_COUPON_CODE",response_display:{title:"Code de t\u00e9l\u00e9chargement",message:"Vous devez renseigner un Code de t\u00e9l\u00e9chargement valide pour effectuer cette op\u00e9ration."}}),!1;if("undefined"===typeof a.body.data.coupon_id)return c({status:400,message:"NEED_COUPON_ID",response_display:{title:"Code de t\u00e9l\u00e9chargement",message:"Le coupon est incorrect ou mal renseign\u00e9, veuillez r\u00e9essayer ult\u00e9rieurement."}}),
!1;if("undefined"===typeof a.body.data.product_id)return c({status:400,message:"NEED_PRODUCT_ID",response_display:{title:"Code de t\u00e9l\u00e9chargement",message:"Pour utiliser votre Code de t\u00e9l\u00e9chargement, vous devez choisir un produit."}}),!1;if("undefined"===typeof a.body.data.options.user_id)return c({status:400,message:"NEED_USER_ID",response_display:{title:"Code de t\u00e9l\u00e9chargement",message:"Vos identifiants sont incorrects, si le probl\u00e8me persiste veuillez vous d\u00e9connecter puis vous reconnecter"}}),
!1;Products_controller.get(a.body.data,b,function(d){200===d.status&&Userproducts_controller.allreadyBuy(a.body.data.options.user_id,a.body.data.product_id,function(d){200===d.status?c({status:208,message:"PRODUCT_ALREADY_BUY",response_display:{title:"Produit d\u00e9j\u00e0 ajout\u00e9 !",message:"Vous tentez d'ajouter un produit que vous avez d\u00e9j\u00e0 achet\u00e9 !<br>rendez-vous sur votre compte pour le t\u00e9l\u00e9charger ou sur sur votre playlist pour l'\u00e9couter.",buttons:[{"class":"btn-success",
label:"MES ACHATS",href:app.locals.settings.host+"/account/orders",target:"_self",value:"/account/orders"},{"class":"",label:"PLAYLIST",href:"/playlist",target:"_self",value:"/playlist"}]}}):coupon_model.is_valid(a.body.data.coupon_code,a.body.data.coupon_id,function(d){200===d.status?Userproducts_controller.create({user_id:a.body.data.options.user_id,product_id:a.body.data.product_id},b,function(b){200===b.status?coupon_model.useOne({_id:a.body.data.coupon_id,user_id:a.body.data.options.user_id},
function(a){200===a.status?c({status:200,message:"PRODUCT_ADDED",response_display:{title:"Votre chanson !",message:"Votre chanson est \u00e0 pr\u00e9sent disponible sur votre playlist !<br>Votre code de t\u00e9l\u00e9chargement est \u00e0 pr\u00e9sent valid\u00e9 et ne peut plus \u00eatre utilis\u00e9.",buttons:[{"class":"btn-success",label:"PLAYLIST",href:"http://machanson.joyvox.fr/playlist",target:"_self",value:"/playlist"}]}}):c({status:208,message:"UNABLE_TO_USE_COUPON_CODE",response_display:{title:"ERREUR",
message:"une erreur est survenur, pas d'inqui\u00e8tude, votre coupon code de t\u00e9l\u00e9chargement est toujours valide."}})}):(b.response_display={title:"Coupon Code",message:"une erreur est survenur mais pas d'inqui\u00e8tudes !<br>votre coupon code de t\u00e9l\u00e9chargement est toujours valide, vous pouvez toujours l'utiliser."},c(b))}):c({status:208,message:"WRONG_COUPON_CODE",response_display:{title:"Coupon Code",message:"Le coupon renseign\u00e9 est invalide, veuillez en utiliser un autre.<br>Si vous n'avez jamais utilis\u00e9 ce coupon, veuillez nous contacter pour en obtenir un nouveau.",
buttons:[{"class":"btn-warning",label:"NOUS CONTACTER",href:app.locals.settings.host+"/contact",target:"_self",value:"/account/contact"}]}})})})})};
module.exports.refundCharge=function(a,b,c){"undefined"!==typeof a.data&&(a=a.data);app.locals.settings.StripeMode?(keyPublishable=app.locals.settings.StripekeyPublishable,keySecret=app.locals.settings.StripekeySecret):(keyPublishable=app.locals.settings.StripekeyPublishableTest,keySecret=app.locals.settings.StripekeySecretTest);var d=require("stripe")(keySecret);"undefined"===typeof a.order_id&&c({status:401,message:"NEED_ORDER_ID"});Orders.findOne({_id:a.order_id},function(b,e){b?c({status:403,
message:"ORDER_DOESNT_MATCH",response_display:{title:"Remboursement",message:"La transaction que vous tentez de rembourser est introuvable, assurez-vous de ne pas faire nimporte quoi avant de contacter un administrateur."}}):d.refunds.create({charge:e.response.id},function(b,d){b?"charge_already_refunded"===b.code?Orders.updateOne({_id:a.order_id},{refund:b},function(a,b){a?c({status:403,message:"ALREADY_REFUNDED_BY_STRIPE",response_display:{title:"Attention Remboursement",message:"Il semble que la commande soit d\u00e9j\u00e0 rembours\u00e9e par Stripe, pour plus d'informations rendez-vous sur Stripe."}}):
(Email_controller.send(null,{subject:"Votre remboursement Joyvox",title:"Votre paiement vient d'\u00eatre rembours\u00e9 !",message:"Votre remboursement pour la commande "+e.bill_number+" d'un montant de "+e.reduced_amount/100+"\u20ac a bien \u00e9t\u00e9 pris en charge.<br>Le remboursement est en cours de traitement par votre banque et sera bient\u00f4t effectif sur votre compte bancaire.<br><br>Le statu de votre facture est \u00e0 pr\u00e9sent marqu\u00e9 comme \u00e9tant rembours\u00e9 et les produits en t\u00e9l\u00e9chargement concernant cette commande ne sont \u00e0 pr\u00e9sent plus acc\u00e9ssibles via votre compte utilisateur Joyvox.<br><br>Cordialiement,<br> l'\u00e9quipe Joyvox.<br>",
buttons:[{title:"Mon compte",url:"http://auth.joyvox.fr/account"}],email:e.response.source.name,to:e.response.source.name},function(a){}),c({status:200,message:"ALREADY_REFUNDED_BY_STRIPE_AND_UPDATED_BY_JOYVOX",response_display:{title:"Remboursement",message:"Le remboursement que vous tentez d'effectuer est d\u00e9j\u00e0 effectif sur la console Stripe. Nous venons de mofidier le status de la commande en REMBOURS\u00c9."}}))}):c({status:403,message:"REFUND_IMPOSSIBLE",response_display:{title:"Remboursement",
message:"Stripe refuse d'effectuer le remboursement, vous trouverez plus d'informations dans la console, si le probl\u00e8me perciste veuillez contacter un administrateur ayant acc\u00e8s \u00e0 la console Stripe."},err:b}):Orders.updateOne({_id:a.order_id},{refund:d},function(a,b){a?c({status:403,message:"CANT_UPDATE_ORDER_STATUS",response_display:{title:"Attention Remboursement",message:"Le remboursement est bien effectif sur stripe mais nous n'avons pas r\u00e9ussi \u00e0 mettre \u00e0 jour le status de la facture. Veuillez contacter un administrateur pour le changer manuellement."}}):
(Email_controller.send(null,{subject:"Votre remboursement Joyvox",title:"Votre paiement vient d'\u00eatre rembours\u00e9 !",message:"Votre remboursement pour la commande "+e.bill_number+" d'un montant de "+e.reduced_amount/100+"\u20ac a bien \u00e9t\u00e9 pris en charge.<br>Le remboursement est en cours de traitement par votre banque et sera bient\u00f4t effectif sur votre compte bancaire.<br>Vos produits concernant cette commande ne sont \u00e0 pr\u00e9sent plus acc\u00e9ssibles.<br>\u00c0 bient\u00f4t sur joyvox !<br>",
buttons:[{title:"Mon compte",url:"http://auth.joyvox.fr/account"}],email:e.response.source.name,to:e.response.source.name},function(a){}),c({status:200,message:"ORDER_REFUND_STATUS_UPDATED",response_display:{title:"Remboursement",message:"Le remboursement a bien \u00e9t\u00e9 pris en charge, il sera effectif apr\u00e8s traitement de la plateforme de paiement Stripe, le statu de la facture du client a \u00e9g\u00e9lament bien \u00e9t\u00e9 mis \u00e0 jour et le client sera averti lorsque son remboursement sera effectif."}}))})})})};
module.exports.createCharge=function(a,b,c){app.locals.settings.StripeMode?(keyPublishable=app.locals.settings.StripekeyPublishable,keySecret=app.locals.settings.StripekeySecret):(keyPublishable=app.locals.settings.StripekeyPublishableTest,keySecret=app.locals.settings.StripekeySecretTest);var d=require("stripe")(keySecret);"undefined"===typeof a.basket_id&&c({status:401,message:"NEED_BASKET_ID"});"undefined"===typeof a.user_id&&c({status:401,message:"NEED_USER_ID"});var f=0,e=0,q=this;basket_model.get(a,
b,function(l){var r=l.datas[0];if(200===l.status){for(var g=0;g<l.datas[0].products.length;g++)f+=l.datas[0].products[g].price;e=f;if("undefined"!==typeof a.coupons_code&&""!==a.coupons_code)for(var k=JSON.parse(a.coupons_code),g=0;g<k.length;g++)e-=k[g].amount;0>e&&(e=0);var p=a.stripeToken;d.charges.create({amount:e,currency:"eur",description:"payment ",source:p},function(d,g){d?c({status:401,message:"BASKET_DOESNT_MATCH",response_display:{title:"Paiement",message:"Un probl\u00e8me est survenu lors du r\u00e8glement de votre commande. Celle-ci n\u2019a pas \u00e9t\u00e9 valid\u00e9e et votre compte ne sera pas d\u00e9bit\u00e9.<br>Nous vous prions de nous excuser et vous invitons \u00e0 renouveler l\u2019op\u00e9ration ult\u00e9rieurement."}}):
Orders.find().count().exec(function(d,t){var h="FA",h=h+(new Date(Date.now())).getFullYear().toString().substring(1,4),h=h+(t/1E6).toString().replace("0.",""),m={basket_id:a.basket_id,user_id:a.user_id,stripeToken:p,devise:"eur",amount:f,reduced_amount:e,coupons_code:k,bill_number:h,metadata:r,response:g,basketdatas:l.datas[0],status:1};if("undefined"!==typeof k)for(var n=0;n<k.length;n++)coupon_model.useOne({_id:k[n].id,user_id:a.user_id},function(a){});basket_model.deleteUserBasket(a.user_id,function(a){});
q.create(m,b,function(b){200===b.status?(Auth_model.getUserInfosFromOrderController(a.user_id,function(a){200===a.status&&(Email_controller.send(null,{subject:"Votre facture Joyvox",title:"Votre commande vient d'\u00eatre valid\u00e9e !",message:"Votre r\u00e9glement pour la commande "+h+" d'un montant de "+g.amount/100+'\u20ac a bien \u00e9t\u00e9 pris en charge.<br>Pour plus d\'informations et obetenir votre facture, rendez-vous sur <a href="https://auth.joyvox.fr/account/orders">votre compte client dans la rubrique Achats</a>.<br>Pour \u00e9couter votre chanson, rendez-vous dans votre playlist !<br>Merci et \u00e0 bient\u00f4t sur joyvox !<br>',
buttons:[{title:"Ma playlist",url:"http://machanson.joyvox.fr/playlist"}],email:a.user.email,to:a.user.email},function(a){}),Email_controller.send(null,{subject:"Nouvelle commande sur JOYVOX",title:"UNE NOUVELLE COMMANDE VIENT D'\u00caTRE R\u00c9GL\u00c9E SUR JOYVOX",message:"Num\u00e9ro de commande : "+h+"<br>Montant : "+g.amount/100+'\u20ac<br>a bien \u00e9t\u00e9 pris en charge.<br>Pour plus d\'informations et obetenir la facture, rendez-vous sur <a href="https://auth.joyvox.fr/admin">Dans la rubrique facturation</a>.<br>',
email:"service.transaction@joyvox.fr",to:"service.transaction@joyvox.fr"},function(a){}))}),c({status:200,datas:m})):(b.datas=m,c(b))})})})}else c({status:401,message:"BASKET_DOESNT_MATCH",response_display:{title:"Mon Panier",message:"Impossible de continuer car les param\u00e8tres de votre requ\u00eate sont invalides."}})})};module.exports.create=function(a,b,c){new_order=new Orders(a);new_order.save(function(a,b){a?c({status:405,message:a}):c({status:200,datas:b})})};
module.exports.update=function(a,b,c){a={};a.updated=Date.now();Orders.updateOne({_id:ORDER_ID},{$set:a},function(a,b){a?c({status:405,message:a}):c({status:200,apps:b})})};module.exports["delete"]=function(a,b,c){c({status:401,message:"UNAUTHORISED_METHOD"})};
