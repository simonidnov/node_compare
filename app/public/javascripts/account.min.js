"use strict";$(function(){account.init()});var account={user:null,sdk:null,coupons:[],init:function(){this.create_forms(),this.set_listeners()},set_listeners:function(){$("#request_validation_code").off("click").on("click",function(){index.sdk.api.post("/api/request_validation_code",{user_id:$(this).attr("data-userid"),user_email:$(this).attr("data-useremail")},function(t){})}),$(".account_validation .cross_button").off("click").on("click",function(){$("#account_validation").remove()}),$("[data-action]").on("click",function(){switch($(this).attr("data-action")){case"delete":var t={};t[$(this).attr("data-type")]=$(this).attr("data-value"),index.sdk.api.call("DELETE",$(this).attr("data-post"),t,function(t){window.location.reload()});break;case"edit":$("#"+$(this).attr("data-edittemplate")).length>0&&$("#"+$(this).attr("data-edittemplate")).remove(),$(".editable").removeClass("editable");var a=$(this).parent().parent();index.sdk.template($(this).attr("data-edittemplate"),{member_id:$(this).attr("data-value")},function(t){a.append(t),account.member_edit_form=new formular("#member_edit_form",function(t){if(void 0!==t.action)switch(t.action){case"cancel":a.removeClass("editable"),$("#member_edit_form").remove();break;case"save":var e={member_id:$("#member_edit_form").attr("data-memberid")};$.each($("#member_edit_form form").serializeArray(),function(t,a){e[a.name]=a.value}),void 0!==$("#member_edit_form #child_avatar").attr("data-path")&&(e.avatar=$("#member_edit_form #child_avatar").attr("data-path")),index.sdk.api.put("/me/members",e,function(t){200===t.status&&(a.removeClass("editable"),$("#member_edit_form").remove())})}}).init(),a.addClass("editable")})}}),this.init_map()},init_map:function(){var t={lat:40,lng:1},a=this,e=new google.maps.Map(document.getElementById("map_preview"),{zoom:1,center:t});new google.maps.Geocoder,new google.maps.InfoWindow;$("#postalCode, #city, #address, #addressCountry").off("blur").on("blur",function(){if(void 0!==a.marker&&a.marker.setMap(null),""===$("#address").val()&&""===$("#city").val()&&""===$("#postalCode").val())return!1;$.get("https://maps.googleapis.com/maps/api/geocode/json?address="+$("#address").val()+"+"+$("#city").val()+"+"+$("#postalCode").val()+"+"+$("#addressCountry").val()+"&key=AIzaSyB_MlYEDlRnNWYtrn-y63pbjrWecYaocqs",function(t){a.marker=new google.maps.Marker({position:t.results[0].geometry.location,map:e}),e.setZoom(16),e.setCenter(a.marker.getPosition())})})},check_amount:function(){index.sdk.api.get("/basket/amount",{coupon_code:account.coupons},function(t){$(".coupons_infos .message").html("Nouveau montant à régler :"),$(".coupons_infos .amount").html((t.new_amount/100).toFixed(2)+" €"),$(".coupons_infos").addClass("showed");for(var a="",e=0;e<account.coupons.length;e++)a+=account.coupons[e].code+" ";$("#coupons_code").val(JSON.stringify(account.coupons)),void 0!==t.wallet_infos&&$(".wallet_infos .message").html("En validant votre panier avec vos "+account.coupons.length+" coupons de réduction, un coupon de réduction "+t.wallet_infos.label+" sera crédité sur votre porte monnaie d'une valeur de "+t.dif_amount/100+"€, vous pourrez l'utiliser plus tard avec votre compte client.<br><br>"),$("#order_transaction").attr("data-amount",t.new_amount),$(".wallet_infos .message").append("En validant, vous utiliserez les coupons suivants :<br><b>"+a+"</b>"),$(".wallet_infos").addClass("showed")})},create_forms:function(){this.bill_adress_form=new formular("#bill_address",function(t){"checkbox"===t.status&&index.sdk.api.put("/basket",{basket_id:$("#bill_address").attr("data-basketid"),address_id:$('input[name="bill_adress"]:checked').val()},function(t){})}),this.bill_adress_form.init(),this.checkout_form=new formular("#checkout_form",function(t){if("blur"===t.status&&$("#coupon_code").val().length>=3&&index.sdk.api.get("/coupon_code/valid",{code:$("#coupon_code").val()},function(t){t.datas.length>=1?(0===$('[data-code="'+t.datas[0].code+'"]').length&&$("#coupons_list").append('<li data-code="'+t.datas[0].code+'" data-amount="'+t.datas[0].amount+'"><div class="code">coupon code : '+t.datas[0].code+'</div><div class="amount">'+t.datas[0].label+" : "+t.datas[0].amount/100+" €</div></li>"),$("#coupon_code").val("").parent().removeClass("notempty").removeClass("valid"),account.coupons.push(t.datas[0]),account.check_amount(),$("#coupon_code").parent().find(".input_error").remove()):$("#coupon_code").parent().removeClass("valid").addClass("invalid").append('<div class="input_error">'+$("#coupon_code").attr("data-errormessage")+"</div>")}),"hitted"===t.status&&"submit"===t.action){var a=$("#order_transaction"),e=a.parents("form");console.log("HIT ???");var o=$.extend({},a.data(),{token:function(t){console.log("result ",t),e.append($("<input>").attr({type:"hidden",name:"stripeToken",value:t.id})).submit()}});0===parseFloat($("#order_transaction").attr("data-amount"))?index.sdk.api.post("/orders/buy_product_with_coupon_code",{product_id:$("[data-productid]").eq(0).attr("data-productid"),coupon_code:account.coupons[0].code,coupon_id:account.coupons[0]._id,amount:account.coupons[0].amount},function(t){200===t.status&&index.sdk.api.deleting("/basket",{basket_id:$("[data-basketid]").eq(0).attr("data-basketid"),product_id:$("[data-productid]").eq(0).attr("data-productid")},function(t){t.status})}):StripeCheckout.open(o)}}),this.checkout_form.init(),this.public_form=new formular("#public_datas",function(t){if("hitted"===t.status&&"submit"===t.action){var a=account.public_form.get_datas();index.sdk.api.put("/account/profile/",a,function(t){})}}),this.public_form.init(),this.private_form=new formular("#private_datas",function(t){if("hitted"===t.status&&"submit"===t.action){var a=account.private_form.get_datas();a.gender=$("input[name=gender]:checked").val(),index.sdk.api.put("/account/profile/",a,function(t){})}}),this.private_form.init(),this.kid_form=new formular("#add_kid",function(t){if("hitted"===t.status&&"submit"===t.action){var a={};$.each($("#add_kid form").serializeArray(),function(t,e){a[e.name]=e.value}),index.sdk.api.post("/me/members",a,function(t){window.location.reload()})}}).init(),this.security_form=new formular("#security_form",function(t){"hitted"===t.status&&"submit"===t.action&&index.sdk.api.put("/api/change_password/",{user_id:$("#security_form #user_id").val(),password:$("#security_form #change_password_old").val(),new_password:$("#security_form #change_password_new").val(),retype_new_password:$("#security_form #retype_change_password_new").val()},function(t){})}).init(),this.address_form=new formular("#address_form",function(t){if("validated"===t.status){$("#addressLine1").val(),$("#postalCode").val(),$("#city").val(),$("#addressCountry").val()}if("hitted"===t.status&&"submit"===t.action){var a=account.address_form.get_datas();"PUT"===$("#address_form form").attr("method")?index.sdk.api.put("/address/",a,function(t){}):index.sdk.api.post("/address/",a,function(t){window.location.reload()})}}),this.address_form.init(),this.services_form=new formular("#services_form",function(t){if("hitted"===t.status&&"submit"===t.action){var a=account.services_form.get_datas();index.sdk.api.put("/account/profile/",a,function(t){})}}),this.services_form.init(),$("#member_datas").length>0&&(this.member_form=new formular("#member_datas",function(t){if(void 0!==t.action)switch(t.action){case"save":var a={member_id:$("#member_datas").attr("data-memberid")};$.each($("#member_datas form").serializeArray(),function(t,e){a[e.name]=e.value}),index.sdk.api.put("/me/members",a,function(t){window.location.reload()})}}).init()),$(".delete_device").off("click").on("click",function(){var t=$(this);index.sdk.api.call("DELETE","/auth/device",{uid:$(this).attr("data-device_uid")},function(a){t.parent().parent().remove()})})},init_apple_pay:function(){document.getElementById("apple-pay-button").addEventListener("click",function(t){t.preventDefault();var a={requiredBillingContactFields:["postalAddress"],requiredShippingContactFields:["phone"],countryCode:"FR",currencyCode:"EUR",total:{label:"joyvox.fr",amount:"4.99"}};return Stripe.applePay.buildSession(a,function(t,a){a(!0)}).begin(),!1})}};