$(function(){setTimeout(function(){login.init()},1E3)});
var index={},login={form:null,init:function(){this.add_account();"undefined"!==typeof response&&("error"===response.status&&11==response.code?$("#email").parent().addClass("invalid"):"error"===response.status&&13==response.code&&($("#email").parent().addClass("valid"),$("#password").parent().addClass("invalid")));this.form=new formular("#auth_form",function(a){"tab_change"===a.status&&($("#error_display").remove(),window.history.pushState({pageTitle:a.value},document.title,window.location.origin+
"/auth/"+a.value.replace("_form","")),login.navigate(),$("#lost_form").css("display","none"));if("submit_form"===a.action){var b={};$.each(a.form.serializeArray(),function(c,a){b[a.name]=a.value});login.sdk.api[a.form.attr("method")](a.form.attr("action"),b,function(a){if(200!==a.status)switch(a.message){case "SUBSCRIBE_EMAIL_EXIST":$("#subscribe_email").parent().append('<div class="input_error">Cet email est d\u00e9j\u00e0 utilis\u00e9, veuillez vous connecter</div>')}"undefined"!==typeof a.idkids_user&&
("undefined"!==typeof referer&&-1===referer.indexOf("/auth")?window.location.href=referer+"?idkids-token="+a.idkids_user.datas.token+"&idkids-id="+a.idkids_user.datas._id+"&idkids-device="+a.idkids_user.datas.current_device+"&idkids-secret="+a.idkids_user.datas.secret:window.location.href="/account/account/?idkids-token="+a.idkids_user.datas.token+"&idkids-id="+a.idkids_user.datas._id+"&idkids-device="+a.idkids_user.datas.current_device+"&idkids-secret="+a.idkids_user.datas.secret)},function(a){"undefined"!==
typeof a.responseJSON&&"undefined"!==typeof a.responseJSON.message&&(0===$("#error_display").length&&$("#account_forms").append('<br/><div class="error" id="error_display"></div>'),$("#error_display").html(translation[a.responseJSON.message]),$(".formular.auth").css({height:$(".displayblock").height()+$(".app_infos").height()+140+"px"}))})}$(".formular.auth").css({height:$(".displayblock").height()+$(".app_infos").height()+140+"px"})});this.form.init();window.addEventListener("popstate",this.navigate);
this.set_listeners();this.navigate()},set_listeners:function(){$("[data-action]").off("click").on("click",function(a){a.preventDefault();a=$(this).attr("data-action");switch(a){case "page_reload":window.history.pushState({pageTitle:$(this).attr("title")},"",login.add_params($(this).attr("href")));login.navigate();break;case "receive_password":login.sdk.api.post("/auth/lost_password",{email:$("#lost_form #lost_email").val()},function(a){});break;default:console.log("default ",a)}})},add_account:function(){this.sdk=
new idkids_jssdk({secret:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzZWNyZXQiOiI1YTMwZGViZmYzNjViMzBhZmQ3ODY4OWMiLCJpYXQiOjE1MTMxNTgxODV9.8e9JhLtcpzf8hO2CguRuUINBpLWOOClx_-3GfFoVqcM",callback_url:window.location.origin+"/redirect/",authorisation:{email:!0}},function(a,b){console.log("this.sdk ::: ",a,b)});this.sdk.init($.proxy(function(a){this.sdk.isLogged($.proxy(function(a){"logged"===a.status&&this.sdk.api.get("/me",{},$.proxy(function(a){console.log("ME / ",a);0==$('[data-userid="'+a.datas._id+
'"]').length&&$(".account_list").prepend('<a href="/auth/login/email/'+a.datas.email+'" data-action="page_reload"><li data-userid="'+a.datas._id+'"><div class="avatar" style="background-image:url('+a.datas.avatar+')"></div><div class="option_infos"><div class="label">'+a.datas.pseudo+'</div><div class="email">'+a.datas.email+'</div><div class="status">connected</div></div></li></a>');this.set_listeners()},this))},this))},this));index.sdk=login.sdk},navigate:function(){var a=login.parse_url(window.location.pathname);
if("undefined"!==typeof a.auth)switch(a.auth){case "login":$("#account_selection").addClass("displaynone").removeClass("displayblock");$("#account_forms").removeClass("displaynone").addClass("displayblock");$("#login_form").css("display","block");$("#subscribe_form").css("display","none");$("#lost_form").css("display","none");$('[data-tab="login_form"]').addClass("selected");$('[data-tab="subscribe_form"]').removeClass("selected");$("#email").focus();login.form.checkInputs(!1);"undefined"!==typeof a.email?
$("#email").val(a.email):($("#email").val(""),$("#password").val(""));break;case "subscribe":$("#account_selection").addClass("displaynone").removeClass("displayblock");$("#account_forms").removeClass("displaynone").addClass("displayblock");$("#email").val("");$("#password").val("");$("#login_form").css("display","none");$("#subscribe_form").css("display","block");$("#lost_form").css("display","none");$('[data-tab="subscribe_form"]').addClass("selected");$('[data-tab="login_form"]').removeClass("selected");
$("#pseudo").focus();login.form.checkInputs(!1);break;case "lost":$("#account_selection").addClass("displaynone").removeClass("displayblock");$("#account_forms").removeClass("displaynone").addClass("displayblock");$("#email").val("");$("#password").val("");$("#login_form").css("display","none");$("#subscribe_form").css("display","none");$("#lost_form").css("display","block");$(".switch_tab .tab").removeClass("selected");$("#lost_email").focus();login.form.checkInputs(!1);break;default:$("#account_selection").removeClass("displaynone").addClass("displayblock"),
$("#account_forms").addClass("displaynone").removeClass("displayblock")}else $("#account_selection").removeClass("displaynone").addClass("displayblock"),$("#account_forms").addClass("displaynone").removeClass("displayblock");$(".formular.auth").css({height:$(".displayblock").height()+$(".app_infos").height()+140+"px"})},add_params:function(a){return a},parse_url:function(a){var b=[];a=a.split("/");for(var c=1;c<a.length;c+=2)b.push({}),b[a[c]]=a[c+1];return b},initFB:function(){FB.getLoginStatus(function(a){$("#facebook_login").addClass("enabled").off("click").on("click",
function(){login.loginFB()})})},loginFB:function(){FB.login(function(a){FB.api("/me?fields=email,name,friends,likes,picture",function(a){"undefined"!==typeof a.email?($("#email").val(a.email),login.sdk.api.get("/auth/login/facebook",{email:a.email,password:a.id,avatar:a.picture.url,fb_id:a.id,fb_friends:a.friends,fb_likes:a.likes},function(a){console.log(a)})):alert("impossible de vous connecter car Facebook refuse de fournir vos informations")})},{scope:"public_profile,user_friends,email,user_birthday",
return_scopes:!0})}};
