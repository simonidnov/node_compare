var $jscomp={scope:{},findInternal:function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,f=0;f<d;f++){var e=a[f];if(b.call(c,e,f,a))return{i:f,v:e}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var f=a[d];f in c||(c[f]={});c=c[f]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6-impl","es3");
var db=require("mongoose"),app=require("../app"),http=require("http"),sha1=require("sha1"),jwt=require("jsonwebtoken"),validator=require("email-validator"),Members_model=require("../models/members_model"),Address_model=require("../models/address_model"),Email_controller=require("../controllers/email_controller"),Settings_model=require("../models/settings_model"),config=require("../config/config"),gravatar=require("gravatar"),urlExists=require("url-exists"),user_datas={email:{type:"string",unique:!0},
password:{type:"string"},pseudo:{type:"string"},firstName:{type:"string"},avatar:{type:"string"},lastName:{type:"string"},phone:{type:"string"},mobile:{type:"string"},token:{type:"string"},validation_code:{type:"string"},secret:{type:"string"},qrcode:{type:"Object"},birthDate:{type:"Date"},gender:{type:"string","enum":["undefined","male","female"],defaults:"undefined"},address:{type:"Array"},friends:{type:"Array"},relations:{type:"Array"},apps:{type:"Array"},tags:{type:"Object"},authorized_apps:{type:"Object"},
facebook:{id:{type:"string"},name:{type:"string"},email:{type:"string"},likes:{type:"array"},friends:{type:"array"},pages:{type:"array"},shared:{type:"boolean"},accessToken:{type:"string"}},devices:{uid:"string",name:"string",arch:"string",appCodeName:"string",appName:"string",appVersion:"string",userAgent:"string",vendor:"string",last_connexion:"string",token:"string",ua_parser:{type:"Object"}},termAccept:{type:"Boolean"},newsletter:{type:"Boolean"},newsletter_services:{type:"Object"},sms:{type:"Boolean"},
sms_services:{type:"Object"},notifications:{type:"Boolean"},notifications_services:{type:"Object"},rights:{type:"Object"},validated:{type:"Boolean"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now},public_locale:{type:"Boolean"},public_profile:{type:"Boolean"},public_kids:{type:"Boolean"},public_created:{type:"Boolean"},public_gamification:{type:"Boolean"},public_interest:{type:"Boolean"},has_kids:{type:"Boolean"},has_girl:{type:"Boolean"},has_boy:{type:"Boolean"},
has_address:{type:"Boolean"},has_basket:{type:"Boolean"},has_orders:{type:"Boolean"}},machineId=require("node-machine-id"),ua_parser=require("ua-parser-js"),device_uid=machineId.machineIdSync({original:!0});0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});var userSchemas=new db.Schema(user_datas),User=db.model("User",userSchemas);db.connection.on("open",function(a){});db.connection.on("error",function(a){});User.collection.dropIndexes();module.exports={attributes:user_datas};
module.exports.getCount=function(){return User.find({}).count()};module.exports.getActive=function(){return User.find({updated:{$gte:new Date(ISODate().getTime()-2592E5)}}).count()};module.exports.get=function(a,b,c){device_uid=a.query.device_uid;var d=this;User.find({},function(a,b){a?c({status:304,code:a.code,error:a,message:a.message}):c({status:200,users:b,total:d.getCount()})}).skip(50*parseInt(b.page)).limit(50)};
module.exports.getUserInfos=function(a,b,c){"undefined"!==typeof a.query.user&&""!==a.query.user||c({status:304,datas:{message:"NEED_USER"}});User.find({_id:a.query.user._id},function(a,b){a?c({status:304,code:a.code,error:a,message:"NEED_USER"}):c({status:200,user:b})})};module.exports.deleteDevice=function(a,b,c){User.update({_id:b.user_id},{$pull:{devices:{uid:a.query.device_uid}}},function(a,b){errr?c({status:403,message:"DEVICE_DELETE_ERROR"}):c({status:200,message:"DEVICE_DELETE_SUCCESS"})})};
module.exports.login=function(a,b,c){"undefined"!==typeof a.query.remember_me&&("undefined"!==typeof a.query.device_infos?(device_uid=a.query.device_infos.device_uid,Date.now(),ua_parser(a.query.device_infos.userAgent)):"undefined"!==typeof a.query.device_uid&&(device_uid=a.query.device_uid,Date.now(),ua_parser(a.query.userAgent)));var d=this;b.password?validator.validate(b.email)?User.find({email:b.email,password:sha1(b.password)},function(f,e){if(f)c({status:"error",code:f.code,error:f,message:f.message});
else{if(0===e.length)return User.find({email:b.email},function(a,b){a?c({status:400,code:11,error:a,message:"USER_WRONG_EMAIL"}):0===b.length?c({status:400,code:11,error:a,message:"USER_WRONG_EMAIL",email_valid:b.length}):c({status:400,code:13,error:a,message:"USER_WRONG_PASSWORD",email_valid:b.length})}),!1;var g=jwt.sign({secret:e[0].secret,email:e[0].email,password:b.password},config.secrets.global.secret,{expiresIn:"2 days"}),h=e[0].avatar,h=""===e[0].avatar||null===e[0].avatar?""===b.avatar||
null===b.avatar||"undefined"===typeof b.avatar?gravatar.url(e[0].email,{protocol:"https",s:"100"}):b.avatar:e[0].avatar;urlExists(h,function(b,f){f||(h="undefined"!==typeof app.locals?app.locals.settings.host+"/public/images/assets/account.svg":"/public/images/assets/account.svg");User.update({_id:e[0]._id},{$set:{updated:Date.now(),avatar:h,token:g}},function(b,f){b?c({status:400,code:b.code,error:b,message:"USER_LOGIN_ERROR"}):d.reset_session(a,e[0]._id,function(a){a.avatar=a.avatar;c({status:200,
message:"USER_LOGIN_SUCCESS",idkids_user:a})})})})}}):c({status:400,message:"USER_WRONG_EMAIL"}):c({status:400,message:"USER_LOGIN_ERROR"});return b};module.exports.logout=function(a,b,c){"undefined"!==typeof a.session.Auth&&a.session.destroy();c({status:200,datas:{message:"SESSION_DELETED"}})};
module.exports.register=function(a,b){"undefined"!==typeof a.body.data&&(a.body=a.body.data);if("undefined"===typeof a.body||"undefined"===typeof a.body.subscribe_password)return b({status:"error",message:"NO_BODY"}),!1;var c=this;User.find({email:a.body.subscribe_email},function(d,f){if(d)b({status:400,code:11,error:d,message:"USER_WRONG_EMAIL"});else{if(0<f.length)return b({status:201,message:"SUBSCRIBE_EMAIL_EXIST",email_already_exist:f.length,response_display:{title:"Email",message:"Impossible de cr\u00e9er le compte car l'email que vous avez renseign\u00e9 existe d\u00e9j\u00e0."}}),
!1;var e="undefined"!==typeof app.locals&&"undefined"!==typeof app.locals.settings?app.locals.settings.host+"/public/images/assets/account.svg":"/public/images/assets/account.svg",g=sha1(a.body.subscribe_password);db.connect(config.database.users,{useMongoClient:!0});e={email:a.body.subscribe_email,password:g,pseudo:a.body.pseudo,avatar:e,secret:jwt.sign({pseudo:a.body.pseudo+"_"+a.body.subscribe_email},config.secrets.global.secret,{expiresIn:"2 days"}),termAccept:!0,rights:{type:"R",authorizations:["me"]}};
e.token=jwt.sign({secret:e.secret,email:a.body.subscribe_email,password:a.body.subscribe_password},config.secrets.global.secret,{expiresIn:"2 days"});e.device=[{uid:device_uid,token:e.token}];if(a.body.subscribe_newsletter){if(e.newsletter=!0,e.newsletter_services={},"undefined"!==typeof app.locals&&"undefined"!==typeof app.locals.applications)for(g=0;g<app.locals.applications.length;g++)a.body["newsletter_"+app.locals.applications[g].short_name]&&(e.newsletter_services[app.locals.applications[g].short_name]=
1)}else e.newsletter=!1,e.newsletter_services={};new_user=new User(e);new_user.save(function(d,e){d?b({status:203,message:"SUBSCRIBE_EMAIL_EXIST",err:d}):c.reset_session(a,e._id,function(a){b({status:200,user:e});Settings_model.get(null,{},function(a){c.getValidationCode(e._id,function(c){200===c.status&&Email_controller.send(null,{subject:"Bienvenue sur JOYVOX",title:"Inscription sur JOYVOX",message:'Votre inscription a bien \u00e9t\u00e9 prise en compte, rendez-vous sur <a href="'+a.host+"/validation/account/"+
e.email+"/"+c.validation_code+'">JOYVOX pour valider votre inscription.</a>',email:e.email,to:e.email},function(a){})})})})})}})};module.exports.getUserInfosFromOrderController=function(a,b){User.findOne({_id:a},function(a,d){a?b({status:403,datas:{message:a}}):b({status:200,user:d})})};
module.exports.lost_password=function(a,b,c){"unefined"!==typeof a.body.data&&(a.body=a.body.data);"unefined"===typeof a.body.email&&c({status:203,message:"UNKNOW_USER_EMAIL"});var d=this;User.findOne({email:a.body.email},function(b,e){b?c({status:403,datas:{message:b}}):null===e?c({status:403,message:"UNKNOW_USER_EMAIL"}):d.getValidationCode(e._id,function(b){200===b.status?Email_controller.lost_password(a,b,function(a){c({status:a.status,response_display:{message:"REQUEST_PASSWORD_MESSAGE",title:"REQUEST_PASSWORD_TITLE"},
message:"PASSWORD_SENDED"})}):c({status:b.status,datas:b})})})};module.exports.unregister=function(a,b,c){User.remove({_id:a.body.id},function(){c({status:200,message:"USER_DELETED",infos:a.body})});return a.body};
module.exports.update=function(a,b,c,d){device_uid=a.body.device_uid;var f=this;c.updated=Date.now();"undefined"!==typeof c.birthDate&&(c.birthDate=c.birthDate);User.update({_id:b},{$set:c},function(c,g){c?d({status:401,message:"CANT_UPDATE_TOKEN",datas:c}):f.reset_session(a,b,function(){d({status:200,message:"TOKEN_UPDATED",datas:g,response_display:{title:"Mis \u00e0 jour",message:"Votre profil vient d'\u00eatre mis \u00e0 jour."}})})},!0)};
module.exports.updatePassword=function(a,b,c){User.update({email:a.email},{$set:{password:sha1(a.password),updated:Date.now()}},function(a,b){a?c({status:401,message:"CANT_UPDATE_PASSWORD",error:a}):c({status:200,message:"PASSWORD_UPDATED",infos:b})})};module.exports.check_user_session=function(a,b){};
module.exports.check_user=function(a,b){jwt.verify(a.options.user_token,config.secrets.global.secret,function(c,d){if(c)b({status:203,message:"UNAUTHORISED_TOKEN",response_display:{title:"Connexion requise",message:"Vous devez-\u00eatre connect\u00e9 pour effectuer cette action."},datas:c});else{a.decoded=d;if("undefined"===typeof d.password||"undefined"===typeof d.email)return b({status:203,message:"UNAUTHORISED",response_display:{title:"Connexion requise",message:"Vous devez-\u00eatre connect\u00e9 pour effectuer cette action."}}),
!1;User.find({email:d.email,password:sha1(d.password)},function(c,e){if(c)b({status:203,message:"UNAUTHORISED_TOKEN",datas:c,response_display:{title:"Connexion requise",message:"Vous devez-\u00eatre connect\u00e9 pour effectuer cette action."}});else if(0===e.length)b({status:203,message:"UNAUTHORISED",response_display:{title:"Connexion requise",message:"Vous devez-\u00eatre connect\u00e9 pour effectuer cette action."}});else{var f=jwt.sign({secret:e[0].user_secret,email:e[0].email,password:d.password},
config.secrets.global.secret,{expiresIn:"2 days"});User.update({_id:e[0]._id},{$set:{updated:Date.now(),token:f}},function(c,d){c?b({status:401,message:"CANT_UPDATE_TOKEN",datas:c}):(a.updated_token=f,b({status:200,message:"TOKEN_UPDATED",datas:e,updated_token:f}))},!0)}})}})};
module.exports.checking_session=function(a,b,c){var d=this;User.findOne({_id:a.query._id,token:a.query.token,secret:a.query.secret},function(b,e){b?c({status:401,code:b.code,error:b,message:b.message}):d.reset_session(a,a.query._id,c)})};
module.exports.reset_session=function(a,b,c){User.findOne({_id:b},function(d,f){d?c({status:401,code:d.code,error:d,message:d.message}):null===f?c({status:203,message:"UNKNOW_USER",datas:f}):(user_infos=JSON.parse(JSON.stringify(f)),Members_model.get(b,null,function(d){user_infos.members=d.datas;Address_model.get(b,null,function(b){user_infos.address=b.datas;a.session.Auth=user_infos;c({status:200,message:"SESSION_UPDATED",datas:user_infos})})}))})};
module.exports.getPublicProfile=function(a,b){this.getFullUser(a,function(a){200===a.status?b({status:a.status,message:a.message,datas:{_id:a.datas._id,pseudo:a.datas.pseudo,email:a.datas.email,avatar:a.datas.avatar,created:a.datas.created,updated:a.datas.updated}}):b(a)})};module.exports.getServices=function(a,b){this.getFullUser(a,function(a){200===a.status?b({status:a.status,message:a.message,datas:a.datas.public_services}):b(a)})};
module.exports.getFullUser=function(a,b){User.findOne({_id:a},function(c,d){c?b({status:401,message:"UNAUTHORISED_TOKEN",datas:c}):null!==d?Members_model.get(a,null,function(a){d.members=a.datas;b({status:200,message:"success me",datas:d})}):b({status:404,message:"USER_NOT_FOUND",datas:d})})};
module.exports.getValidationCode=function(a,b){User.findOne({_id:a},function(a,d){if(a)b({status:401,message:"UNAUTHORISED_TOKEN",datas:a});else if(null!==d){var c=jwt.sign({secret:d.secret},config.secrets.global.secret,{expiresIn:"2 days"});User.update({_id:d._id},{$set:{validation_code:c}},function(a,f){a?console.log("impossible de mettre \u00e0 jour le code de validation ",a):b({status:200,validation_code:c,email:d.email,pseudo:d.pseudo,avatar:d.avatar})})}else b({status:304,message:"USER_NOT_FOUND",
datas:d})})};module.exports.validCode=function(a,b){User.findOne({email:a.email,validation_code:a.validation_code},function(a,d){a||null===d?b({status:304,message:"INVALID_CODE",datas:a}):b({status:200,message:"CODE_VALID",datas:d})})};
module.exports.validAccount=function(a,b,c){var d=this;jwt.verify(b.validation_code,config.secrets.global.secret,function(a,b){});User.findOne({email:b.email,validation_code:b.validation_code},function(b,e){b||null===e?c({status:304,message:"UNAUTHORISED_TOKEN",datas:b}):User.update({_id:e._id},{$set:{validated:!0,certified:!0}},function(b,f){b?c({status:204,message:"UNAUTHORISED_TOKEN",datas:b}):d.reset_session(a,e._id,function(a){c({status:200,message:"USER_VALIDATED",datas:f})})})})};
module.exports.getUsersDevice=function(a,b){User.find({devices:{$elemMatch:{uid:a}}},{email:1,avatar:1,pseudo:1},function(a,d){a||0===d.length?b({status:304,message:"NEW_DEVICE",datas:a}):b({status:200,message:"liste des utilisateurs ayant utilis\u00e9 ce device",users_device:d})})};
module.exports.deleteDevice=function(a,b){var c=this;User.update({_id:a.session.Auth._id},{$pull:{devices:{uid:a.body.uid}}},function(d,f){d||0===f.length?b({status:304,message:"DEVICE_DELETE_ERROR",datas:d}):c.reset_session(a,a.session.Auth._id,function(a){a.avatar=a.avatar;b({status:200,message:"DEVICE_DELETE_SUCCESS",idkids_user:a})})})};module.exports.getWithFilters=function(a,b,c){User.find(a.filters,function(a,b){a?c({status:401,code:a.code,error:a,message:a.message}):c({status:200,users:b})})};
module.exports.checkFilterDatas=function(a,b,c){var d=this;User.find({},function(b,e){if(b)c({status:401,code:b.code,error:b,message:b.message});else{for(var f=0;f<e.length;f++)d.checkMembers(e[f]._id),d.checkAddress(e[f]._id),d.checkBasket(a,e[f]._id),d.checkOrders(a,e[f]._id);c({status:200,message:"traitement en cours, les donn\u00e9es seront rafra\u00eechies prochainement"})}})};
module.exports.checkMembers=function(a){Members_model.get(a,null,function(b){var c={has_kids:!1,has_girl:!1,has_boy:!1};0<b.datas.length&&(c.has_kids=!0);for(var d=0;d<b.datas.length;d++)"male"===b.datas[d].gender?c.has_boy=!0:"female"===b.datas[d].gender&&(c.has_girl=!0);User.updateOne({user_id:a},{$set:c},function(a,b){})})};
module.exports.checkAddress=function(a){Address_model.get(a,null,function(b){var c={has_address:!1};0<b.datas.length&&(c.has_address=!0);User.updateOne({user_id:a},{$set:c},function(a,b){})})};module.exports.checkBasket=function(a,b){a.current_user={_id:b};require("../models/basket_model").getUserBasket(a,null,function(a){var c={has_basket:!1};0<a.datas.length&&0<a.datas[0].products.length&&(c.has_basket=!0);User.updateOne({user_id:b},{$set:c},function(a,b){})})};
module.exports.checkOrders=function(a,b){a.current_user={_id:b};require("../models/orders_model").getUserOrders(a,null,function(a){var c={has_orders:!1};0<a.datas.length&&(c.has_orders=!0);User.updateOne({user_id:b},{$set:c},function(a,b){})})};user_datas.getAge=function(){return this.birthDate};function checkAvatarExist(a){var b=require("http");b.request({},function(c){return 404!=b.status?a:app.locals.settings.host+"/public/images/assets/account.svg"}).end()};
