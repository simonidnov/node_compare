var $jscomp={scope:{},findInternal:function(b,a,c){b instanceof String&&(b=String(b));for(var d=b.length,e=0;e<d;e++){var f=b[e];if(a.call(c,f,e,b))return{i:e,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(b,a,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");b!=Array.prototype&&b!=Object.prototype&&(b[a]=c.value)};
$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(b,a,c,d){if(a){c=$jscomp.global;b=b.split(".");for(d=0;d<b.length-1;d++){var e=b[d];e in c||(c[e]={});c=c[e]}b=b[b.length-1];d=c[b];a=a(d);a!=d&&null!=a&&$jscomp.defineProperty(c,b,{configurable:!0,writable:!0,value:a})}};
$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6-impl","es3");
var db=require("mongoose"),config=require("../config/config"),cc=require("coupon-code"),coupons_datas={offer:{type:"string"},label:{type:"string"},description:{type:"string"},code:{type:"string"},amount:{type:"number"},parts:{type:"number","default":1},partLen:{type:"number","default":4},admin_id:{type:"string"},user_id:{type:"string"},already_used:{type:"bool","default":!1},is_valid:{type:"bool","default":!0},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}};
0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});var couponsSchemas=new db.Schema(coupons_datas),Coupon=db.model("Coupons",couponsSchemas);module.exports={attributes:coupons_datas};module.exports.get=function(b,a,c){a={};"undefined"!==typeof b.params.offer&&(a.offer=b.params.offer);"undefined"!==typeof b.query.code&&(a.code=b.query.code,a.is_valid=1,a.already_used=0);Coupon.find(a,function(a,b){a?c({status:405,datas:a}):c({status:200,datas:b})})};
module.exports.getOffers=function(b,a,c){Coupon.aggregate([{$group:{_id:"$offer",count:{$sum:1},already_used:{$sum:{$cond:["$already_used",1,0]}},is_valid:{$sum:{$cond:["$is_valid",1,0]}}}}],function(a,b){a?c({status:405,datas:a}):c({status:200,datas:b})})};
module.exports.getOffersCSV=function(b,a,c){if("undefined"===typeof b.params.offer)c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_NEED_OFFER_NAME",body_datas:b.params}});else var d={offer:b.params.offer};Coupon.find(d,function(a,b){a?c({status:405,datas:a}):c({status:200,datas:b})})};
module.exports.createOffer=function(b,a,c){a=b.body;"undefined"!==typeof a.data&&(a=b.body.data);"undefined"===typeof a.offer&&c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_NEED_OFFER_NAME",body_datas:a}});"undefined"===typeof a.label&&c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_NEED_LABEL"}});"undefined"===typeof a.description&&c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_NEED_DESCRIPTION"}});"undefined"===typeof a.quantity&&
c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_NEED_QUANTITY"}});"undefined"===typeof a.parts&&c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_PARTS"}});"undefined"===typeof a.partLen&&c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_PARTLEN"}});"undefined"===typeof a.amount&&c({status:405,response_display:{title:"COUPON_ERROR",message:"COUPON_AMOUNT"}});for(var d=0,e=0,f=0;f<a.quantity;f++){var g={offer:a.offer,label:a.label,description:a.description,
code:cc.generate({parts:a.parts,partLen:a.partLen}),amount:a.amount,admin_id:b.session.Auth._id,parts:a.parts,partLen:a.partLen,already_used:!1,is_valid:!0};new_coupon=new Coupon(g);new_coupon.save(function(a,b){a?d++:e++});f===a.quantity-1&&c({status:200,errors:d,success:e,total:e,percent:a.quantity/e*100,quantity:a.quantity,response_display:{title:"Coupons cr\u00e9\u00e9s",message:a.quantity+" Coupons viennent d'\u00eatre cr\u00e9\u00e9s | "+d+" erreurs d\u00e9tect\u00e9es"}})}};
module.exports.create=function(b,a,c){a=b.body;delete a.options;delete a._id;delete a.user;new_coupon=new Coupon(b.body);new_coupon.save(function(a,b){a?c({status:405,message:a}):c({status:200,datas:b})})};module.exports.update=function(b,a,c){b.body.updated=Date.now();Coupon.updateOne({_id:b.body.coupon_id},{$set:b.body},function(a,b){a?c({status:304,message:a}):c({status:200,datas:b})})};
module.exports.updateAmount=function(b,a,c){Coupon.updateMany({offer:"chansonspersonnalisees"},{$set:{amount:499}}).exec(function(a,b){c({status:200,datas:b})})};module.exports["delete"]=function(b,a,c){a={};"undefined"!==typeof b.body.offer&&(a.offer=b.body.offer);"undefined"!==typeof b.body.coupon_id&&(a._id=b.body.coupon_id);"undefined"!==typeof b.body.code&&(a.code=b.body.code);Coupon.deleteMany(a,function(a,b){a?c({status:405,message:a}):c({status:200,pages:b})})};
