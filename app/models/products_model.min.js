const db=require("mongoose"),config=require("../config/config"),products_datas={label:{type:"string",unique:!0},description:{type:"string"},keywords:{type:"string"},thumb:{type:"string"},picture:{type:"string"},details:{type:"string"},price:{type:"number"},devise:{type:"string",enum:["€","£","$"]},type:{type:"string",enum:["physical","demateralized"]},attributs:{type:"Object"},medias:{type:"Array"},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now}},fs=require("fs");0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const productsSchemas=new db.Schema(products_datas),Products=db.model("Products",productsSchemas);module.exports={attributes:products_datas},module.exports.get=function(e,t,s){Products.find(t,function(e,t){s(e?{status:304,datas:{title:"PRODUCT_GET_ERROR",message:"PRODUCT_GET_ERROR_MESSAGE",media:"PRODUCT_GET_ERROR_MEDIA",code:e.code,errmsg:e.errmsg}}:{status:200,datas:t})})},module.exports.create=function(e,t,s){delete t.options,delete t.device_infos,new_product=new Products(t),new_product.save(function(e,t){s(e?{status:304,datas:{title:"PRODUCT_CREATED_ERROR",message:"PRODUCT_CREATED_ERROR_MESSAGE",media:"PRODUCT_CREATED_ERROR_MEDIA",code:e.code,errmsg:e.errmsg}}:{status:200,datas:{infos:t,title:"PRODUCT_CREATED",message:"PRODUCT_CREATED_MESSAGE",media:"PRODUCT_CREATED_MEDIA"}})})},module.exports.update=function(e,t,s,a){delete s.options,delete s._id,s.updated=Date.now(),Products.updateOne({_id:t},{$set:s},function(e,t){a(e?{status:304,datas:{title:"PRODUCT_UPDATED_ERROR",message:"PRODUCT_UPDATED_ERROR_MESSAGE",media:"PRODUCT_UPDATED_ERROR_MEDIA",code:e.code,errmsg:e.errmsg}}:{status:200,datas:{infos:t,title:"PRODUCT_UPDATED",message:"PRODUCT_UPDATED_MESSAGE",media:"PRODUCT_UPDATED_MEDIA"}})})},module.exports.addFile=function(e,t,s){Products.updateOne({_id:e},{$push:{medias:{fieldname:t.filedname,originalname:t.originalname,encoding:t.encoding,mimetype:t.mimetype,destination:t.destination,filename:t.filename,path:t.path,size:t.size}}},function(e,t){s(e?{status:403,datas:{title:"PRODUCT_UPDATED_ERROR",message:"PRODUCT_UPDATED_ERROR_MESSAGE",media:"PRODUCT_UPDATED_ERROR_MEDIA",code:e.code,errmsg:e.errmsg}}:{status:200,datas:{infos:t,title:"PRODUCT_UPDATED",message:"PRODUCT_UPDATED_MESSAGE",media:"PRODUCT_UPDATED_MEDIA"}})})},module.exports.removeFile=function(e,t,s){fs.unlink("./uploads/"+t,function(){}),this.get(null,{_id:e},function(a){if(200===a.status){for(var d=[],i=0;i<a.datas[0].medias.length;i++)void 0!==a.datas[0].medias[i]&&void 0!==a.datas[0].medias[i][0]&&null!==a.datas[0].medias[i][0]&&a.datas[0].medias[i][0].filename!==t&&d.push(a.datas[0].medias[i]);Products.updateOne({_id:e},{medias:d},function(e,t){s(e?{status:403,datas:{title:"PRODUCT_UPDATED_ERROR",message:"PRODUCT_UPDATED_ERROR_MESSAGE",media:"PRODUCT_UPDATED_ERROR_MEDIA",code:e.code,errmsg:e.errmsg}}:{status:200,datas:{infos:t,title:"MEDIA_DELETED",message:"MEDIA_DELETED",media:"MEDIA_DELETED"}})})}else s({status:403,datas:{title:"PRODUCT_UPDATED_ERROR",message:"PRODUCT_UPDATED_ERROR_MESSAGE",media:"PRODUCT_UPDATED_ERROR_MEDIA",code:err.code,errmsg:err.errmsg}})})},module.exports.deleting=function(e,t,s){Products.deleteOne({_id:t},function(e,t){s(e?{status:304,datas:{title:"PRODUCT_DELETED_ERROR",message:"PRODUCT_DELETED_ERROR_MESSAGE",media:"PRODUCT_DELETED_ERROR_MEDIA",code:e.code,errmsg:e.errmsg}}:{status:200,datas:{infos:t,title:"PRODUCT_DELETED",message:"PRODUCT_DELETED_MESSAGE",media:"PRODUCT_DELETED_MEDIA"}})})};