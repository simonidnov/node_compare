const db=require("mongoose"),config=require("../config/config"),address_datas={user_id:{type:"string"},label:{type:"string"},first_name:{type:"string"},last_name:{type:"string"},AddressLine1:{type:"string"},AddressLine2:{type:"string"},AddressLine3:{type:"string"},city:{type:"string"},country:{type:"string"},country_code:{type:"string"},cp:{type:"string"},cp_id:{type:"string"},phone:{type:"string"},uniq_encoder:{type:"string"},geocoder:{latitude:{type:"string"},longitude:{type:"string"},country:{type:"string"},countryCode:{type:"string"},city:{type:"string"},zipcode:{type:"string"},streetName:{type:"string"},streetNumber:{type:"string"},administrativeLevels:{level1long:{type:"string"},level1short:{type:"string"},level2long:{type:"string"},level2short:{type:"string"}},provider:{type:"string"}},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now}},NodeGeocoder=require("node-geocoder"),options={provider:"google",httpAdapter:"https",apiKey:config.google.map,formatter:null},geocoder=NodeGeocoder(options);0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const addressSchemas=new db.Schema(address_datas),Address=db.model("Address",addressSchemas);module.exports={attributes:address_datas},module.exports.get=function(e,t,s){var d={};null!==e&&(d.user_id=e),null!==t&&(d.address_id=t),Address.find(d,function(e,t){s(e?{status:405,datas:e}:{status:200,datas:t})})},module.exports.create=function(e,t,s){t.user_id=e,geocoder.geocode(t.AddressLine1+" "+t.AddressLine2+" "+t.AddressLine3+" "+t.cp+" "+t.city+" "+t.country).then(function(e){t.geocoder=e[0],new_address=new Address(t),new_address.save(function(e,t){s(e?{status:405,message:e}:{status:200,datas:t})})}).catch(function(e){console.log("google map error ",e),new_address=new Address(t),new_address.save(function(e,t){s(e?{status:405,message:e}:{status:200,datas:t})})})},module.exports.update=function(e,t,s,d){Address.updateOne({user_id:e,_id:t},{$set:s},function(e,t){d(e?{status:405,message:e}:{status:200,user:t})})},module.exports.delete=function(e,t,s){Address.deleteOne({user_id:e,_id:t},function(e,t){s(e?{status:405,message:e}:{status:200,user:t})})};