var express=require("express"),_=require("underscore"),config=require("../config/config"),account=express.Router(),Auth_model=require("../models/auth_model"),Auth_helper=require("../helpers/auth_helper"),Basket_controller=require("../controllers/basket_controller"),Userproducts_controller=require("../controllers/userproducts_controller"),Order_controller=require("../controllers/orders_controller"),language_helper=require("../helpers/languages_helper"),uri_helper=require("../helpers/uri_helper"),lang=require("../public/languages/auth_lang"),Fb=require("fb"),keyPublishable="",keySecret="",keyPublishable="",keySecret="";account.use(function(e,s,t){s.setHeader("Access-Control-Allow-Origin","*"),s.setHeader("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),s.setHeader("Access-Control-Allow-Methods","GET, PUT, POST, DELETE"),app.locals.settings.StripeMode?(keyPublishable=app.locals.settings.StripekeyPublishable,keySecret=app.locals.settings.StripekeySecret):(keyPublishable=app.locals.settings.StripekeyPublishableTest,keySecret=app.locals.settings.StripekeySecretTest);e.query;"PUT"!==e.method&&"POST"!==e.method&&"DELETE"!==e.method&&"OPTIONS"!==e.method||e.body,app.locals.settings.StripeMode?(keyPublishable=app.locals.settings.StripekeyPublishable,keySecret=app.locals.settings.StripekeySecret):(keyPublishable=app.locals.settings.StripekeyPublishableTest,keySecret=app.locals.settings.StripekeySecretTest),stripe=require("stripe")(keySecret),Auth_helper.validate_session(e,function(e){200===e.status?t():s.redirect(307,"/checking_session")})}),account.get("/",function(e,s,t){s.redirect(307,"/account/account"+e.url.replace("/",""))}).post("/",function(e,s,t){s.redirect(307,"/account/account"+e.url.replace("/",""))}).get("/:page",function(e,s,t){Basket_controller.get(e,s,function(e){baskets=e.datas,t()})},function(e,s,t){Order_controller.get(e,s,function(e){200===e.status?(orders=e.datas,t()):t()})},function(e,s,t){Userproducts_controller.get(e,s,function(e){userproducts=e.datas,t()})},function(e,s,t){s.render("account",{title:"User Account",profile_percent:getPercent(e.session.Auth),profile_needs:getNeeds(e.session.Auth),user:e.session.Auth,locale:language_helper.getlocale(e),lang:lang,page:e.params.page,basket:baskets,orders:"undefined"!=typeof orders?orders:"",userproducts:"undefined"!=typeof userproducts?userproducts:"",keyPublishable:keyPublishable,_:_,js:["/public/javascripts/account.js","/node_modules/cropperjs/dist/cropper.min.js","/public/javascripts/components/formular.js","/public/javascripts/components/popeye.js","/node_modules/qrcode/build/qrcode.min.js","https://maps.googleapis.com/maps/api/js?key="+config.google.map],css:["/public/stylesheets/account.css","/public/stylesheets/ui.css","/node_modules/cropperjs/dist/cropper.min.css","/public/stylesheets/components/formular.css","/public/stylesheets/components/popeye.css"]}),s.end()}).get("/member/:member_id",function(e,s,t){Basket_controller.get(e,s,function(e){baskets=e.datas,t()})},function(e,s,t){Order_controller.get(e,s,function(e){orders=e.datas,t()})},function(e,s,t){s.render("account",{title:"User Account",profile_percent:getPercent(e.session.Auth),profile_needs:getNeeds(e.session.Auth),user:e.session.Auth,locale:language_helper.getlocale(e),lang:lang,page:"member",basket:baskets,keyPublishable:keyPublishable,member_infos:_.where(e.session.Auth.members,{_id:e.params.member_id})[0],_:_,js:["/public/javascripts/account.js","/node_modules/cropperjs/dist/cropper.min.js","/public/javascripts/components/formular.js","/node_modules/qrcode/build/qrcode.min.js","https://maps.googleapis.com/maps/api/js?key="+config.google.map],css:["/public/stylesheets/account.css","/public/stylesheets/ui.css","/node_modules/cropperjs/dist/cropper.min.css","/public/stylesheets/components/formular.css"]}),s.end()}).get("/addresses/:address_id",function(e,s,t){Basket_controller.get(e,s,function(e){baskets=e.datas,t()})},function(e,s,t){Order_controller.get(e,s,function(e){orders=e.datas,t()})},function(e,s,t){s.render("account",{title:"Edit address",profile_percent:getPercent(e.session.Auth),profile_needs:getNeeds(e.session.Auth),user:e.session.Auth,locale:language_helper.getlocale(e),lang:lang,page:"addresses",basket:baskets,keyPublishable:keyPublishable,address_infos:_.where(e.session.Auth.address,{_id:e.params.address_id})[0],_:_,js:["/public/javascripts/account.js","/node_modules/cropperjs/dist/cropper.min.js","/public/javascripts/components/formular.js","/node_modules/qrcode/build/qrcode.min.js","https://maps.googleapis.com/maps/api/js?key="+config.google.map],css:["/public/stylesheets/account.css","/public/stylesheets/ui.css","/node_modules/cropperjs/dist/cropper.min.css","/public/stylesheets/components/formular.css"]}),s.end()}).post("/profile",function(e,s,t){Auth_model.update(e,e.session.Auth._id,e.body,function(t){200===t.status?(s.redirect(200,t),s.end()):(s.redirect(307,"/account/"+e.url.replace("/","")+"?error_message="+t.message),s.end())})}).put("/profile",function(e,s,t){Auth_model.update(e,e.session.Auth._id,e.body,function(t){200===t.status?(s.status(t.status).send(t),s.end()):(s.status(t.status).send("/account/"+e.url.replace("/","")+"?error_message="+t.message),s.end())})});var getPercent=function(e){var s=20;return e.address.length>0&&(s+=10),e.members.length>0&&(s+=10),e.termAccept&&(s+=10),e.validated&&(s+=10),void 0!==e.gender&&(s+=10),void 0!==e.firstName&&(s+=10),void 0!==e.lastName&&(s+=10),void 0!==e.birthDate&&(s+=10),s},getNeeds=function(e){return[{title:"Validation",message:"Valider votre email"}]};module.exports=account;