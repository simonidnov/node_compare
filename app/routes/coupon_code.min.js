var express=require("express"),coupon_code=express.Router(),Json2csvParser=require("json2csv").Parser,fs=require("fs"),Auth_helper=require("../helpers/auth_helper"),Coupon_controller=require("../controllers/coupon_controller"),auth_helper=require("../helpers/auth_helper"),language_helper=require("../helpers/languages_helper"),uri_helper=require("../helpers/uri_helper"),lang=require("../public/languages/auth_lang");coupon_code.use(function(e,t,o){t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),t.setHeader("Access-Control-Allow-Methods","GET, PUT, POST, DELETE"),t.setHeader("Content-Type","application/json"),o()}),coupon_code.get("/",function(e,t,o){Auth_helper.validate_admin(e,function(e){200===e.status?o():t.redirect(301,"/auth?message=NO_ACCESS_RIGHTS_COUPONS")})},function(e,t,o){Coupon_controller.get(e,t,function(e){t.status(e.status).send(e),t.end()})}),coupon_code.get("/download/:offer",function(e,t,o){Auth_helper.validate_admin(e,function(e){200===e.status?o():t.status(403).send({title:"UNAUTHORIZED",message:"NO_ACCESS_RIGHTS_COUPONS"})})},function(e,t,o){Coupon_controller.getOffersCSV(e,t,function(e){var o=["code","offer","amount"],n=new Json2csvParser({fields:o}),s=n.parse(e.datas);console.log("CSV ::::::::::: ",s);var r="./uploads/file"+Date.now()+".csv";fs.writeFile(r,s,function(o,n){o?t.status(200).send(o):(t.redirect(301,r.replace("./","/")),t.status(200).send({csv:s,datas:e.datas}),t.end())})})}),coupon_code.get("/offers",function(e,t,o){Auth_helper.validate_admin(e,function(e){200===e.status?o():t.redirect(301,"/auth?message=NO_ACCESS_RIGHTS_COUPONS")})},function(e,t,o){Coupon_controller.getOffers(e,t,function(e){t.status(e.status).send(e),t.end()})}),coupon_code.post("/",function(e,t,o){t.status(200).send({message:"OUTCH PADAWAN ! YOU CANNOT CREATE ANY COUPON"}),t.end()}),coupon_code.post("/create_offer",function(e,t,o){Auth_helper.validate_admin(e,function(e){200===e.status?o():t.redirect(301,"/auth?message=NO_ACCESS_RIGHTS_COUPONS")})},function(e,t,o){Coupon_controller.createOffer(e,t,function(e){t.status(e.status).send(e),t.end()})}),coupon_code.put("/",function(e,t,o){Coupon_controller.update(e,t,function(e){t.status(e.status).send(e),t.end()})}),coupon_code.delete("/",function(e,t,o){Auth_helper.validate_admin(e,function(e){200===e.status?o():t.redirect(301,"/auth?message=NO_ACCESS_RIGHTS_COUPONS")})},function(e,t,o){Coupon_controller.delete(e,t,function(e){t.status(e.status).send(e),t.end()})}),module.exports=coupon_code;