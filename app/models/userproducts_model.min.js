var $jscomp={scope:{},findInternal:function(a,d,c){a instanceof String&&(a=String(a));for(var b=a.length,e=0;e<b;e++){var g=a[e];if(d.call(c,g,e,a))return{i:e,v:g}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,d,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[d]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,d,c,b){if(d){c=$jscomp.global;a=a.split(".");for(b=0;b<a.length-1;b++){var e=a[b];e in c||(c[e]={});c=c[e]}a=a[a.length-1];b=c[a];d=d(b);d!=b&&null!=d&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:d})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6-impl","es3");
var db=require("mongoose"),config=require("../config/config"),Orders_model=require("../models/orders_model"),Products_model=require("../models/products_model"),userproducts_datas={user_id:{type:"string"},product_id:{type:"string"},meta_datas:{type:"Object"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}},usershare_datas={user_id:{type:"string"},product_id:{type:"string"},share_name:{type:"string"},share_email:{type:"string"},share_message:{type:"string"},share_link:{type:"string"},
share_date:{type:"Date"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});var userproductsSchemas=new db.Schema(userproducts_datas),Userproducts=db.model("Userproducts",userproductsSchemas),usershareSchemas=new db.Schema(usershare_datas),Usershares=db.model("Usershares",usershareSchemas);module.exports={attributes:userproducts_datas};
module.exports.get=function(a,d,c){var b={};"undefined"!==typeof a.session.Auth?b={user_id:a.session.Auth._id}:"undefined"!==typeof a.query.user_id?b={user_id:datas.user_id}:"undefined"!==typeof a.query.options&&(b={user_id:a.query.options.user_id});if("undefined"===typeof b.user_id)return c({status:401,datas:{message:"UNAUTHORISED_NEED_USER"}}),!1;a.user_id=b.user_id;this.checkOrders(a,d,function(a){Userproducts.find(b,function(a,b){a?c({status:405,datas:a}):c({status:200,datas:b});return!1}).sort({created:-1})})};
module.exports.allreadyBuy=function(a,d,c){Userproducts.findOne({user_id:a,product_id:d},function(a,e){a?c({status:404,message:"NEVER_BUY"}):null===e?c({status:404,message:"NEVER_BUY",datas:e}):c({status:200,message:"ALREADY_BUY",datas:e})})};
module.exports.checkOrders=function(a,d,c){var b=this;Orders_model.get(a,d,function(c){if(200===c.status)for(var e=0;e<c.datas.length;e++)for(var f=0;f<c.datas[e].basketdatas.products.length;f++)b.create({user_id:a.user_id,product_id:c.datas[e].basketdatas.products[f].product_id},d,function(a){})});c({status:200,message:"CHECKING"})};
module.exports.create=function(a,d,c){Userproducts.find({user_id:a.user_id,product_id:a.product_id},function(b,e){b||0===e.length?Products_model.get({product_id:a.product_id},d,function(b){new_userproduct=new Userproducts({user_id:a.user_id,product_id:a.product_id,meta_datas:b.datas[0]});new_userproduct.save(function(a,b){a?c({status:405,message:a}):c({status:200,datas:b})})}):c({status:201,datas:e,message:"ALREADY_ADDED_PRODUCT_ON_USER"})})};
module.exports.share=function(a,d,c){var b=a.body.data;Userproducts.find({user_id:b.options.user_id,product_id:b.product_id},function(e,g){if(e)c({status:200,message:"ERROR_PRODUCT_GET",response_display:{title:"Erreur de partage",message:"Il semble que vous n'ayez pas achet\u00e9 le produit que vous souhaitez partager."}});else if(0===g.length)c({status:200,message:"UNKNOW_USER_PRODUCT",response_display:{title:"Erreur de Partage",message:"Il semble que vous n'ayez pas achet\u00e9 le produit que vous souhaitez partager."}});
else{var f=require("../controllers/email_controller"),l=require("../controllers/auth_controller");a.query.user={_id:b.options.user_id};l.getUserInfos(a,d,function(e){if(200===e.status){var d=e.user[0];new_shareproduct=new Usershares({user_id:e.user[0]._id,product_id:b.product_id,share_name:b.share_name,share_email:b.share_email,share_message:b.share_message,share_link:b.share_link,share_date:b.share_date});new_shareproduct.save(function(g,h){if(g)c({status:200,datas:e.datas,response_display:{title:"Erreur de Partage",
message:"Une erreur est survenue lors du partage de votre chanson personnalis\u00e9e, nous vous conseillons de la t\u00e9l\u00e9charger et de l'envoyer manuellement.<br>Il est possible que nous n'arrivions pas \u00e0 joindre la boite mail de votre ami(e)."}});else if("true"===b.share_later){var k=(new Date(b.share_date)).toLocaleDateString("fr-FR",{month:"long",day:"numeric"});f.send(null,{subject:"L'envoie de la chanson d'anniversaire personnalis\u00e9e pour "+b.share_name+" \u00e0 bien \u00e9t\u00e9 configur\u00e9",
title:"L'envoie de votre chanson d'anniversaire \u00e0 bien \u00e9t\u00e9 configur\u00e9",message:"Bonjour "+d.pseudo+"<br>Vous avez configur\u00e9 l'envoie d'une chanson d'anniversaire pour votre ami(e) "+b.share_name+" pour le "+k+".<br>Cet email confirme que l'email sera envoy\u00e9 \u00e0 9h00 ce jour pr\u00e9cis sur l'adresse email de votre ami(e) : "+b.share_email+"<br>Voici votre message personnalis\u00e9 qui accompagnera la chanson :<br>"+b.share_message,email:"contact@joyvox.fr",share_id:h._id,
to:d.email},function(a){c({status:200,datas:a.datas,response_display:{title:"Partager",message:"Le partage de la chanson d'anniversaire pour "+b.share_name+" a bien \u00e9t\u00e9 configur\u00e9e, elle sera envoy\u00e9 \u00e0 votre ami(e) sur son email "+b.share_email+" le "+k+" !"}})})}else f.sendMaChansonEcard(a,{subject:"Bonjour"+b.share_name+", "+d.pseudo+" vous souhaites un joyeux anniversaire en chanson",title:"Bonjour"+b.share_name+", "+d.pseudo+" vous souhaites un joyeux anniversaire en chanson",
default_message:"Bonjour "+b.share_name+",<br>votre ami(e) "+d.pseudo+" vous souhaites un joyeux anniversaire en chanson !",message:b.share_message,product_id:b.product_id,share_id:h._id,email:d.email,to:b.share_email},function(a){200===a.status?f.send(null,{subject:"La chanson d'anniversaire personnalis\u00e9e pour "+b.share_name+" \u00e0 bien \u00e9t\u00e9 envoy\u00e9e",title:"La chanson d'anniversaire personnalis\u00e9e pour "+b.share_name+" \u00e0 bien \u00e9t\u00e9 envoy\u00e9e",message:"Bonjour "+
d.pseudo+"<br>Vous avez envoy\u00e9 une chanson d'anniversaire pour votre ami(e) "+b.share_name+".<br>Cet email confirme l'envoie de votre chanson sur l'adresse email de votre ami(e) : "+b.share_email+"<br>Voici votre message personnalis\u00e9 qui accompagnera la chanson :<br>"+b.share_message,email:"contact@joyvox.fr",share_id:h._id,to:d.email},function(a){c({status:200,datas:a.datas,response_display:{title:"Partager ma chanson",message:"La chanson a bien \u00e9t\u00e9 envoy\u00e9e \u00e0 "+b.share_name+
" sur son adresse email "+b.share_email+" !"}})}):c({status:203,datas:a.datas,response_display:{title:"Erreur de Partage",message:"Nous n'avons pas r\u00e9ussi \u00e0 envoyer la chanson \u00e0 votre ami(e)."}})})})}else c({status:203,datas:e.datas,response_display:{title:"Erreur de Partage",message:"Nous n'avons pas r\u00e9ussi \u00e0 vous authentifier pour cr\u00e9er l'envoie de votre chanson."}})})}})};
