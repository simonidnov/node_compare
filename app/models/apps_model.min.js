const db=require("mongoose"),config=require("../config/config"),jwt=require("jsonwebtoken"),apps_datas={icon:{type:"string"},logo:{type:"string"},splash:{type:"string"},color:{type:"string"},label:{type:"string"},name:{type:"string",unique:!0},short_name:{type:"string"},bundle:{type:"string",unique:!0},description:{type:"string"},short_desc:{type:"string"},host:{type:"string"},aliases:{type:"Object"},redirect_url:{type:"string"},tags:{type:[]},secret:{type:"string"},token:{type:"string"},is_widget:{type:"bool"},has_newsletter:{type:"bool"},has_sms:{type:"bool"},has_notifications:{type:"bool"},order:{type:"Number"},authorizations:{user_public:{type:"bool"},user_private:{type:"bool"}},certificats:{apple:{type:"string"},android:{type:"string"},osx:{type:"string"},windows:{type:"string"}},terms_url:{type:"String"},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const appsSchemas=new db.Schema(apps_datas),Apps=db.model("Apps",appsSchemas);module.exports={attributes:apps_datas},module.exports.validate=function(t,e,s){Apps.find({secret:t},function(t,e){s(t?{status:405,datas:t}:{status:200,datas:e})})},module.exports.get=function(t,e,s){var e=e;Apps.find(e,function(t,a){t?s({status:405,datas:t}):(void 0!==e&&null!==e&&0!==Object.keys(e).length||(app.locals.applications=a),s({status:200,datas:a}))}).sort({order:1})},module.exports.create=function(t,e,s){var a=this;console.log("create app datas ",e),e.secret=jwt.sign({secret:t},config.secrets.global.secret),e.token=jwt.sign({secret:t+Date.now()},config.secrets.global.secret),new_apps=new Apps(e),new_apps.save(function(t,e){t?s({status:405,message:t}):(a.get(null,{},function(t){}),s({status:200,datas:e}))})},module.exports.update=function(t,e,s,a){delete s.options,delete s._id;var n=this;s.updated=Date.now(),Apps.updateOne({_id:e},{$set:s},function(t,e){t?a({status:405,message:t}):(n.get(null,{},function(t){app.locals.applications=t.datas}),a({status:200,apps:e}))})},module.exports.delete=function(t,e,s){Apps.deleteOne({_id:e},function(t,e){s(t?{status:405,message:t}:{status:200,apps:e})})};