var express=require("express"),_=require("underscore"),config=require("../config/config"),account=express.Router(),Auth_model=require("../models/auth_model"),Auth_helper=require("../helpers/auth_helper"),language_helper=require("../helpers/languages_helper"),uri_helper=require("../helpers/uri_helper"),lang=require("../public/languages/auth_lang"),Fb=require("fb");account.use(function(c,a,b){a.setHeader("Access-Control-Allow-Origin","*");a.setHeader("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept");a.setHeader("Access-Control-Allow-Methods","GET, PUT, POST, DELETE");Auth_helper.validate_session(c,function(d){if(d.status===200){b()}else{a.redirect(301,"/auth")}})});account.get("/",function(c,a,b){a.redirect(307,"/account/profile"+c.url.replace("/",""))}).get("/:page",function(c,a,b){a.render("account",{title:"User Account",user:c.session.Auth,locale:language_helper.getlocale(),lang:lang,page:c.params.page,js:["/public/javascripts/account.js","/node_modules/cropperjs/dist/cropper.min.js","/public/javascripts/components/formular.js","/node_modules/qrcode/build/qrcode.min.js","https://maps.googleapis.com/maps/api/js?key="+config.google.map],css:["/public/stylesheets/account.css","/public/stylesheets/ui.css","/node_modules/cropperjs/dist/cropper.min.css","/public/stylesheets/components/formular.css"]})}).get("/member/:member_id",function(c,a,b){a.render("account",{title:"User Account",user:c.session.Auth,locale:language_helper.getlocale(),lang:lang,page:"member",member_infos:_.where(c.session.Auth.members,{_id:c.params.member_id})[0],js:["/public/javascripts/account.js","/node_modules/cropperjs/dist/cropper.min.js","/public/javascripts/components/formular.js","/node_modules/qrcode/build/qrcode.min.js","https://maps.googleapis.com/maps/api/js?key="+config.google.map],css:["/public/stylesheets/account.css","/public/stylesheets/ui.css","/node_modules/cropperjs/dist/cropper.min.css","/public/stylesheets/components/formular.css"]})}).get("/addresses/:address_id",function(c,a,b){a.render("account",{title:"Edit address",user:c.session.Auth,locale:language_helper.getlocale(),lang:lang,page:"addresses",address_infos:_.where(c.session.Auth.address,{_id:c.params.address_id})[0],js:["/public/javascripts/account.js","/node_modules/cropperjs/dist/cropper.min.js","/public/javascripts/components/formular.js","/node_modules/qrcode/build/qrcode.min.js","https://maps.googleapis.com/maps/api/js?key="+config.google.map],css:["/public/stylesheets/account.css","/public/stylesheets/ui.css","/node_modules/cropperjs/dist/cropper.min.css","/public/stylesheets/components/formular.css"]})}).post("/profile",function(c,a,b){Auth_model.update(c,c.session.Auth._id,c.body,function(d){if(d.status===200){a.redirect(301,"/account/"+c.url.replace("/",""))}else{a.redirect(307,"/account/"+c.url.replace("/","")+"?error_message="+d.message)}})}).put("/profile",function(c,a,b){Auth_model.update(c,c.session.Auth._id,c.body,function(d){if(d.status===200){a.send(d.status,"/account/"+c.url.replace("/",""))}else{a.send(d.status,"/account/"+c.url.replace("/","")+"?error_message="+d.message)}})});module.exports=account;