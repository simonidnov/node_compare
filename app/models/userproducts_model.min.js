const db=require("mongoose"),config=require("../config/config"),Orders_model=require("../models/orders_model"),Products_model=require("../models/products_model"),userproducts_datas={user_id:{type:"string"},product_id:{type:"string"},meta_datas:{type:"Object"},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now}},usershare_datas={user_id:{type:"string"},product_id:{type:"string"},share_name:{type:"string"},share_email:{type:"string"},share_message:{type:"string"},share_link:{type:"string"},share_later:{type:"boolean",default:!1},share_date:{type:"Date"},share_sent:{type:"boolean",default:!1},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const userproductsSchemas=new db.Schema(userproducts_datas),Userproducts=db.model("Userproducts",userproductsSchemas),usershareSchemas=new db.Schema(usershare_datas),Usershares=db.model("Usershares",usershareSchemas);module.exports={attributes:userproducts_datas},module.exports.get=function(e,s,a){var r={},t=this;if(void 0!==e.session.Auth?r={user_id:e.session.Auth._id}:void 0!==e.query.user_id?r={user_id:datas.user_id}:void 0!==e.query.options&&(r={user_id:e.query.options.user_id}),void 0===r.user_id)return a({status:401,datas:{message:"UNAUTHORISED_NEED_USER"}}),!1;void 0!==e.query.product_id&&(r.product_id=e.query.product_id),e.user_id=r.user_id,t.checkOrders(e,s,function(e){Userproducts.find(r,function(e,s){return e?(a({status:405,datas:e}),!1):(a({status:200,datas:s}),!1)}).sort({created:-1})})},module.exports.allreadyBuy=function(e,s,a){Userproducts.findOne({user_id:e,product_id:s},function(e,s){a(e?{status:404,message:"NEVER_BUY"}:null===s?{status:404,message:"NEVER_BUY",datas:s}:{status:200,message:"ALREADY_BUY",datas:s})})},module.exports.checkOrders=function(e,s,a){var r=this;Orders_model.get(e,s,function(a){if(200===a.status)for(var t=0;t<a.datas.length;t++)if(void 0!==a.datas[t].basketdatas)for(var n=0;n<a.datas[t].basketdatas.products.length;n++)void 0!==a.datas[t].refund?"charge_already_refunded"!==a.datas[t].refund.code&&"succeeded"!=typeof a.datas[t].refund.status||r.remove({user_id:e.user_id,product_id:a.datas[t].basketdatas.products[n].product_id},s,function(e){}):r.create({user_id:e.user_id,product_id:a.datas[t].basketdatas.products[n].product_id},s,function(e){})}),a({status:200,message:"CHECKING"})},module.exports.create=function(e,s,a){Userproducts.find({user_id:e.user_id,product_id:e.product_id},function(r,t){r||0===t.length?Products_model.get({product_id:e.product_id},s,function(s){new_userproduct=new Userproducts({user_id:e.user_id,product_id:e.product_id,meta_datas:s.datas[0]}),new_userproduct.save(function(e,s){a(e?{status:405,message:e}:{status:200,datas:s})})}):a({status:201,datas:t,message:"ALREADY_ADDED_PRODUCT_ON_USER"})})},module.exports.remove=function(e,s,a){Userproducts.deleteOne({user_id:e.user_id,product_id:e.product_id},function(e,s){a(e||0===s.length?{status:401,err:e,message:"PRODUCT_DELETED_ERROR"}:{status:201,datas:s,message:"PRODUCT_DELETED"})})},module.exports.getShare=function(e,s,a){Usershares.find({share_email:e.params.user_email,product_id:e.params.product_id,_id:e.params.share_id},function(e,r){e?a({status:404,message:"UNKNOW_SHARE_CONTENT"}):0===r.length?a({status:404,message:"UNKNOW_SHARE_CONTENT"}):Products_model.get({product_id:r[0].product_id},s,function(e){a({status:200,datas:{share:r[0],product:e.datas[0]}})})})},module.exports.shares_of_the_day=function(e,s,a){var r=new Date;Usershares.find({share_date:{$not:{$type:9}}},function(e,s){s.forEach(function(e,s){null===e.share_date&&(e.share_date=new Date),e.share_date=new Date(e.share_date),Usershares.update({_id:e._id},{$set:{share_date:e.share_date}},function(e,s){})})}),Usershares.aggregate([{$project:{day:{$dayOfMonth:"$share_date"},month:{$month:"$share_date"},year:{$year:"$share_date"},user_id:"$user_id",product_id:"$product_id",share_name:"$share_name",share_email:"$share_email",share_message:"$share_message",share_link:"$share_link",share_later:"$share_later",share_date:"$share_date",share_sent:"$share_sent",created:"$created",updated:"$updated"}},{$match:{day:r.getDate(),month:r.getMonth()+1,share_later:!0}}],function(r,t){if(r)a({status:500,message:"ERROR_OCCURED_REQUEST",err:r});else{var n=0,o=t.length,d=0;if(0===t.length)a({status:200,message:"NO_EMAILS_FOR_TODAY",shares:t});else{var i=require("../controllers/email_controller"),u=require("../controllers/auth_controller");t.forEach(function(r,t){e.query.user={_id:r.user_id},u.getUserInfos(e,s,function(s){if(200===s.status){var t=s.user[0],u={month:"long",day:"numeric"};new Date(r.share_date).toLocaleDateString("fr-FR",u);i.sendMaChansonEcard(e,{subject:"Bonjour "+r.share_name+", "+t.pseudo+" vous souhaite un joyeux anniversaire en chanson",title:"Bonjour "+r.share_name+", "+t.pseudo+" vous souhaite un joyeux anniversaire en chanson",name:r.share_name,friend:t.pseudo,friend_email:t.email,default_message:"Bonjour "+r.share_name+",<br>votre ami(e) "+t.pseudo+" vous souhaite un joyeux anniversaire en chanson !",message:r.share_message,product_id:r.product_id,share_id:r._id,email:t.email,to:r.share_email},function(e){200===e.status&&(Usershares.update({_id:r._id},{$set:{share_sent:!0}},function(e,s){}),d++,i.send(null,{subject:"La chanson d'anniversaire personnalisée pour "+r.share_name+" à bien été envoyée",title:"La chanson d'anniversaire personnalisée pour "+r.share_name+" à bien été envoyée",message:"Bonjour "+t.pseudo+"<br>Vous avez envoyé une chanson d'anniversaire pour votre ami(e) "+r.share_name+".<br>Cet email confirme l'envoi de votre chanson sur l'adresse email de votre ami(e) : "+r.share_email+"<br>Voici votre message personnalisé qui accompagnera la chanson :<br>"+r.share_message,email:"contact@joyvox.fr",share_id:r._id,to:t.email},function(e){})),++n===o-1&&a({status:200,message:"EMAILS_SENT",total:o,success:d})})}else++n===o-1&&a({status:200,message:"EMAILS_SENT",total:o,success:d})})})}}})},module.exports.share=function(e,s,a){var r=e.body.data;Userproducts.find({user_id:r.options.user_id,product_id:r.product_id},function(t,n){if(t)a({status:200,message:"ERROR_PRODUCT_GET",response_display:{title:"Erreur de partage",message:"Il semble que vous n'ayez pas acheté le produit que vous souhaitez partager."}});else if(0===n.length)a({status:200,message:"UNKNOW_USER_PRODUCT",response_display:{title:"Erreur de Partage",message:"Il semble que vous n'ayez pas acheté le produit que vous souhaitez partager."}});else{var o=require("../controllers/email_controller"),d=require("../controllers/auth_controller");e.query.user={_id:r.options.user_id},d.getUserInfos(e,s,function(s){if(200===s.status){var t=s.user[0];new_shareproduct=new Usershares({user_id:s.user[0]._id,product_id:r.product_id,share_name:r.share_name,share_email:r.share_email,share_message:r.share_message,share_link:r.share_link,share_date:r.share_date?r.share_date:new Date,share_later:r.share_later}),new_shareproduct.save(function(n,d){if(n)a({status:200,datas:s.datas,response_display:{title:"Erreur de Partage",message:"Une erreur est survenue lors du partage de votre chanson personnalisée, nous vous conseillons de la télécharger et de l'envoyer manuellement.<br>Il est possible que nous n'arrivions pas à joindre la boite mail de votre ami(e)."}});else if("true"===r.share_later){var i={month:"long",day:"numeric"},u=new Date(r.share_date).toLocaleDateString("fr-FR",i);o.send(null,{subject:"L'envoi de la chanson d'anniversaire personnalisée pour "+r.share_name+" à bien été configuré",title:"L'envoi de votre chanson d'anniversaire à bien été configuré",message:"Bonjour "+t.pseudo+"<br>Vous avez configuré l'envoi d'une chanson d'anniversaire pour votre ami(e) "+r.share_name+" pour le "+u+".<br>Cet email confirme que l'email sera envoyé à 9h00 ce jour précis sur l'adresse email de votre ami(e) : "+r.share_email+"<br>Voici votre message personnalisé qui accompagnera la chanson :<br>"+r.share_message,email:"contact@joyvox.fr",share_id:d._id,to:t.email},function(e){a({status:200,datas:e.datas,response_display:{title:"Partager",message:"Le partage de la chanson d'anniversaire pour "+r.share_name+" a bien été configurée, elle sera envoyé à votre ami(e) sur son email "+r.share_email+" le "+u+" !"}})})}else o.sendMaChansonEcard(e,{subject:"Bonjour "+r.share_name+", "+t.pseudo+" vous souhaite un joyeux anniversaire en chanson",title:"Bonjour "+r.share_name+", "+t.pseudo+" vous souhaite un joyeux anniversaire en chanson",default_message:"Bonjour "+r.share_name+",<br>votre ami(e) "+t.pseudo+" vous souhaite un joyeux anniversaire en chanson !",message:r.share_message,friend:t.pseudo,friend_email:t.email,product_id:r.product_id,share_id:d._id,email:t.email,to:r.share_email},function(e){200===e.status?o.send(null,{subject:"La chanson d'anniversaire personnalisée pour "+r.share_name+" à bien été envoyée",title:"La chanson d'anniversaire personnalisée pour "+r.share_name+" à bien été envoyée",message:"Bonjour "+t.pseudo+"<br>Vous avez envoyé une chanson d'anniversaire pour votre ami(e) "+r.share_name+".<br>Cet email confirme l'envoi de votre chanson sur l'adresse email de votre ami(e) : "+r.share_email+"<br>Voici votre message personnalisé qui accompagnera la chanson :<br>"+r.share_message,email:"contact@joyvox.fr",share_id:d._id,to:t.email},function(e){a({status:200,datas:e.datas,response_display:{title:"Partager ma chanson",message:"La chanson a bien été envoyée à "+r.share_name+" sur son adresse email "+r.share_email+" !"}})}):a({status:203,datas:e.datas,response_display:{title:"Erreur de Partage",message:"Nous n'avons pas réussi à envoyer la chanson à votre ami(e)."}})})})}else a({status:203,datas:s.datas,response_display:{title:"Erreur de Partage",message:"Nous n'avons pas réussi à vous authentifier pour créer l'envoi de votre chanson."}})})}})};