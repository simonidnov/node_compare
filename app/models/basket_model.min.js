const db=require("mongoose"),products_controller=require("../controllers/products_controller"),config=require("../config/config"),_=require("underscore"),basket_datas={user_id:{type:"string"},products:{type:[],datas:{_id:{type:"Schema.ObjectId"},product_id:{type:"string",unique:!0},quantity:{type:"number",default:1},datas:{type:[]},price:{type:"Number"},total:{type:"Number"},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now}}},total:{type:"number",default:0},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const basketSchemas=new db.Schema(basket_datas),Baskets=db.model("Baskets",basketSchemas);module.exports={attributes:basket_datas},module.exports.get=function(t,e,a){var s={};if(t.isAdmin&&void 0!==t.basket_id)s={_id:t.basket_id};else if(void 0!==t.options)void 0!==t.options.user_id&&(s={user_id:t.options.user_id});else{if(void 0===e.session.Auth)return a({status:401,message:"NOT_LOGGED_IN"}),!1;s={user_id:e.session.Auth._id}}Baskets.find(s,function(t,s){t?a({status:401,datas:t}):(0===s.length&&a({status:200,datas:s}),s.forEach(function(t){t.total_amount=0;var d=0;t.products.forEach(function(o){products_controller.get({product_id:o.product_id},e,function(e){o.infos=e.datas[0],t.total_amount+=o.price*(void 0!==o.quantity?o.quantity:1),++d>=t.products.length&&a({status:200,datas:s})})})}))})},module.exports.create=function(t,e,a){var s=this,d=null;products_controller.get(t,e,function(o){if(200===o.status){if(d=o.datas[0],void 0===t.options.user_id)return a({status:405,message:"user not defined"}),!1;s.get(t,e,function(e){if(200===e.status&&e.datas.length>0){var s=e.datas[0];if(void 0!==t.product_id){var o=_.where(s.products,{product_id:t.product_id});o.length>0?(o=o[0],o.quantity++,o.total=parseFloat(o.price)*parseInt(o.quantity),o.updated=Date.now()):s.products.push({product_id:t.product_id,datas:t.datas,price:d.price,total:(parseFloat(d.price)*parseInt(t.quantity)).toFixed(2),created:Date.now(),updated:Date.now()}),s.updated=Date.now(),Baskets.updateOne({_id:s._id},{$set:s},function(t,e){a(t?{status:405,message:t}:{status:200,datas:e})})}}else{var u={user_id:t.options.user_id,products:[{product_id:t.product_id,quantity:1,datas:t.datas,price:d.price,total:(parseFloat(d.price)*parseFloat(t.quantity)).toFixed(2),created:Date.now(),updated:Date.now()}],total:(parseFloat(d.price)*parseFloat(t.quantity)).toFixed(2),created:Date.now(),updated:Date.now()};new_basket=new Baskets(u),new_basket.save(function(t,e){a(t?{status:405,message:t}:{status:200,datas:e})})}})}else a(o)})},module.exports.update=function(t,e,a){delete datas.options,delete datas._id;datas.updated=Date.now(),Baskets.updateOne({_id:t.body._id},{$set:datas},function(t,e){a(t?{status:405,message:t}:{status:200,apps:e})})},module.exports.delete=function(t,e,a){Baskets.deleteOne({_id:t.body._id},function(t,e){a(t?{status:405,message:t}:{status:200,apps:e})})};