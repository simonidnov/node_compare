const db=require("mongoose"),products_controller=require("../controllers/products_controller"),config=require("../config/config"),_=require("underscore"),basket_datas={user_id:{type:"string"},products:{type:[],datas:{_id:{type:"Schema.ObjectId"},product_id:{type:"string",unique:!0},quantity:{type:"number",default:1},datas:{type:[]},price:{type:"Number"},total:{type:"Number"},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now}}},total:{type:"number",default:0},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const basketSchemas=new db.Schema(basket_datas),Baskets=db.model("Baskets",basketSchemas);module.exports={attributes:basket_datas},module.exports.get=function(t,e,a){var s={};if(t.isAdmin&&void 0!==t.basket_id)s={_id:t.basket_id};else if(void 0!==t.options)void 0!==t.options.user_id&&(s={user_id:t.options.user_id});else if(void 0!==e.session.Auth)s={user_id:e.session.Auth._id};else{if(void 0===t.user_id)return a({status:401,message:"NOT_LOGGED_IN"}),!1;s={user_id:t.user_id}}Baskets.find(s,function(t,s){t?a({status:401,datas:t}):(0===s.length&&a({status:200,datas:s}),s.forEach(function(t){t.total_amount=0;var o=0;t.products.length>0?t.products.forEach(function(d){products_controller.get({product_id:d.product_id},e,function(e){0===e.datas.length?d.infos={label:"DOSNT_EXIST",message:"PRODUIT_INTROUVABLE_OU_SUPPRIME"}:(d.infos=e.datas[0],t.total_amount+=d.price*(void 0!==d.quantity?d.quantity:1)),++o>=t.products.length&&a({status:200,datas:s})})}):a({status:200,datas:s})}))})},module.exports.getAmount=function(t,e,a){var s={};if(t.isAdmin&&void 0!==t.basket_id)s={_id:t.basket_id};else if(void 0!==t.options)void 0!==t.options.user_id&&(s={user_id:t.options.user_id});else if(void 0!==e.session.Auth)s={user_id:e.session.Auth._id};else{if(void 0===t.user_id)return a({status:401,message:"NOT_LOGGED_IN"}),!1;s={user_id:t.user_id}}Baskets.find(s,function(s,o){s?a({status:401,datas:s}):(0===o.length&&a({status:200,datas:o}),o.forEach(function(s){s.total_amount=0;var d=0;s.products.length>0?s.products.forEach(function(o){products_controller.get({product_id:o.product_id},e,function(e){0===e.datas.length?o.infos={label:"DOSNT_EXIST",message:"PRODUIT_INTROUVABLE_OU_SUPPRIME"}:(o.infos=e.datas[0],s.total_amount+=o.price*(void 0!==o.quantity?o.quantity:1)),d++;for(var u={amount:s.total_amount,new_amount:s.total_amount,reduction:0,reduced_amount:0,dif_amount:0},n=0;n<t.coupon_code.length;n++)u.reduction=parseInt(u.reduction)+parseInt(t.coupon_code[n].amount);u.reduced_amount=s.total_amount-u.reduction,u.new_amount=u.reduced_amount,u.reduced_amount<0&&(u.new_amount=0,u.dif_amount=Math.abs(u.reduction-s.total_amount),u.wallet_infos=t.coupon_code[0],u.wallet_infos.amount=u.dif_amount),d>=s.products.length&&a({status:200,datas:u})})}):a({status:200,datas:o})}))})},module.exports.create=function(t,e,a){var s=this,o=null;products_controller.get(t,e,function(d){if(200===d.status){if(o=d.datas[0],void 0===t.options.user_id)return a({status:405,message:"user not defined"}),!1;s.get(t,e,function(e){if(console.log("SELF GET ",e),200===e.status&&e.datas.length>0){var s=e.datas[0];if(void 0!==t.product_id){var d=_.where(s.products,{product_id:t.product_id});d.length>0?(d=d[0],d.quantity=1,d.total=parseFloat(d.price)*parseInt(d.quantity),d.updated=Date.now()):s.products.push({product_id:t.product_id,datas:t.datas,price:o.price,total:(parseFloat(o.price)*parseInt(t.quantity)).toFixed(2),created:Date.now(),updated:Date.now()}),s.updated=Date.now(),Baskets.updateOne({_id:s._id},{$set:s},function(t,e){a(t?{status:405,message:t}:{status:200,datas:e})})}}else{var u={user_id:t.options.user_id,products:[{product_id:t.product_id,quantity:1,datas:t.datas,price:o.price,total:(parseFloat(o.price)*parseFloat(t.quantity)).toFixed(2),created:Date.now(),updated:Date.now()}],total:(parseFloat(o.price)*parseFloat(t.quantity)).toFixed(2),created:Date.now(),updated:Date.now()};new_basket=new Baskets(u),new_basket.save(function(t,e){a(t?{status:405,datas:{message:"ERROR",infos:t}}:{status:200,datas:e})})}})}else a(d)})},module.exports.update=function(t,e,a){delete datas.options,delete datas._id;datas.updated=Date.now(),Baskets.updateOne({_id:t.body._id},{$set:datas},function(t,e){a(t?{status:405,datas:t}:{status:200,datas:e})})},module.exports.deleteUserBasket=function(t,e){Baskets.deleteOne({user_id:t},function(t){e(t)})},module.exports.delete=function(t,e,a){void 0!==t.body.product_id&&console.log("req.body.product_id ",t.body.product_id),void 0!==t.body.basket_id&&console.log("req.body.basket_id ",t.body.basket_id),Baskets.update({_id:t.body.basket_id},{$pull:{products:{product_id:t.body.product_id}}},function(t,e){a(t?{status:400,datas:{message:t}}:{status:200,datas:e})})};