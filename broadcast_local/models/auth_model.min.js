const db=require("mongoose"),app=require("../app"),sha1=require("sha1"),jwt=require("jsonwebtoken"),validator=require("email-validator"),Members_model=require("../models/members_model"),Address_model=require("../models/address_model"),config=require("../config/config"),os=require("os"),gravatar=require("gravatar"),user_datas={email:{type:"string",unique:!0},password:{type:"string"},pseudo:{type:"string",unique:!0},firstName:{type:"string"},avatar:{type:"string"},lastName:{type:"string"},phone:{type:"string"},mobile:{type:"string"},token:{type:"string"},secret:{type:"string"},qrcode:{type:"Object"},birthDate:{type:"Date"},gender:{type:"string","enum":["undefined","male","female"],defaults:"undefined"},address:{type:"Array"},friends:{type:"Array"},relations:{type:"Array"},tags:{type:"Object"},devices:{type:"Object"},termAccept:{type:"Boolean"},newsletter:{type:"Boolean"},rights:{type:"Object"},newsletter_services:{type:"Object"},validated:{type:"Boolean"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now},public_locale:{type:"Boolean"},public_profile:{type:"Object"}},machineId=require("node-machine-id"),device_uid=machineId.machineIdSync({original:!0});0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const userSchemas=new db.Schema(user_datas),User=db.model("User",userSchemas);module.exports={attributes:user_datas},module.exports.login=function(e,t,a){var s=this;return t.password?validator.validate(t.email)?User.find({email:t.email,password:sha1(t.password)},function(i,r){if(i)a({status:"error",code:i.code,error:i,message:i.message});else{if(0===r.length)return User.find({email:t.email},function(e,t){a(e?{status:"error",code:11,error:e,message:"user_not_found"}:0===t.length?{status:"error",code:11,error:e,message:"user_not_found",email_valid:t.length}:{status:"error",code:13,error:e,message:"wrong_pawword",email_valid:t.length})}),!1;var n={uid:t.device_uid,arch:os.arch(),name:os.hostname()},d=jwt.sign({secret:r[0].secret},config.secrets.global.secret);if(n.token=d,User.find({_id:r[0]._id,devices:{$elemMatch:{uid:t.device_uid}}},function(e,a){e?User.update({_id:r[0]._id},{$push:{devices:n}},function(e,t){e?console.log("impossible d insérer le new_device ",e):console.log("new_device ajouté success ",t)}):0===a.length?User.update({_id:r[0]._id},{$push:{devices:n}},function(e,t){e?console.log("impossible d insérer le new_device ",e):console.log("new_device ajouté success ",t)}):User.update({id:r[0]._id,devices:{$elemMatch:{uid:t.device_uid}}},{$set:{token:d}},function(e,t){e?console.log("update device token error ",e):console.log("update device token success ",t)},!0)}),""===r[0].avatar||null==r[0].avatar)var o=gravatar.url(r[0].email,{s:"200",r:"pg",d:"404"}).replace("//","http://");else var o=r[0].avatar;User.update({_id:r[0]._id},{$set:{token:d,updated:Date.now(),avatar:o}},function(t,i){t?a({status:"error",code:t.code,error:t,message:t.message}):s.reset_session(e,r[0]._id,function(e){a({status:200,message:"User updated",idkids_user:e})})})}}):a({message:"email invalide"},null):a([]),t},module.exports.logout=function(e,t){return t(),e},module.exports.register=function(e,t){db.connect(config.database.users,{useMongoClient:!0});var a={email:e.body.subscribe_email,password:sha1(e.body.subscribe_password),pseudo:e.body.pseudo,secret:jwt.sign({},config.secrets.global.secret,{}),termAccept:!0,rights:{type:"RWU",authorizations:["me"]}};return a.token=jwt.sign({secret:a.secret},config.secrets.global.secret),a.device=[{uid:e.body.device_uid,arch:os.arch(),name:os.hostname(),token:jwt.sign({secret:a.secret},config.secrets.global.secret),avatar:gravatar.url(e.body.subscribe_email,{s:"200",r:"pg",d:"404"}).replace("//","http://")}],e.body.subscribe_newsletter?(a.newsletter=!0,a.newsletter_services={},e.body.newsletter_okaidi&&(a.newsletter_services.okaidi=1),e.body.newsletter_obaibi&&(a.newsletter_services.obaibi=1),e.body.newsletter_jacadi&&(a.newsletter_services.jacadi=1),e.body.newsletter_oxybul&&(a.newsletter_services.oxybul=1),e.body.newsletter_rclv&&(a.newsletter_services.rclv=1),e.body.newsletter_njoy&&(a.newsletter_services.njoy=1),e.body.newsletter_joyvox&&(a.newsletter_services.joyvox=1)):(a.newsletter=!1,a.newsletter_services={}),new_user=new User(a),new_user.save(function(e){t(e?{status:"error",message:e}:{status:"success",user:a})}),e.body},module.exports.unregister=function(e){return e},module.exports.update=function(e,t,a,s){var i=this;a.updated=Date.now(),"undefined"!=typeof a.birthDate&&(a.birthDate=a.birthDate),console.log("USER UPDATE --------------------- "),console.log("USER UPDATE --------------------- "),console.log("USER UPDATE --------------------- "),console.log(a),console.log("USER UPDATE --------------------- "),console.log("USER UPDATE --------------------- "),console.log("USER UPDATE --------------------- "),User.update({_id:t},{$set:a},function(a,r){a?s({status:401,message:"Impossible de mettre à jour le token WHY ?",datas:a}):i.reset_session(e,t,function(){s({status:200,message:"User updated",datas:r})})},!0)},module.exports.check_user=function(e,t){var a={uid:e.options.device_uid,arch:os.arch(),name:os.hostname()},s=jwt.sign({secret:e.options.user_secret},config.secrets.global.secret);a.token=s,User.find({_id:e.options.user_id,secret:e.options.user_secret,devices:{$elemMatch:{uid:e.options.device_uid,token:e.options.user_token}}},function(a,i){a?t({status:401,message:"user token device doesn't match",datas:a}):User.update({id:e.options.user_id,devices:{$elemMatch:{uid:e.options.device_uid}}},{$set:{token:s,updated:Date.now()}},function(e,a){t(e?{status:401,message:"Impossible de mettre à jour le token WHY ?",datas:e}:{status:200,message:"User auth success",datas:i,updated_token:s})},!0)})},module.exports.reset_session=function(e,t,a){User.findOne({_id:t},function(s,i){s?a({status:401,code:s.code,error:s,message:s.message}):(user_infos=JSON.parse(JSON.stringify(i)),user_infos.current_device=device_uid,Members_model.get(t,null,function(s){user_infos.members=s.datas,Address_model.get(t,null,function(t){user_infos.address=t.datas,e.session.Auth=user_infos,a({status:200,message:"Session Updated",datas:user_infos})})}))})},module.exports.getPublicProfile=function(e,t){this.getFullUser(e,function(e){if(200===e.status){var a={_id:e.datas._id,pseudo:e.datas.pseudo,email:e.datas.email,avatar:e.datas.avatar,created:e.datas.created,updated:e.datas.updated};t({status:e.status,message:e.message,datas:a})}else t(e)})},module.exports.getServices=function(e,t){this.getFullUser(e,function(e){if(200===e.status){({is_newsletter:e.datas.is_newsletter,newsletter_services:e.datas.newsletter_services});t({status:e.status,message:e.message,datas:e.datas.public_services})}else t(e)})},module.exports.getFullUser=function(e,t){User.findOne({_id:e},function(a,s){a?t({status:401,message:"This is no way to peace -> peace is the way. UNAUTHORIZED",datas:a}):Members_model.get(e,null,function(e){s.members=e.datas,t({status:200,message:"success me",datas:s})})})},user_datas.getAge=function(){return this.birthDate};