const db=require("mongoose"),app=require("../app"),sha1=require("sha1"),jwt=require("jsonwebtoken"),validator=require("email-validator"),Members_model=require("../models/members_model"),Address_model=require("../models/address_model"),config=require("../config/config"),gravatar=require("gravatar"),user_datas={email:{type:"string",unique:!0},password:{type:"string"},pseudo:{type:"string",unique:!0},firstName:{type:"string"},avatar:{type:"string"},lastName:{type:"string"},phone:{type:"string"},mobile:{type:"string"},token:{type:"string"},validation_code:{type:"string"},secret:{type:"string"},qrcode:{type:"Object"},birthDate:{type:"Date"},gender:{type:"string","enum":["undefined","male","female"],defaults:"undefined"},address:{type:"Array"},friends:{type:"Array"},relations:{type:"Array"},apps:{type:"Array"},tags:{type:"Object"},devices:{uid:"string",name:"string",arch:"string"},termAccept:{type:"Boolean"},newsletter:{type:"Boolean"},newsletter_services:{type:"Object"},sms:{type:"Boolean"},sms_services:{type:"Object"},notifications:{type:"Boolean"},notifications_services:{type:"Object"},rights:{type:"Object"},validated:{type:"Boolean"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now},public_locale:{type:"Boolean"},public_profile:{type:"Object"}},machineId=require("node-machine-id");var device_uid=machineId.machineIdSync({original:!0});0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const userSchemas=new db.Schema(user_datas),User=db.model("User",userSchemas);db.connection.on("open",function(e){console.log("Connected to mongo server.")}),db.connection.on("error",function(e){console.log("Could not connect to mongo server!"),console.log(e)}),module.exports={attributes:user_datas},module.exports.getCount=function(){return User.find({}).count()},module.exports.getActive=function(){return User.find({updated:{$gte:new Date(ISODate().getTime()-2592e5)}}).count()},module.exports.get=function(e,s,t){device_uid=e.query.device_uid;var i=this;User.find({},function(e,s){t(e?{status:304,code:e.code,error:e,message:e.message}:{status:200,users:s,total:i.getCount()})}).skip(50*parseInt(s.page)).limit(50)},module.exports.deleteDevice=function(e,s,t){User.update({_id:s.user_id},{$pull:{devices:{uid:e.query.device_uid}}},function(e,s){errr?console.log("ERROR ",e):console.log("deleted ",s)})},module.exports.login=function(e,s,t){var i=null;"undefined"==typeof e.query.remember_me?console.log("DO NOT REMEMBER req.query.remember_me ::: ",e.query.remember_me):"undefined"!=typeof e.query.device_infos?(device_uid=e.query.device_infos.device_uid,i={uid:device_uid,appCodeName:e.query.device_infos.appCodeName,appName:e.query.device_infos.appName,appVersion:e.query.device_infos.appVersion,userAgent:e.query.device_infos.userAgent,vendor:e.query.device_infos.vendor,last_connexion:Date.now()}):"undefined"!=typeof e.query.device_uid&&(device_uid=e.query.device_uid,i={uid:device_uid,appCodeName:e.query.appCodeName,appName:e.query.appName,appVersion:e.query.appVersion,userAgent:e.query.userAgent,vendor:e.query.vendor,last_connexion:Date.now()});var r=this;return s.password?validator.validate(s.email)?User.find({email:s.email,password:sha1(s.password)},function(o,a){if(o)t({status:"error",code:o.code,error:o,message:o.message});else{if(0===a.length)return User.find({email:s.email},function(e,s){t(e?{status:"error",code:11,error:e,message:"user_not_found"}:0===s.length?{status:"error",code:11,error:e,message:"user_not_found",email_valid:s.length}:{status:"error",code:13,error:e,message:"wrong_pawword",email_valid:s.length})}),!1;console.log("CHECK DEVICE device_uid :::: LOGIN ",device_uid);var n=jwt.sign({secret:a[0].secret},config.secrets.global.secret,{expiresIn:"2 days"});if("undefined"!=typeof e.query.remember_me&&(i.token=n,User.find({_id:a[0]._id,devices:{$elemMatch:{uid:device_uid}}},function(e,s){e?(console.log("device_uid :::: LOGIN ERROR ",device_uid," ERRROR ::: ",e),User.update({_id:a[0]._id},{$push:{devices:i}},function(e,s){e?console.log("impossible d insérer le new_device ",e):console.log("new_device ajouté success ",s)})):0===s.length?(console.log("-------------------- new_device device introuvable on l'ajoute -------------- ",s),User.update({_id:a[0]._id},{$push:{devices:i}},function(e,s){e?console.log("impossible d insérer le new_device ",e):console.log("new_device ajouté success ",s)})):(console.log("-------------------- LE DEVICE EXISTE -------------- ",s),User.update({id:a[0]._id,devices:{$elemMatch:{uid:device_uid}}},{$set:{token:n},device:{$set:i}},function(e,s){e?console.log("update device token error ",e):console.log("update device token success ",s)},!0))})),""===a[0].avatar||null==a[0].avatar)var d=gravatar.url(a[0].email,{s:"200",r:"pg",d:"404"}).replace("//","http://");else var d=a[0].avatar;User.update({_id:a[0]._id},{$set:{token:n,updated:Date.now(),avatar:d}},function(s,i){s?t({status:"error",code:s.code,error:s,message:s.message}):r.reset_session(e,a[0]._id,function(e){t({status:200,message:"User updated",idkids_user:e})})})}}):t({message:"email invalide"},null):t([]),s},module.exports.logout=function(e,s,t){e.session.destroy(),t()},module.exports.register=function(e,s){db.connect(config.database.users,{useMongoClient:!0});var t={email:e.body.subscribe_email,password:sha1(e.body.subscribe_password),pseudo:e.body.pseudo,secret:jwt.sign({},config.secrets.global.secret,{},{expiresIn:"2 days"}),termAccept:!0,rights:{type:"RWO",authorizations:["me"]}};return t.token=jwt.sign({secret:t.secret},config.secrets.global.secret,{expiresIn:"2 days"}),t.device=[{uid:device_uid,token:jwt.sign({secret:t.secret},config.secrets.global.secret,{expiresIn:"2 days"}),avatar:gravatar.url(e.body.subscribe_email,{s:"200",r:"pg",d:"404"}).replace("//","http://")}],e.body.subscribe_newsletter?(t.newsletter=!0,t.newsletter_services={},e.body.newsletter_okaidi&&(t.newsletter_services.okaidi=1),e.body.newsletter_obaibi&&(t.newsletter_services.obaibi=1),e.body.newsletter_jacadi&&(t.newsletter_services.jacadi=1),e.body.newsletter_oxybul&&(t.newsletter_services.oxybul=1),e.body.newsletter_rclv&&(t.newsletter_services.rclv=1),e.body.newsletter_njoy&&(t.newsletter_services.njoy=1),e.body.newsletter_joyvox&&(t.newsletter_services.joyvox=1)):(t.newsletter=!1,t.newsletter_services={}),new_user=new User(t),new_user.save(function(e){s(e?{status:"error",message:e}:{status:"success",user:t})}),e.body},module.exports.unregister=function(e){return device_uid=req.body.device_uid,e},module.exports.update=function(e,s,t,i){device_uid=e.body.device_uid;var r=this;t.updated=Date.now(),"undefined"!=typeof t.birthDate&&(t.birthDate=t.birthDate),User.update({_id:s},{$set:t},function(t,o){t?i({status:401,message:"Impossible de mettre à jour le token WHY ?",datas:t}):r.reset_session(e,s,function(){i({status:200,message:"User updated",datas:o})})},!0)},module.exports.updatePassword=function(e,s){console.log(req),s({status:200,message:"password update progress"})},module.exports.check_user=function(e,s){device_uid=e.device_uid;var t={uid:device_uid},i=jwt.sign({secret:e.options.user_secret},config.secrets.global.secret,{expiresIn:"2 days"});t.token=i,User.find({_id:e.options.user_id,secret:e.options.user_secret,devices:{$elemMatch:{uid:device_uid,token:e.options.user_token}}},function(t,r){t?s({status:401,message:"user token device doesn't match",datas:t}):User.update({id:e.options.user_id,devices:{$elemMatch:{uid:device_uid}}},{$set:{token:i,updated:Date.now()}},function(e,t){s(e?{status:401,message:"Impossible de mettre à jour le token WHY ?",datas:e}:{status:200,message:"User auth success",datas:r,updated_token:i})},!0)})},module.exports.reset_session=function(e,s,t){User.findOne({_id:s},function(i,r){i?t({status:401,code:i.code,error:i,message:i.message}):(user_infos=JSON.parse(JSON.stringify(r)),user_infos.current_device=device_uid,Members_model.get(s,null,function(i){user_infos.members=i.datas,Address_model.get(s,null,function(s){user_infos.address=s.datas,e.session.Auth=user_infos,t({status:200,message:"Session Updated",datas:user_infos})})}))})},module.exports.getPublicProfile=function(e,s){this.getFullUser(e,function(e){if(200===e.status){var t={_id:e.datas._id,pseudo:e.datas.pseudo,email:e.datas.email,avatar:e.datas.avatar,created:e.datas.created,updated:e.datas.updated};s({status:e.status,message:e.message,datas:t})}else s(e)})},module.exports.getServices=function(e,s){this.getFullUser(e,function(e){if(200===e.status){({is_newsletter:e.datas.is_newsletter,newsletter_services:e.datas.newsletter_services});s({status:e.status,message:e.message,datas:e.datas.public_services})}else s(e)})},module.exports.getFullUser=function(e,s){User.findOne({_id:e},function(t,i){t?s({status:401,message:"This is no way to peace -> peace is the way. UNAUTHORIZED",datas:t}):null!==i?Members_model.get(e,null,function(e){i.members=e.datas,s({status:200,message:"success me",datas:i})}):s({status:304,message:"USER NOT FOUND",datas:i})})},module.exports.getValidationCode=function(e,s){User.findOne({_id:e},function(e,t){if(e)s({status:401,message:"This is no way to peace -> peace is the way. UNAUTHORIZED",datas:e});else if(null!==t){var i=jwt.sign({secret:t.secret},config.secrets.global.secret,{expiresIn:"2 days"});User.update({_id:t._id},{$set:{validation_code:i}},function(e,r){e?console.log("impossible de mettre à jour le code de validation ",e):console.log("token de validation mis à jour"),s({status:200,validation_code:i,email:t.email,pseudo:t.pseudo,avatar:t.avatar})})}else s({status:304,message:"USER NOT FOUND",datas:t})})},module.exports.validAccount=function(e,s){User.findOne({email:e.email,validation_code:e.validation_code},function(e,t){console.log(t),e||null===t?s({status:304,message:"Impossible de certifier l'utilisateur",datas:e}):User.update({_id:t._id},{$set:{validated:!0,certified:!0}},function(e,t){s(e?{status:304,message:"Impossible de certifier l'utilisateur",datas:e}:{status:200,message:"Utilisateur certifié validé",datas:t})})})},module.exports.getUsersDevice=function(e,s){device_uid=e.query.device_uid,User.find({_id:{$ne:e.session.Auth},devices:{$elemMatch:{uid:device_uid}}},{email:1,avatar:1,pseudo:1},function(e,t){s(e||0===t.length?{status:304,message:"Nouvel appareil",datas:e}:{status:200,message:"liste des utilisateurs ayant utilisé ce device",users_device:t})})},module.exports.deleteDevice=function(e,s){var t=this;e.query.device_uid;User.update({_id:e.session.Auth._id},{$pull:{devices:{$elemMatch:{uid:e.body.uid}}}},function(i,r){i||0===r.length?s({status:304,message:"appareil inexistant",datas:i}):t.reset_session(e,e.session.Auth._id,function(e){s({status:200,message:"device supprimé",users_device:r,idkids_user:e})})})},user_datas.getAge=function(){return this.birthDate};