const db=require("mongoose"),config=require("../config/config"),_=require("underscore"),Users_model=require("../models/auth_model"),await=require("await"),comments_datas={label:{type:"string"},description:{type:"string"},content:{type:"string"},user_id:{type:"string"},is_response:{type:"bool"},comment_id:{type:"string"},page_url:{type:"string"},stars:{type:"Number"},is_valid:{type:"bool"},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const commentsSchemas=new db.Schema(comments_datas),Comments=db.model("Comments",commentsSchemas);Comments.collection.dropIndexes(),module.exports={attributes:comments_datas},module.exports.get=function(e,t,s){void 0===e.query.page_url&&s({status:405,messsage:"need page url"});var a={page_url:e.query.page_url};Comments.find(a).sort({updated:-1}).limit(50).exec(function(e,t){if(e)s({status:405,datas:e});else{var a=[];t.forEach(function(e){Users_model.getPublicProfile(e.user_id,function(t){a.push({_id:e._id,label:e.label,page_url:e.page_url,content:e.content,stars:e.stars,user_id:e.user_id,created:e.created,updated:e.updated,user_infos:t.datas})})}),setTimeout(function(){var e=_.sortBy(a,function(e){return-new Date(e.created).getTime()});s({status:200,datas:e})},500)}})},module.exports.getStats=function(e,t,s){void 0===e.query.page_url&&s({status:405,messsage:"need page url"}),Comments.aggregate([{$match:{page_url:e.query.page_url}},{$group:{_id:"$page_url",count:{$sum:1},stars:{$sum:{$multiply:["$stars",1]}}}}],function(t,a){console.log("err :::: ",t),console.log("infos ::::: ",a),t?s({status:405,datas:t}):(0===a.length?a=[{count:0,stars:0,_id:e.query.page_url}]:void 0===a[0].count&&(a=[{count:0,stars:0,_id:e.query.page_url}]),s({status:200,datas:a}))})},module.exports.create=function(e,t,s){console.log("req.body ===== ",e.body),void 0===e.body&&s({status:400,datas:{message:"METHOD NOT ALLOWED"}}),void 0===e.body.label&&s({status:400,datas:{message:"NEED_LABEL"}}),void 0===e.body.page_url&&s({status:400,datas:{message:"NEED_PAGE_URL"}}),void 0===e.body.content&&s({status:400,datas:{message:"NEED_CONTENT"}}),void 0===e.body.stars&&s({status:400,datas:{message:"NEED_STARS"}}),void 0===e.body.options.user_id&&s({status:400,datas:{message:"NEED_USER_ID"}});var a={label:e.body.label,page_url:e.body.page_url,content:e.body.content,stars:e.body.stars,user_id:e.body.options.user_id};new_comment=new Comments(a),new_comment.save(function(e,t){s(e?{status:400,datas:{message:e}}:{status:200,datas:t})})},module.exports.update=function(e,t,s){delete datas.options,delete datas._id,datas.updated=Date.now(),Comments.updateOne({_id:comment_id,user_id:user_id},{$set:datas},function(e,t){s(e?{status:304,message:e}:{status:200,pages:t})})},module.exports.delete=function(e,t,s){Comments.deleteOne({_id:e.body.comment_id,user_id:e.body.options.user_id},function(e,t){s(e?{status:405,message:e}:{status:200,datas:t})})};