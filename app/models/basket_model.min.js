var $jscomp={scope:{},findInternal:function(a,c,d){a instanceof String&&(a=String(a));for(var b=a.length,e=0;e<b;e++){var g=a[e];if(c.call(d,g,e,a))return{i:e,v:g}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,d){if(d.get||d.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[c]=d.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,c,d,b){if(c){d=$jscomp.global;a=a.split(".");for(b=0;b<a.length-1;b++){var e=a[b];e in d||(d[e]={});d=d[e]}a=a[a.length-1];b=d[a];c=c(b);c!=b&&null!=c&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,d){return $jscomp.findInternal(this,a,d).v}},"es6-impl","es3");
var db=require("mongoose"),products_controller=require("../controllers/products_controller"),config=require("../config/config"),_=require("underscore"),basket_datas={user_id:{type:"string"},address_id:{type:"string"},products:{type:[],datas:{_id:{type:"Schema.ObjectId"},product_id:{type:"string",unique:!0},quantity:{type:"number","default":1},url:{type:"string"},datas:{type:[]},price:{type:"Number"},total:{type:"Number"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}}},
total:{type:"number","default":0},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});var basketSchemas=new db.Schema(basket_datas),Baskets=db.model("Baskets",basketSchemas);module.exports={attributes:basket_datas};module.exports.getStats=function(a,c,d){Baskets.find({},function(a,e){a?d({status:405,datas:a}):d({status:200,datas:e})})};
module.exports.get=function(a,c,d){var b={};if(a.isAdmin&&"undefined"!==typeof a.basket_id)b={_id:a.basket_id};else if("undefined"!==typeof a.options)"undefined"!==typeof a.options.user_id&&(b={user_id:a.options.user_id});else if("undefined"!==typeof a.user_id)b={user_id:a.user_id};else if("undefined"!==typeof c.session.Auth)b={user_id:c.session.Auth._id};else return d({status:401,message:"NOT_LOGGED_IN"}),!1;Baskets.find(b,function(a,b){a?d({status:401,datas:a}):(0===b.length&&d({status:200,datas:b}),
b.forEach(function(a){var e=a.total_amount=0;0<a.products.length?a.products.forEach(function(f){products_controller.get({product_id:f.product_id},c,function(c){0===c.datas.length?f.infos={label:"DOSNT_EXIST",message:"PRODUIT_INTROUVABLE_OU_SUPPRIME"}:(f.infos=c.datas[0],a.total_amount+=f.price*("undefined"!==typeof f.quantity?f.quantity:1));e++;e>=a.products.length&&d({status:200,datas:b})})}):d({status:200,datas:b})}))})};
module.exports.getUserBasket=function(a,c,d){"undefined"===typeof a.current_user._id?d({status:401,datas:{message:"UNAUTHORISED_NEED_USER"}}):Baskets.find({user_id:a.current_user._id},function(b,e){b?d({status:401,datas:b}):(0===e.length&&d({status:200,datas:e}),e.forEach(function(b){var c=b.total_amount=0;0<b.products.length?b.products.forEach(function(f){products_controller.get({product_id:f.product_id},a,function(a){0===a.datas.length?f.infos={label:"DOSNT_EXIST",message:"PRODUIT_INTROUVABLE_OU_SUPPRIME"}:
(f.infos=a.datas[0],b.total_amount+=f.price*("undefined"!==typeof f.quantity?f.quantity:1));c++;c>=b.products.length&&d({status:200,datas:e})})}):d({status:200,datas:e})}))})};
module.exports.getAmount=function(a,c,d){var b={};if(a.isAdmin&&"undefined"!==typeof a.basket_id)b={_id:a.basket_id};else if("undefined"!==typeof a.options)"undefined"!==typeof a.options.user_id&&(b={user_id:a.options.user_id});else if("undefined"!==typeof c.session.Auth)b={user_id:c.session.Auth._id};else if("undefined"!==typeof a.user_id)b={user_id:a.user_id};else return d({status:401,message:"NOT_LOGGED_IN"}),!1;Baskets.find(b,function(b,g){b?d({status:401,datas:b}):(0===g.length&&d({status:200,
datas:g}),g.forEach(function(b){var e=b.total_amount=0;0<b.products.length?b.products.forEach(function(f){products_controller.get({product_id:f.product_id},c,function(c){0===c.datas.length?f.infos={label:"DOSNT_EXIST",message:"PRODUIT_INTROUVABLE_OU_SUPPRIME"}:(f.infos=c.datas[0],b.total_amount+=f.price*("undefined"!==typeof f.quantity?f.quantity:1));e++;c={amount:b.total_amount,new_amount:b.total_amount,reduction:0,reduced_amount:0,dif_amount:0};for(var g=0;g<a.coupon_code.length;g++)c.reduction=
parseInt(c.reduction)+parseInt(a.coupon_code[g].amount);c.reduced_amount=b.total_amount-c.reduction;c.new_amount=c.reduced_amount;0>c.reduced_amount&&(c.new_amount=0,c.dif_amount=Math.abs(c.reduction-b.total_amount),c.wallet_infos=a.coupon_code[0],c.wallet_infos.amount=c.dif_amount);e>=b.products.length&&d({status:200,datas:c})})}):d({status:200,datas:g})}))})};
module.exports.create=function(a,c,d){var b=this,e=null;products_controller.get(a,c,function(g){if(200===g.status){e=g.datas[0];if("undefined"===typeof a.options.user_id)return d({status:405,message:"user not defined"}),!1;b.get(a,c,function(b){if(200===b.status&&0<b.datas.length){if(b=b.datas[0],"undefined"!==typeof a.product_id){var c=_.where(b.products,{product_id:a.product_id});0<c.length?(c=c[0],c.quantity=1,c.total=parseFloat(c.price)*parseInt(c.quantity),c.updated=Date.now()):b.products.push({product_id:a.product_id,
datas:a.datas,url:a.url,price:e.price,total:(parseFloat(e.price)*parseInt(a.quantity)).toFixed(2),created:Date.now(),updated:Date.now()});b.updated=Date.now();Baskets.updateOne({_id:b._id},{$set:b},function(a,b){a?d({status:405,message:a}):d({status:200,datas:b})})}}else b={user_id:a.options.user_id,products:[{product_id:a.product_id,quantity:1,datas:a.datas,price:e.price,total:(parseFloat(e.price)*parseFloat(a.quantity)).toFixed(2),created:Date.now(),updated:Date.now()}],total:(parseFloat(e.price)*
parseFloat(a.quantity)).toFixed(2),created:Date.now(),updated:Date.now()},new_basket=new Baskets(b),new_basket.save(function(a,b){a?d({status:405,datas:{message:"ERROR",infos:a}}):d({status:200,datas:b})})})}else d(g)})};module.exports.update=function(a,c,d){delete a.options;delete a.decoded;delete a.isAdmin;delete a.updated_token;delete a.device_infos;c=a.basket_id;delete a.basket_id;a.updated=Date.now();Baskets.update({_id:c},{$set:a},function(a,c){a?d({status:405,datas:a}):d({status:200,datas:c})})};
module.exports.deleteUserBasket=function(a,c){Baskets.deleteOne({user_id:a},function(a){c(a)})};module.exports["delete"]=function(a,c,d){Baskets.update({_id:a.body.basket_id},{$pull:{products:{product_id:a.body.product_id}}},function(a,c){a?d({status:400,datas:{message:a}}):d({status:200,datas:c})})};
