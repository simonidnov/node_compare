var express=require("express"),_=require("underscore"),config=require("../config/config"),account=express.Router(),Auth_model=require("../models/auth_model"),Auth_helper=require("../helpers/auth_helper"),Basket_controller=require("../controllers/basket_controller"),Userproducts_controller=require("../controllers/userproducts_controller"),Order_controller=require("../controllers/orders_controller"),language_helper=require("../helpers/languages_helper"),uri_helper=require("../helpers/uri_helper"),lang=
require("../public/languages/auth_lang"),Fb=require("fb"),keyPublishable="",keySecret="",keySecret=keyPublishable="";
account.use(function(a,b,c){b.setHeader("Access-Control-Allow-Origin","*");b.setHeader("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept");b.setHeader("Access-Control-Allow-Methods","GET, PUT, POST, DELETE");app.locals.settings.StripeMode?(keyPublishable=app.locals.settings.StripekeyPublishable,keySecret=app.locals.settings.StripekeySecret):(keyPublishable=app.locals.settings.StripekeyPublishableTest,keySecret=app.locals.settings.StripekeySecretTest);if("OPTIONS"===a.method)return console.log("OPTIONS ",
a.body),c(),!1;app.locals.settings.StripeMode?(keyPublishable=app.locals.settings.StripekeyPublishable,keySecret=app.locals.settings.StripekeySecret):(keyPublishable=app.locals.settings.StripekeyPublishableTest,keySecret=app.locals.settings.StripekeySecretTest);stripe=require("stripe")(keySecret);Auth_helper.validate_session(a,function(a){200===a.status?c():b.redirect(307,"/checking_session")})});
account.get("/",function(a,b,c){console.log("req.url.replace('/','') ",a.url.replace("/",""));b.redirect(307,"/account/profile"+a.url.replace("/",""))}).post("/",function(a,b,c){console.log("------------------ req.url.replace('/','') ---------------------- ",a.url.replace("/",""));b.redirect(307,"/account/profile"+a.url.replace("/",""))}).get("/:page",function(a,b,c){Basket_controller.get(a,b,function(a){baskets=a.datas;c()})},function(a,b,c){Order_controller.get(a,b,function(a){200===a.status&&(orders=
a.datas);c()})},function(a,b,c){Userproducts_controller.get(a,b,function(a){userproducts=a.datas;c()})},function(a,b,c){b.render("account",{title:"User Account",user:a.session.Auth,locale:language_helper.getlocale(a),lang:lang,page:a.params.page,basket:baskets,orders:"undefined"!==typeof orders?orders:"",userproducts:"undefined"!==typeof userproducts?userproducts:"",keyPublishable:keyPublishable,_:_,js:["/public/javascripts/account.js","/node_modules/cropperjs/dist/cropper.min.js","/public/javascripts/components/formular.js",
"/node_modules/qrcode/build/qrcode.min.js","https://maps.googleapis.com/maps/api/js?key="+config.google.map],css:["/public/stylesheets/account.css","/public/stylesheets/ui.css","/node_modules/cropperjs/dist/cropper.min.css","/public/stylesheets/components/formular.css"]});b.end()}).get("/member/:member_id",function(a,b,c){Basket_controller.get(a,b,function(a){baskets=a.datas;c()})},function(a,b,c){Order_controller.get(a,b,function(a){orders=a.datas;c()})},function(a,b,c){b.render("account",{title:"User Account",
user:a.session.Auth,locale:language_helper.getlocale(a),lang:lang,page:"member",basket:baskets,keyPublishable:keyPublishable,member_infos:_.where(a.session.Auth.members,{_id:a.params.member_id})[0],_:_,js:["/public/javascripts/account.js","/node_modules/cropperjs/dist/cropper.min.js","/public/javascripts/components/formular.js","/node_modules/qrcode/build/qrcode.min.js","https://maps.googleapis.com/maps/api/js?key="+config.google.map],css:["/public/stylesheets/account.css","/public/stylesheets/ui.css",
"/node_modules/cropperjs/dist/cropper.min.css","/public/stylesheets/components/formular.css"]});b.end()}).get("/addresses/:address_id",function(a,b,c){Basket_controller.get(a,b,function(a){baskets=a.datas;c()})},function(a,b,c){Order_controller.get(a,b,function(a){orders=a.datas;c()})},function(a,b,c){baskets=e.datas;b.render("account",{title:"Edit address",user:a.session.Auth,locale:language_helper.getlocale(a),lang:lang,page:"addresses",basket:baskets,keyPublishable:keyPublishable,address_infos:_.where(a.session.Auth.address,
{_id:a.params.address_id})[0],_:_,js:["/public/javascripts/account.js","/node_modules/cropperjs/dist/cropper.min.js","/public/javascripts/components/formular.js","/node_modules/qrcode/build/qrcode.min.js","https://maps.googleapis.com/maps/api/js?key="+config.google.map],css:["/public/stylesheets/account.css","/public/stylesheets/ui.css","/node_modules/cropperjs/dist/cropper.min.css","/public/stylesheets/components/formular.css"]});b.end()}).post("/profile",function(a,b,c){Auth_model.update(a,a.session.Auth._id,
a.body,function(c){200===c.status?b.redirect(200,c.datas):b.redirect(307,"/account/"+a.url.replace("/","")+"?error_message="+c.message);b.end()})}).put("/profile",function(a,b,c){Auth_model.update(a,a.session.Auth._id,a.body,function(c){200===c.status?b.status(c.status).send(c.datas):b.status(c.status).send("/account/"+a.url.replace("/","")+"?error_message="+c.message);b.end()})});module.exports=account;
