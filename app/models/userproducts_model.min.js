var $jscomp={scope:{},findInternal:function(a,e,c){a instanceof String&&(a=String(a));for(var b=a.length,d=0;d<b;d++){var f=a[d];if(e.call(c,f,d,a))return{i:d,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,e,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[e]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,e,c,b){if(e){c=$jscomp.global;a=a.split(".");for(b=0;b<a.length-1;b++){var d=a[b];d in c||(c[d]={});c=c[d]}a=a[a.length-1];b=c[a];e=e(b);e!=b&&null!=e&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:e})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6-impl","es3");
var db=require("mongoose"),config=require("../config/config"),Orders_model=require("../models/orders_model"),Products_model=require("../models/products_model"),userproducts_datas={user_id:{type:"string"},product_id:{type:"string"},meta_datas:{type:"Object"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}},usershare_datas={user_id:{type:"string"},product_id:{type:"string"},share_name:{type:"string"},share_email:{type:"string"},share_message:{type:"string"},share_link:{type:"string"},
share_later:{type:"boolean","default":!1},share_date:{type:"Date"},share_sent:{type:"boolean","default":!1},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});var userproductsSchemas=new db.Schema(userproducts_datas),Userproducts=db.model("Userproducts",userproductsSchemas),usershareSchemas=new db.Schema(usershare_datas),Usershares=db.model("Usershares",usershareSchemas);
module.exports={attributes:userproducts_datas};
module.exports.get=function(a,e,c){var b={};"undefined"!==typeof a.session.Auth?b={user_id:a.session.Auth._id}:"undefined"!==typeof a.query.user_id?b={user_id:datas.user_id}:"undefined"!==typeof a.query.options&&(b={user_id:a.query.options.user_id});if("undefined"===typeof b.user_id)return c({status:401,datas:{message:"UNAUTHORISED_NEED_USER"}}),!1;"undefined"!==typeof a.query.product_id&&(b.product_id=a.query.product_id);a.user_id=b.user_id;this.checkOrders(a,e,function(a){Userproducts.find(b,function(a,
b){a?c({status:405,datas:a}):c({status:200,datas:b});return!1}).sort({created:-1})})};module.exports.allreadyBuy=function(a,e,c){Userproducts.findOne({user_id:a,product_id:e},function(a,d){a?c({status:404,message:"NEVER_BUY"}):null===d?c({status:404,message:"NEVER_BUY",datas:d}):c({status:200,message:"ALREADY_BUY",datas:d})})};
module.exports.checkOrders=function(a,e,c){var b=this;Orders_model.get(a,e,function(c){if(200===c.status)for(var d=0;d<c.datas.length;d++)for(var h=0;h<c.datas[d].basketdatas.products.length;h++)"undefined"!==typeof datas[d].refund?"charge_already_refunded"!==datas[d].refund.code&&"succeeded"!==typeof datas[d].refund.status||b.remove({user_id:a.user_id,product_id:c.datas[d].basketdatas.products[h].product_id},e,function(a){}):b.create({user_id:a.user_id,product_id:c.datas[d].basketdatas.products[h].product_id},
e,function(a){})});c({status:200,message:"CHECKING"})};module.exports.create=function(a,e,c){Userproducts.find({user_id:a.user_id,product_id:a.product_id},function(b,d){b||0===d.length?Products_model.get({product_id:a.product_id},e,function(b){new_userproduct=new Userproducts({user_id:a.user_id,product_id:a.product_id,meta_datas:b.datas[0]});new_userproduct.save(function(a,b){a?c({status:405,message:a}):c({status:200,datas:b})})}):c({status:201,datas:d,message:"ALREADY_ADDED_PRODUCT_ON_USER"})})};
module.exports.remove=function(a,e,c){Userproducts.deleteOne({user_id:a.user_id,product_id:a.product_id},function(a,d){a||0===d.length?c({status:401,err:a,message:"PRODUCT_DELETED_ERROR"}):c({status:201,datas:d,message:"PRODUCT_DELETED"})})};
module.exports.getShare=function(a,e,c){Usershares.find({share_email:a.params.user_email,product_id:a.params.product_id,_id:a.params.share_id},function(a,d){a?c({status:404,message:"UNKNOW_SHARE_CONTENT"}):0===d.length?c({status:404,message:"UNKNOW_SHARE_CONTENT"}):Products_model.get({product_id:d[0].product_id},e,function(a){c({status:200,datas:{share:d[0],product:a.datas[0]}})})})};
module.exports.shares_of_the_day=function(a,e,c){var b=new Date;Usershares.find({share_date:{$not:{$type:9}}},function(a,b){b.forEach(function(a,b){null===a.share_date&&(a.share_date=new Date);a.share_date=new Date(a.share_date);Usershares.update({_id:a._id},{$set:{share_date:a.share_date}},function(a,b){})})});Usershares.aggregate([{$project:{day:{$dayOfMonth:"$share_date"},month:{$month:"$share_date"},year:{$year:"$share_date"},user_id:"$user_id",product_id:"$product_id",share_name:"$share_name",
share_email:"$share_email",share_message:"$share_message",share_link:"$share_link",share_later:"$share_later",share_date:"$share_date",share_sent:"$share_sent",created:"$created",updated:"$updated"}},{$match:{day:b.getDate(),month:b.getMonth()+1,share_later:!0}}],function(b,f){if(b)c({status:500,message:"ERROR_OCCURED_REQUEST",err:b});else{var d=0,g=f.length,k=0;if(0===f.length)c({status:200,message:"NO_EMAILS_FOR_TODAY",shares:f});else{var l=require("../controllers/email_controller"),m=require("../controllers/auth_controller");
f.forEach(function(b,f){a.query.user={_id:b.user_id};m.getUserInfos(a,e,function(e){if(200===e.status){var f=e.user[0];(new Date(b.share_date)).toLocaleDateString("fr-FR",{month:"long",day:"numeric"});l.sendMaChansonEcard(a,{subject:"Bonjour "+b.share_name+", "+f.pseudo+" vous souhaite un joyeux anniversaire en chanson",title:"Bonjour "+b.share_name+", "+f.pseudo+" vous souhaite un joyeux anniversaire en chanson",name:b.share_name,friend:f.pseudo,friend_email:f.email,default_message:"Bonjour "+b.share_name+
",<br>votre ami(e) "+f.pseudo+" vous souhaite un joyeux anniversaire en chanson !",message:b.share_message,product_id:b.product_id,share_id:b._id,email:f.email,to:b.share_email},function(a){200===a.status&&(Usershares.update({_id:b._id},{$set:{share_sent:!0}},function(a,b){}),k++,l.send(null,{subject:"La chanson d'anniversaire personnalis\u00e9e pour "+b.share_name+" \u00e0 bien \u00e9t\u00e9 envoy\u00e9e",title:"La chanson d'anniversaire personnalis\u00e9e pour "+b.share_name+" \u00e0 bien \u00e9t\u00e9 envoy\u00e9e",
message:"Bonjour "+f.pseudo+"<br>Vous avez envoy\u00e9 une chanson d'anniversaire pour votre ami(e) "+b.share_name+".<br>Cet email confirme l'envoi de votre chanson sur l'adresse email de votre ami(e) : "+b.share_email+"<br>Voici votre message personnalis\u00e9 qui accompagnera la chanson :<br>"+b.share_message,email:"contact@joyvox.fr",share_id:b._id,to:f.email},function(a){}));d++;d===g-1&&c({status:200,message:"EMAILS_SENT",total:g,success:k})})}else d++,d===g-1&&c({status:200,message:"EMAILS_SENT",
total:g,success:k})})})}}})};
module.exports.share=function(a,e,c){var b=a.body.data;Userproducts.find({user_id:b.options.user_id,product_id:b.product_id},function(d,f){if(d)c({status:200,message:"ERROR_PRODUCT_GET",response_display:{title:"Erreur de partage",message:"Il semble que vous n'ayez pas achet\u00e9 le produit que vous souhaitez partager."}});else if(0===f.length)c({status:200,message:"UNKNOW_USER_PRODUCT",response_display:{title:"Erreur de Partage",message:"Il semble que vous n'ayez pas achet\u00e9 le produit que vous souhaitez partager."}});else{var h=
require("../controllers/email_controller"),g=require("../controllers/auth_controller");a.query.user={_id:b.options.user_id};g.getUserInfos(a,e,function(d){if(200===d.status){var e=d.user[0];new_shareproduct=new Usershares({user_id:d.user[0]._id,product_id:b.product_id,share_name:b.share_name,share_email:b.share_email,share_message:b.share_message,share_link:b.share_link,share_date:b.share_date?b.share_date:new Date,share_later:b.share_later});new_shareproduct.save(function(f,g){if(f)c({status:200,
datas:d.datas,response_display:{title:"Erreur de Partage",message:"Une erreur est survenue lors du partage de votre chanson personnalis\u00e9e, nous vous conseillons de la t\u00e9l\u00e9charger et de l'envoyer manuellement.<br>Il est possible que nous n'arrivions pas \u00e0 joindre la boite mail de votre ami(e)."}});else if("true"===b.share_later){var k=(new Date(b.share_date)).toLocaleDateString("fr-FR",{month:"long",day:"numeric"});h.send(null,{subject:"L'envoi de la chanson d'anniversaire personnalis\u00e9e pour "+
b.share_name+" \u00e0 bien \u00e9t\u00e9 configur\u00e9",title:"L'envoi de votre chanson d'anniversaire \u00e0 bien \u00e9t\u00e9 configur\u00e9",message:"Bonjour "+e.pseudo+"<br>Vous avez configur\u00e9 l'envoi d'une chanson d'anniversaire pour votre ami(e) "+b.share_name+" pour le "+k+".<br>Cet email confirme que l'email sera envoy\u00e9 \u00e0 9h00 ce jour pr\u00e9cis sur l'adresse email de votre ami(e) : "+b.share_email+"<br>Voici votre message personnalis\u00e9 qui accompagnera la chanson :<br>"+
b.share_message,email:"contact@joyvox.fr",share_id:g._id,to:e.email},function(a){c({status:200,datas:a.datas,response_display:{title:"Partager",message:"Le partage de la chanson d'anniversaire pour "+b.share_name+" a bien \u00e9t\u00e9 configur\u00e9e, elle sera envoy\u00e9 \u00e0 votre ami(e) sur son email "+b.share_email+" le "+k+" !"}})})}else h.sendMaChansonEcard(a,{subject:"Bonjour "+b.share_name+", "+e.pseudo+" vous souhaite un joyeux anniversaire en chanson",title:"Bonjour "+b.share_name+", "+
e.pseudo+" vous souhaite un joyeux anniversaire en chanson",default_message:"Bonjour "+b.share_name+",<br>votre ami(e) "+e.pseudo+" vous souhaite un joyeux anniversaire en chanson !",message:b.share_message,friend:e.pseudo,friend_email:e.email,product_id:b.product_id,share_id:g._id,email:e.email,to:b.share_email},function(a){200===a.status?h.send(null,{subject:"La chanson d'anniversaire personnalis\u00e9e pour "+b.share_name+" \u00e0 bien \u00e9t\u00e9 envoy\u00e9e",title:"La chanson d'anniversaire personnalis\u00e9e pour "+
b.share_name+" \u00e0 bien \u00e9t\u00e9 envoy\u00e9e",message:"Bonjour "+e.pseudo+"<br>Vous avez envoy\u00e9 une chanson d'anniversaire pour votre ami(e) "+b.share_name+".<br>Cet email confirme l'envoi de votre chanson sur l'adresse email de votre ami(e) : "+b.share_email+"<br>Voici votre message personnalis\u00e9 qui accompagnera la chanson :<br>"+b.share_message,email:"contact@joyvox.fr",share_id:g._id,to:e.email},function(a){c({status:200,datas:a.datas,response_display:{title:"Partager ma chanson",
message:"La chanson a bien \u00e9t\u00e9 envoy\u00e9e \u00e0 "+b.share_name+" sur son adresse email "+b.share_email+" !"}})}):c({status:203,datas:a.datas,response_display:{title:"Erreur de Partage",message:"Nous n'avons pas r\u00e9ussi \u00e0 envoyer la chanson \u00e0 votre ami(e)."}})})})}else c({status:203,datas:d.datas,response_display:{title:"Erreur de Partage",message:"Nous n'avons pas r\u00e9ussi \u00e0 vous authentifier pour cr\u00e9er l'envoi de votre chanson."}})})}})};
