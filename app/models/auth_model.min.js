function checkAvatarExist(e){var s=require("http");s.request({},function(t){return 404!=s.status?e:app.locals.settings.host+"/public/images/assets/account.svg"}).end()}const db=require("mongoose"),app=require("../app"),http=require("http"),sha1=require("sha1"),jwt=require("jsonwebtoken"),validator=require("email-validator"),Members_model=require("../models/members_model"),Address_model=require("../models/address_model"),Email_controller=require("../controllers/email_controller"),config=require("../config/config"),gravatar=require("gravatar"),urlExists=require("url-exists"),user_datas={email:{type:"string",unique:!0},password:{type:"string"},pseudo:{type:"string"},firstName:{type:"string"},avatar:{type:"string"},lastName:{type:"string"},phone:{type:"string"},mobile:{type:"string"},token:{type:"string"},validation_code:{type:"string"},secret:{type:"string"},qrcode:{type:"Object"},birthDate:{type:"Date"},gender:{type:"string",enum:["undefined","male","female"],defaults:"undefined"},address:{type:"Array"},friends:{type:"Array"},relations:{type:"Array"},apps:{type:"Array"},tags:{type:"Object"},authorized_apps:{type:"Object"},facebook:{id:{type:"string"},name:{type:"string"},email:{type:"string"},likes:{type:"array"},friends:{type:"array"},pages:{type:"array"},shared:{type:"boolean"},accessToken:{type:"string"}},devices:{uid:"string",name:"string",arch:"string",appCodeName:"string",appName:"string",appVersion:"string",userAgent:"string",vendor:"string",last_connexion:"string",token:"string",ua_parser:{type:"Object"}},termAccept:{type:"Boolean"},newsletter:{type:"Boolean"},newsletter_services:{type:"Object"},sms:{type:"Boolean"},sms_services:{type:"Object"},notifications:{type:"Boolean"},notifications_services:{type:"Object"},rights:{type:"Object"},validated:{type:"Boolean"},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now},public_locale:{type:"Boolean"},public_profile:{type:"Boolean"},public_kids:{type:"Boolean"},public_created:{type:"Boolean"},public_gamification:{type:"Boolean"},public_interest:{type:"Boolean"}},machineId=require("node-machine-id"),ua_parser=require("ua-parser-js");var device_uid=machineId.machineIdSync({original:!0});0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const userSchemas=new db.Schema(user_datas),User=db.model("User",userSchemas);db.connection.on("open",function(e){}),db.connection.on("error",function(e){}),User.collection.dropIndexes(),module.exports={attributes:user_datas},module.exports.getCount=function(){return User.find({}).count()},module.exports.getActive=function(){return User.find({updated:{$gte:new Date(ISODate().getTime()-2592e5)}}).count()},module.exports.get=function(e,s,t){device_uid=e.query.device_uid;var a=this;User.find({},function(e,s){t(e?{status:304,code:e.code,error:e,message:e.message}:{status:200,users:s,total:a.getCount()})}).skip(50*parseInt(s.page)).limit(50)},module.exports.getUserInfos=function(e,s,t){void 0!==e.query.user&&""!==e.query.user||t({status:304,datas:{message:"NEED_USER"}}),User.find({_id:e.query.user._id},function(e,s){t(e?{status:304,code:e.code,error:e,message:"NEED_USER"}:{status:200,user:s})})},module.exports.deleteDevice=function(e,s,t){User.update({_id:s.user_id},{$pull:{devices:{uid:e.query.device_uid}}},function(e,s){t(errr?{status:403,message:"DEVICE_DELETE_ERROR"}:{status:200,message:"DEVICE_DELETE_SUCCESS"})})},module.exports.login=function(e,s,t){var a=null;void 0===e.query.remember_me||(void 0!==e.query.device_infos?(device_uid=e.query.device_infos.device_uid,a={uid:device_uid,appCodeName:e.query.device_infos.appCodeName,appName:e.query.device_infos.appName,appVersion:e.query.device_infos.appVersion,userAgent:e.query.device_infos.userAgent,vendor:e.query.device_infos.vendor,last_connexion:Date.now(),ua_parser:ua_parser(e.query.device_infos.userAgent)}):void 0!==e.query.device_uid&&(device_uid=e.query.device_uid,a={uid:device_uid,appCodeName:e.query.appCodeName,appName:e.query.appName,appVersion:e.query.appVersion,userAgent:e.query.userAgent,vendor:e.query.vendor,last_connexion:Date.now(),ua_parser:ua_parser(e.query.userAgent)}));var i=this;return s.password?validator.validate(s.email)?User.find({email:s.email,password:sha1(s.password)},function(r,o){if(r)t({status:"error",code:r.code,error:r,message:r.message});else{if(0===o.length)return User.find({email:s.email},function(e,s){t(e?{status:400,code:11,error:e,message:"USER_WRONG_EMAIL"}:0===s.length?{status:400,code:11,error:e,message:"USER_WRONG_EMAIL",email_valid:s.length}:{status:400,code:13,error:e,message:"USER_WRONG_PASSWORD",email_valid:s.length})}),!1;var n=jwt.sign({secret:o[0].secret},config.secrets.global.secret,{expiresIn:"2 days"});void 0!==e.query.remember_me&&(a.token=n,User.find({_id:o[0]._id,devices:{$elemMatch:{uid:device_uid}}},function(e,s){e?User.update({_id:o[0]._id},{$push:{devices:a}},function(e,s){e?console.log("impossible d insérer le new_device ",e):console.log("new_device ajouté success ",a)}):0===s.length?User.update({_id:o[0]._id},{$push:{devices:a}},function(e,s){e?console.log("impossible d insérer le new_device ",e):console.log("new_device ajouté success ",a)}):User.update({id:o[0]._id,devices:{$elemMatch:{uid:device_uid}}},{$set:{token:n},device:{$set:a}},function(e,s){e?console.log("update device token error ",e):console.log("update device token success ",s)},!0)}));var d=o[0].avatar;d=""===o[0].avatar||null==o[0].avatar?""===s.avatar||null==s.avatar||void 0===s.avatar?gravatar.url(o[0].email,{s:"200",r:"pg",d:"404"}).replace("//","http://"):s.avatar:o[0].avatar,urlExists(d,function(s,a){a||(d=app.locals.settings.host+"/public/images/assets/account.svg"),User.update({_id:o[0]._id},{$set:{token:n,updated:Date.now(),avatar:d}},function(s,a){s?t({status:400,code:s.code,error:s,message:"USER_LOGIN_ERROR"}):i.reset_session(e,o[0]._id,function(e){e.avatar=e.avatar,t({status:200,message:"USER_LOGIN_SUCCESS",idkids_user:e})})})})}}):t({status:400,message:"USER_WRONG_EMAIL"}):t({status:400,message:"USER_LOGIN_ERROR"}),s},module.exports.logout=function(e,s,t){void 0!==e.session.Auth&&e.session.destroy(),t({status:200,datas:{message:"SESSION_DELETED"}})},module.exports.register=function(e,s){if(void 0===e.body)return!1;if(void 0===e.body.subscribe_password)return!1;var t=sha1(e.body.subscribe_password);db.connect(config.database.users,{useMongoClient:!0});var a=this,i={email:e.body.subscribe_email,password:t,pseudo:e.body.pseudo,secret:jwt.sign({},config.secrets.global.secret,{},{expiresIn:"2 days"}),termAccept:!0,rights:{type:"R",authorizations:["me"]}};if(i.token=jwt.sign({secret:i.secret},config.secrets.global.secret,{expiresIn:"2 days"}),i.device=[{uid:device_uid,token:jwt.sign({secret:i.secret},config.secrets.global.secret,{expiresIn:"2 days"}),avatar:gravatar.url(e.body.subscribe_email,{s:"200",r:"pg",d:"404"},!0).replace("//","http://")}],e.body.subscribe_newsletter){if(i.newsletter=!0,i.newsletter_services={},void 0!==app.locals&&void 0!==app.locals.applications)for(var r=0;r<app.locals.applications.length;r++)e.body["newsletter_"+app.locals.applications[r].short_name]&&(i.newsletter_services[app.locals.applications[r].short_name]=1)}else i.newsletter=!1,i.newsletter_services={};new_user=new User(i),new_user.save(function(t,i){t?s({status:400,message:"SUBSCRIBE_EMAIL_EXIST",err:t}):a.reset_session(e,i._id,function(e){s({status:200,user:i})})})},module.exports.lost_password=function(e,s,t){"unefined"==typeof e.body.email&&t({status:403,message:"UNKNOW_USER_EMAIL"});var a=this;User.findOne({email:e.body.email},function(s,i){s?t({status:403,datas:{message:s}}):null===i?t({status:403,message:"UNKNOW_USER_EMAIL"}):a.getValidationCode(i._id,function(s){200===s.status?Email_controller.lost_password(e,s,function(e){console.log("----------------------- "),console.log(e),console.log("----------------------- "),t({status:e.status,response_display:{message:"REQUEST_PASSWORD_MESSAGE",title:"REQUEST_PASSWORD_TITLE"},message:"PASSWORD_SENDED"})}):t({status:s.status,datas:s})})})},module.exports.unregister=function(e,s,t){return User.remove({_id:e.body.id},function(){t({status:200,message:"USER_DELETED",infos:e.body})}),e.body},module.exports.update=function(e,s,t,a){device_uid=e.body.device_uid;var i=this;t.updated=Date.now(),void 0!==t.birthDate&&(t.birthDate=t.birthDate),User.update({_id:s},{$set:t},function(t,r){t?a({status:401,message:"CANT_UPDATE_TOKEN",datas:t}):i.reset_session(e,s,function(){a({status:200,message:"TOKEN_UPDATED",datas:r,response_display:{title:"Mis à jour",message:"Votre profil vient d'être mis à jour."}})})},!0)},module.exports.updatePassword=function(e,s,t){User.update({email:e.email},{$set:{password:sha1(e.password)}},function(e,s){t(e?{status:401,message:"CANT_UPDATE_PASSWORD",error:e}:{status:200,message:"PASSWORD_UPDATED",infos:s})})},module.exports.check_user_session=function(e,s){},module.exports.check_user=function(e,s){device_uid=e.device_infos.device_uid;var t=jwt.sign({secret:e.options.user_secret},config.secrets.global.secret,{expiresIn:"2 days"});jwt.verify(e.options.user_token,config.secrets.global.secret,function(a,i){a?s({status:203,message:"UNAUTHORISED_TOKEN",response_display:{title:"Session invalide",message:"Vous n'êtes plus connecté.<br>veuillez vous reconnecter."},datas:a}):User.find({_id:e.options.user_id,token:e.options.user_token},function(a,i){a?s({status:203,message:"UNAUTHORISED_TOKEN",datas:a,response_display:{title:"Session invalide",message:"Vous n'êtes plus connecté.<br>veuillez vous reconnecter."}}):0===i.length?s({status:203,message:"UNAUTHORISED",response_display:{title:"Session invalide",message:"Vous n'êtes plus connecté.<br>veuillez vous reconnecter."}}):jwt.verify(e.options.user_token,config.secrets.global.secret,function(a,r){a?User.update({id:e.options.user_id},{$set:{token:t,updated:Date.now()}},function(e,a){s(e?{status:401,message:"CANT_UPDATE_TOKEN",datas:e}:{status:200,message:"TOKEN_UPDATED",datas:i,updated_token:t})},!0):s({status:200,message:"TOKEN_UPDATED",datas:i})})})})},module.exports.checking_session=function(e,s,t){var a=this;User.findOne({_id:e.query._id,token:e.query.token,secret:e.query.secret},function(s,i){s?t({status:401,code:s.code,error:s,message:s.message}):a.reset_session(e,e.query._id,t)})},module.exports.reset_session=function(e,s,t){User.findOne({_id:s},function(a,i){a?t({status:401,code:a.code,error:a,message:a.message}):(user_infos=JSON.parse(JSON.stringify(i)),user_infos.current_device=device_uid,Members_model.get(s,null,function(a){user_infos.members=a.datas,Address_model.get(s,null,function(s){user_infos.address=s.datas,e.session.Auth=user_infos,t({status:200,message:"SESSION_UPDATED",datas:user_infos})})}))})},module.exports.getPublicProfile=function(e,s){this.getFullUser(e,function(e){if(200===e.status){var t={_id:e.datas._id,pseudo:e.datas.pseudo,email:e.datas.email,avatar:e.datas.avatar,created:e.datas.created,updated:e.datas.updated};s({status:e.status,message:e.message,datas:t})}else s(e)})},module.exports.getServices=function(e,s){this.getFullUser(e,function(e){if(200===e.status){e.datas.is_newsletter,e.datas.newsletter_services;s({status:e.status,message:e.message,datas:e.datas.public_services})}else s(e)})},module.exports.getFullUser=function(e,s){User.findOne({_id:e},function(t,a){t?s({status:401,message:"UNAUTHORISED_TOKEN",datas:t}):null!==a?Members_model.get(e,null,function(e){a.members=e.datas,s({status:200,message:"success me",datas:a})}):s({status:404,message:"USER_NOT_FOUND",datas:a})})},module.exports.getValidationCode=function(e,s){User.findOne({_id:e},function(e,t){if(e)s({status:401,message:"UNAUTHORISED_TOKEN",datas:e});else if(null!==t){var a=jwt.sign({secret:t.secret},config.secrets.global.secret,{expiresIn:"2 days"});User.update({_id:t._id},{$set:{validation_code:a}},function(e,i){e?console.log("impossible de mettre à jour le code de validation ",e):s({status:200,validation_code:a,email:t.email,pseudo:t.pseudo,avatar:t.avatar})})}else s({status:304,message:"USER_NOT_FOUND",datas:t})})},module.exports.validCode=function(e,s){User.findOne({email:e.email,validation_code:e.validation_code},function(e,t){s(e||null===t?{status:304,message:"INVALID_CODE",datas:e}:{status:200,message:"CODE_VALID",datas:t})})},module.exports.validAccount=function(e,s){User.findOne({email:e.email,validation_code:e.validation_code},function(e,t){e||null===t?s({status:304,message:"UNAUTHORISED_TOKEN",datas:e}):User.update({_id:t._id},{$set:{validated:!0,certified:!0}},function(e,t){s(e?{status:304,message:"UNAUTHORISED_TOKEN",datas:e}:{status:200,message:"USER_VALIDATED",datas:t})})})},module.exports.getUsersDevice=function(e,s){User.find({devices:{$elemMatch:{uid:e}}},{email:1,avatar:1,pseudo:1},function(e,t){s(e||0===t.length?{status:304,message:"NEW_DEVICE",datas:e}:{status:200,message:"liste des utilisateurs ayant utilisé ce device",users_device:t})})},module.exports.deleteDevice=function(e,s){var t=this;e.query.device_uid;User.update({_id:e.session.Auth._id},{$pull:{devices:{uid:e.body.uid}}},function(a,i){a||0===i.length?s({status:304,message:"DEVICE_DELETE_ERROR",datas:a}):t.reset_session(e,e.session.Auth._id,function(e){e.avatar=e.avatar,s({status:200,message:"DEVICE_DELETE_SUCCESS",idkids_user:e})})})},user_datas.getAge=function(){return this.birthDate};