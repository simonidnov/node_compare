var express=require("express"),_=require("underscore"),account=express.Router(),Auth_model=require("../models/auth_model"),Auth_helper=require("../helpers/auth_helper"),language_helper=require("../helpers/languages_helper"),uri_helper=require("../helpers/uri_helper"),lang=require("../public/languages/auth_lang");account.use(function(e,t,a){t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),t.setHeader("Access-Control-Allow-Methods","GET, PUT, POST, DELETE"),Auth_helper.validate_session(e,function(e){200===e.status?a():t.redirect(301,"/auth")})}),account.get("/",function(e,t,a){t.redirect(307,"/account/profile"+e.url.replace("/",""))}).get("/:page",function(e,t,a){t.render("account",{title:"User Account",user:e.session.Auth,locale:language_helper.getlocale(),lang:lang,page:e.params.page,js:["/public/javascripts/account.js","/public/javascripts/components/formular.js","/node_modules/qrcode/build/qrcode.min.js"],css:["/public/stylesheets/account.css","/public/stylesheets/components/formular.css"]})}).get("/:page/:member_id",function(e,t,a){t.render("account",{title:"User Account",user:e.session.Auth,locale:language_helper.getlocale(),lang:lang,page:e.params.page,member_infos:_.where(e.session.Auth.members,{_id:e.params.member_id})[0],js:["/public/javascripts/account.js","/public/javascripts/components/formular.js","/node_modules/qrcode/build/qrcode.min.js"],css:["/public/stylesheets/account.css","/public/stylesheets/components/formular.css"]})}).post("/profile",function(e,t,a){Auth_model.update(e,e.session.Auth._id,e.body,function(a){200===a.status?t.redirect(301,"/account/"+e.url.replace("/","")):t.redirect(307,"/account/"+e.url.replace("/","")+"?error_message="+a.message)})}),module.exports=account;