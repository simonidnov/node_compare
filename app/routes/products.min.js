var express=require("express"),Mime=require("mime"),path=require("path"),crypto=require("crypto"),product=express.Router(),Products_controller=require("../controllers/products_controller"),Auth_helper=require("../helpers/auth_helper"),language_helper=require("../helpers/languages_helper"),uri_helper=require("../helpers/uri_helper"),lang=require("../public/languages/auth_lang"),multer=require("multer"),storage=multer.diskStorage({destination:function(a,b,c){c(null,"./uploads/")},filename:function(a,
b,c){crypto.pseudoRandomBytes(16,function(a,e){c(null,e.toString("hex")+Date.now()+"."+Mime.getExtension(b.mimetype))})}}),upload=multer({storage:storage,dest:"./uploads/",inMemory:!0,includeEmptyFields:!0});
product.use(function(a,b,c){b.setHeader("Access-Control-Allow-Origin","*");b.setHeader("Access-Control-Allow-Methods","GET,PUT,POST,DELETE,OPTIONS");b.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization, Content-Length, X-Requested-With");b.setHeader("Content-Type","application/json");c()});
product.get("/",function(a,b,c){Products_controller.get(a.query,b,function(a){b.status(a.status).send(a.datas)})}).get("/updatephonetik",function(a,b,c){Products_controller.updatePhonetik(a,b,function(a){b.status(a.status).send(a.datas)})}).get("/deleteallproducts",function(a,b,c){Products_controller.deleteAllProducts(a,b,function(a){b.status(a.status).send(a.datas)})}).post("/",function(a,b,c){Auth_helper.validate_admin(a,function(d){200===d.status?Products_controller.create(a.body,b,function(a){b.status(a.status).send(a.datas)}):
b.redirect(301,"/auth?message=NO_ACCESS_RIGHTS")})}).put("/",function(a,b,c){Auth_helper.validate_admin(a,function(d){200===d.status?Products_controller.update(a,b,function(a){b.status(a.status).send(a.datas)}):b.redirect(301,"/auth?message=NO_ACCESS_RIGHTS")})})["delete"]("/",function(a,b,c){Auth_helper.validate_admin(a,function(d){200===d.status?Products_controller["delete"](a.body,b,function(a){b.status(a.status).send(a.datas)}):b.redirect(301,"/auth?message=NO_ACCESS_RIGHTS")})}).get("/medias/:filename",
function(a,b,c){Auth_helper.has_media_right(a,function(a){200===a.status&&c()});require("fs").existsSync("./uploads/"+a.params.filename.replace(".mp3","_shortcut15.mp3"))?(a.params.filename=a.params.filename.replace(".mp3","_shortcut15.mp3"),c()):require("fluent-ffmpeg")("./uploads/"+a.params.filename).duration(15).toFormat("mp3").on("error",function(a){console.log("An error occurred: "+a.message);b.status("400").send(a)}).on("progress",function(a){console.log("Processing: "+a.targetSize+" KB converted")}).on("end",
function(){console.log("Processing finished !");a.params.filename=a.params.filename.replace(".mp3","_shortcut15.mp3");setTimeout(function(){c()},500)}).save("./uploads/"+a.params.filename.replace(".mp3","_shortcut15.mp3"))},function(a,b,c){b.sendFile(a.params.filename,{root:path.join(__dirname,"../uploads")},function(a){a?console.log("errror ",a):console.log("success ")})}).post("/medias",upload.single("file"),function(a,b,c){Auth_helper.validate_admin(a,function(c){200===c.status?Products_controller.addFile(a,
a.file,function(a){b.status(a.status).send(a.datas)}):b.status(403).send({message:"Vous n'avez pas les droits n\u00e9c\u00e9ssaires pour uploader des fichiers"})})})["delete"]("/medias",function(a,b,c){Auth_helper.validate_admin(a,function(c){200===c.status?Products_controller.removeFile(a,b,function(a){b.status(a.status).send(a.datas)}):b.status(403).send({message:"Vous n'avez pas les droits n\u00e9c\u00e9ssaires pour uploader des fichiers"})})}).post("/importFromFiles",upload.single("file"),function(a,
b,c){Auth_helper.validate_admin(a,function(c){200===c.status?Products_controller.createProductFromFileName(a,a.file,function(a){b.status(a.status).send(a.datas)}):b.status(403).send({message:"Vous n'avez pas les droits n\u00e9c\u00e9ssaires pour uploader des fichiers"})})});module.exports=product;
