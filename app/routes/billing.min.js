var express=require("express"),billing=express.Router(),Orders_controller=require("../controllers/orders_controller"),Auth_helper=require("../helpers/auth_helper"),Address_controller=require("../controllers/address_controller"),language_helper=require("../helpers/languages_helper"),uri_helper=require("../helpers/uri_helper"),lang=require("../public/languages/auth_lang");
billing.use(function(a,b,c){b.setHeader("Access-Control-Allow-Origin","*");b.setHeader("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept");b.setHeader("Access-Control-Allow-Methods","GET, PUT, POST, DELETE");b.setHeader("Content-type","text/html");Auth_helper.validate_admin(a,function(b){200===b.status?(a.body.isAdmin=!0,a.query.isAdmin=!0):(a.body.isAdmin=!1,a.query.isAdmin=!1)});Auth_helper.validate_session(a,function(a){200===a.status?c():b.status(a.status).send(a.datas)})});
billing.get("/",function(a,b,c){b.status(304).send({message:"UNAUTHORISED"})}).get("/:bill_id",function(a,b,c){c()},function(a,b,c){b=a.session.Auth._id;"undefined"!==typeof a.query.current_user_id&&a.query.isAdmin&&(b=a.query.current_user_id);Orders_controller.getBill(b,{_id:a.params.bill_id},function(b){a.bill=b;"undefined"!==typeof a.bill.datas.metadata.address_id&&null!==a.bill.datas.metadata.address_id&&""!==a.bill.datas.metadata.address_id?Address_controller.getById(a.bill.datas.metadata.address_id,
function(b){200===b.status&&(a.bill.datas.address=b.datas);c()}):c()})},function(a,b,c){b.render("bill",{title:"Ma facture "+a.bill.bill_number,user:a.session.Auth,locale:language_helper.getlocale(a),lang:lang,order:a.bill,js:[],css:["/public/stylesheets/billing.css"]},function(c,f){var e=require("fs"),g=require("html-pdf"),d="/uploads/facture-"+a.bill.datas.bill_number+".pdf";g.create(f,{format:"Letter"}).toStream(function(a,c){if(a)return console.log(a);c.pipe(e.createWriteStream("."+d));setTimeout(function(){b.status(200).redirect(d)},
100);setTimeout(function(){e.unlink("."+d,function(a,b){if(a)throw a;})},2E4)})})});module.exports=billing;
