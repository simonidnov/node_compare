var $jscomp={scope:{},findInternal:function(a,e,b){a instanceof String&&(a=String(a));for(var d=a.length,c=0;c<d;c++){var f=a[c];if(e.call(b,f,c,a))return{i:c,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,e,b){if(b.get||b.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[e]=b.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,e,b,d){if(e){b=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var c=a[d];c in b||(b[c]={});b=b[c]}a=a[a.length-1];d=b[a];e=e(d);e!=d&&null!=e&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:e})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6-impl","es3");
var db=require("mongoose"),config=require("../config/config"),_=require("underscore"),Users_model=require("../models/auth_model"),await=require("await"),comments_datas={label:{type:"string"},description:{type:"string"},content:{type:"string"},user_id:{type:"string"},is_response:{type:"bool"},comment_id:{type:"string"},page_url:{type:"string"},stars:{type:"Number"},is_valid:{type:"bool"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}};
0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});var commentsSchemas=new db.Schema(comments_datas),Comments=db.model("Comments",commentsSchemas);Comments.collection.dropIndexes();module.exports={attributes:comments_datas};
module.exports.get=function(a,e,b){"undefined"===typeof a.query.page_url&&b({status:405,messsage:"need page url"});Comments.find({page_url:a.query.page_url}).sort({updated:-1}).limit(50).exec(function(a,c){if(a)b({status:405,datas:a});else{var d=[];c.forEach(function(a){Users_model.getPublicProfile(a.user_id,function(b){d.push({_id:a._id,label:a.label,page_url:a.page_url,content:a.content,stars:a.stars,user_id:a.user_id,created:a.created,updated:a.updated,user_infos:b.datas})})});setTimeout(function(){var a=
_.sortBy(d,function(a){return-(new Date(a.created)).getTime()});b({status:200,datas:a})},500)}})};
module.exports.getStats=function(a,e,b){"undefined"===typeof a.query.page_url&&b({status:405,messsage:"need page url"});Comments.aggregate([{$match:{page_url:a.query.page_url}},{$group:{_id:"$page_url",count:{$sum:1},stars:{$sum:{$multiply:["$stars",1]}}}}],function(d,c){console.log("err :::: ",d);console.log("infos ::::: ",c);d?b({status:405,datas:d}):(0===c.length?c=[{count:0,stars:0,_id:a.query.page_url}]:"undefined"===typeof c[0].count&&(c=[{count:0,stars:0,_id:a.query.page_url}]),b({status:200,
datas:c}))})};
module.exports.create=function(a,e,b){console.log("req.body ===== ",a.body);"undefined"!==typeof a.body.data&&(a.body=a.body.data);"undefined"===typeof a.body&&b({status:203,datas:{message:"METHOD NOT ALLOWED"}});"undefined"===typeof a.body.label&&b({status:203,datas:{message:"NEED_LABEL"}});"undefined"===typeof a.body.page_url&&b({status:203,datas:{message:"NEED_PAGE_URL"}});"undefined"===typeof a.body.content&&b({status:203,datas:{message:"NEED_CONTENT"}});"undefined"===typeof a.body.stars&&b({status:203,
datas:{message:"NEED_STARS"}});"undefined"===typeof a.body.options.user_id&&b({status:203,datas:{message:"NEED_USER_ID"}});new_comment=new Comments({label:a.body.label,page_url:a.body.page_url,content:a.body.content,stars:a.body.stars,user_id:a.body.options.user_id});new_comment.save(function(a,c){a?b({status:400,datas:{message:a}}):b({status:200,datas:c})})};
module.exports.update=function(a,e,b){delete datas.options;delete datas._id;datas.updated=Date.now();Comments.updateOne({_id:comment_id,user_id:user_id},{$set:datas},function(a,c){a?b({status:304,message:a}):b({status:200,pages:c})})};module.exports["delete"]=function(a,e,b){Comments.deleteOne({_id:a.body.comment_id,user_id:a.body.options.user_id},function(a,c){a?b({status:405,message:a}):b({status:200,datas:c})})};
