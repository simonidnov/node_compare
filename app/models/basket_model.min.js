var $jscomp={scope:{},findInternal:function(a,b,d){a instanceof String&&(a=String(a));for(var c=a.length,e=0;e<c;e++){var f=a[e];if(b.call(d,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,d){if(d.get||d.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=d.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,d,c){if(b){d=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var e=a[c];e in d||(d[e]={});d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,d){return $jscomp.findInternal(this,a,d).v}},"es6-impl","es3");
var db=require("mongoose"),products_controller=require("../controllers/products_controller"),config=require("../config/config"),_=require("underscore"),basket_datas={user_id:{type:"string"},products:{type:[],datas:{_id:{type:"Schema.ObjectId"},product_id:{type:"string",unique:!0},quantity:{type:"number","default":1},datas:{type:[]},price:{type:"Number"},total:{type:"Number"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}}},total:{type:"number","default":0},created:{type:"Date",
"default":Date.now},updated:{type:"Date","default":Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});var basketSchemas=new db.Schema(basket_datas),Baskets=db.model("Baskets",basketSchemas);module.exports={attributes:basket_datas};
module.exports.get=function(a,b,d){var c={};if(a.isAdmin&&"undefined"!==typeof a.basket_id)c={_id:a.basket_id};else if("undefined"!==typeof a.options)"undefined"!==typeof a.options.user_id&&(c={user_id:a.options.user_id});else if("undefined"!==typeof b.session.Auth)c={user_id:b.session.Auth._id};else if("undefined"!==typeof a.user_id)c={user_id:a.user_id};else return d({status:401,message:"NOT_LOGGED_IN"}),!1;Baskets.find(c,function(a,c){a?d({status:401,datas:a}):(0===c.length&&d({status:200,datas:c}),
c.forEach(function(a){var e=a.total_amount=0;0<a.products.length?a.products.forEach(function(g){products_controller.get({product_id:g.product_id},b,function(b){0===b.datas.length?g.infos={label:"DOSNT_EXIST",message:"PRODUIT_INTROUVABLE_OU_SUPPRIME"}:(g.infos=b.datas[0],a.total_amount+=g.price*("undefined"!==typeof g.quantity?g.quantity:1));e++;e>=a.products.length&&d({status:200,datas:c})})}):d({status:200,datas:c})}))})};
module.exports.getAmount=function(a,b,d){var c={};if(a.isAdmin&&"undefined"!==typeof a.basket_id)c={_id:a.basket_id};else if("undefined"!==typeof a.options)"undefined"!==typeof a.options.user_id&&(c={user_id:a.options.user_id});else if("undefined"!==typeof b.session.Auth)c={user_id:b.session.Auth._id};else if("undefined"!==typeof a.user_id)c={user_id:a.user_id};else return d({status:401,message:"NOT_LOGGED_IN"}),!1;Baskets.find(c,function(c,f){c?d({status:401,datas:c}):(0===f.length&&d({status:200,
datas:f}),f.forEach(function(c){var e=c.total_amount=0;0<c.products.length?c.products.forEach(function(g){products_controller.get({product_id:g.product_id},b,function(b){0===b.datas.length?g.infos={label:"DOSNT_EXIST",message:"PRODUIT_INTROUVABLE_OU_SUPPRIME"}:(g.infos=b.datas[0],c.total_amount+=g.price*("undefined"!==typeof g.quantity?g.quantity:1));e++;b={amount:c.total_amount,new_amount:c.total_amount,reduction:0,reduced_amount:0,dif_amount:0};for(var f=0;f<a.coupon_code.length;f++)b.reduction=
parseInt(b.reduction)+parseInt(a.coupon_code[f].amount);b.reduced_amount=c.total_amount-b.reduction;b.new_amount=b.reduced_amount;0>b.reduced_amount&&(b.new_amount=0,b.dif_amount=Math.abs(b.reduction-c.total_amount),b.wallet_infos=a.coupon_code[0],b.wallet_infos.amount=b.dif_amount);e>=c.products.length&&d({status:200,datas:b})})}):d({status:200,datas:f})}))})};
module.exports.create=function(a,b,d){var c=this,e=null;products_controller.get(a,b,function(f){if(200===f.status){e=f.datas[0];if("undefined"===typeof a.options.user_id)return d({status:405,message:"user not defined"}),!1;c.get(a,b,function(c){if(200===c.status&&0<c.datas.length){if(c=c.datas[0],"undefined"!==typeof a.product_id){var b=_.where(c.products,{product_id:a.product_id});0<b.length?(b=b[0],b.quantity=1,b.total=parseFloat(b.price)*parseInt(b.quantity),b.updated=Date.now()):c.products.push({product_id:a.product_id,
datas:a.datas,price:e.price,total:(parseFloat(e.price)*parseInt(a.quantity)).toFixed(2),created:Date.now(),updated:Date.now()});c.updated=Date.now();Baskets.updateOne({_id:c._id},{$set:c},function(a,c){a?d({status:405,message:a}):d({status:200,datas:c})})}}else c={user_id:a.options.user_id,products:[{product_id:a.product_id,quantity:1,datas:a.datas,price:e.price,total:(parseFloat(e.price)*parseFloat(a.quantity)).toFixed(2),created:Date.now(),updated:Date.now()}],total:(parseFloat(e.price)*parseFloat(a.quantity)).toFixed(2),
created:Date.now(),updated:Date.now()},new_basket=new Baskets(c),new_basket.save(function(a,c){a?d({status:405,datas:{message:"ERROR",infos:a}}):d({status:200,datas:c})})})}else d(f)})};module.exports.update=function(a,b,d){delete datas.options;delete datas._id;datas.updated=Date.now();Baskets.updateOne({_id:a.body._id},{$set:datas},function(a,b){a?d({status:405,datas:a}):d({status:200,datas:b})})};module.exports.deleteUserBasket=function(a,b){Baskets.deleteOne({user_id:a},function(a){b(a)})};
module.exports["delete"]=function(a,b,d){"undefined"!==typeof a.body.product_id&&console.log("req.body.product_id ",a.body.product_id);"undefined"!==typeof a.body.basket_id&&console.log("req.body.basket_id ",a.body.basket_id);Baskets.update({_id:a.body.basket_id},{$pull:{products:{product_id:a.body.product_id}}},function(a,b){a?d({status:400,datas:{message:a}}):d({status:200,datas:b})})};
