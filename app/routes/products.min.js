var express=require("express"),Mime=require("mime"),path=require("path"),crypto=require("crypto"),product=express.Router(),Products_controller=require("../controllers/products_controller"),Auth_helper=require("../helpers/auth_helper"),language_helper=require("../helpers/languages_helper"),uri_helper=require("../helpers/uri_helper"),lang=require("../public/languages/auth_lang"),multer=require("multer"),storage=multer.diskStorage({destination:function(e,t,s){s(null,"./uploads/")},filename:function(e,t,s){crypto.pseudoRandomBytes(16,function(e,o){s(null,o.toString("hex")+Date.now()+"."+Mime.getExtension(t.mimetype))})}}),upload=multer({storage:storage,dest:"./uploads/",inMemory:!0,includeEmptyFields:!0});product.use(function(e,t,s){t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET,PUT,POST,DELETE,OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization, Content-Length, X-Requested-With"),t.setHeader("Content-Type","application/json"),s()}),product.get("/",function(e,t,s){Products_controller.get(e.query,t,function(e){t.status(e.status).send(e.datas)})}).get("/update_amount",function(e,t,s){Products_controller.updateAmount(e,t,function(e){t.status(e.status).send(e.datas)})}).get("/updatephonetik",function(e,t,s){Products_controller.updatePhonetik(e,t,function(e){t.status(e.status).send(e.datas)})}).get("/deleteallproducts",function(e,t,s){Products_controller.deleteAllProducts(e,t,function(e){t.status(e.status).send(e.datas)})}).post("/",function(e,t,s){Auth_helper.validate_admin(e,function(s){200===s.status?Products_controller.create(e.body,t,function(e){t.status(e.status).send(e.datas)}):t.redirect(307,"/auth?message=NO_ACCESS_RIGHTS")})}).put("/",function(e,t,s){Auth_helper.validate_admin(e,function(s){200===s.status?Products_controller.update(e,t,function(e){t.status(e.status).send(e.datas)}):t.redirect(307,"/auth?message=NO_ACCESS_RIGHTS")})}).delete("/",function(e,t,s){Auth_helper.validate_admin(e,function(s){200===s.status?Products_controller.delete(e.body,t,function(e){t.status(e.status).send(e.datas)}):t.redirect(307,"/auth?message=NO_ACCESS_RIGHTS")})}).get("/medias/:filename",function(e,t,s){var o=require("fs");if(o.existsSync("./uploads/"+e.params.filename.replace(".mp3","_shortcut15.mp3")))e.params.filename=e.params.filename.replace(".mp3","_shortcut15.mp3"),s();else{require("fluent-ffmpeg")("./uploads/"+e.params.filename).duration(15).toFormat("mp3").audioFilters([{filter:"afade",options:"t=out:st=13:d=2"}]).on("error",function(e){console.log("An error occurred: "+e.message),t.status("400").send(e)}).on("progress",function(e){console.log("Processing: "+e.targetSize+" KB converted")}).on("end",function(){console.log("Processing finished !"),e.params.filename=e.params.filename.replace(".mp3","_shortcut15.mp3"),setTimeout(function(){s()},500)}).save("./uploads/"+e.params.filename.replace(".mp3","_shortcut15.mp3"))}},function(e,t,s){t.sendFile(e.params.filename,{root:path.join(__dirname,"../uploads")},function(e){e?console.log("errror ",e):console.log("success ")})}).post("/medias",upload.single("file"),function(e,t,s){Auth_helper.validate_admin(e,function(s){200===s.status?Products_controller.addFile(e,e.file,function(e){t.status(e.status).send(e.datas)}):t.status(403).send({message:"Vous n'avez pas les droits nécéssaires pour uploader des fichiers"})})}).delete("/medias",function(e,t,s){Auth_helper.validate_admin(e,function(s){200===s.status?Products_controller.removeFile(e,t,function(e){t.status(e.status).send(e.datas)}):t.status(403).send({message:"Vous n'avez pas les droits nécéssaires pour uploader des fichiers"})})}).post("/importFromFiles",upload.single("file"),function(e,t,s){Auth_helper.validate_admin(e,function(s){200===s.status?Products_controller.createProductFromFileName(e,e.file,function(e){t.status(e.status).send(e.datas)}):t.status(403).send({message:"Vous n'avez pas les droits nécéssaires pour uploader des fichiers"})})}),module.exports=product;