var $jscomp={scope:{},findInternal:function(a,d,b){a instanceof String&&(a=String(a));for(var e=a.length,c=0;c<e;c++){var f=a[c];if(d.call(b,f,c,a))return{i:c,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,d,b){if(b.get||b.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[d]=b.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,d,b,e){if(d){b=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var c=a[e];c in b||(b[c]={});b=b[c]}a=a[a.length-1];e=b[a];d=d(e);d!=e&&null!=d&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:d})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6-impl","es3");var db=require("mongoose"),config=require("../config/config"),Orders_model=require("../models/orders_model"),Products_model=require("../models/products_model"),userproducts_datas={user_id:{type:"string"},product_id:{type:"string"},meta_datas:{type:"Object"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}};
0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});var userproductsSchemas=new db.Schema(userproducts_datas),Userproducts=db.model("Userproducts",userproductsSchemas);module.exports={attributes:userproducts_datas};
module.exports.get=function(a,d,b){var e={};"undefined"!==typeof a.session.Auth?e={user_id:a.session.Auth._id}:"undefined"!==typeof a.query.user_id&&(e={user_id:datas.user_id});"undefined"===typeof e.user_id&&b({status:401,datas:{message:"UNAUTHORISED_NEED_USER"}});a.user_id=e.user_id;this.checkOrders(a,d,function(a){Userproducts.find(e,function(a,c){a?b({status:405,datas:a}):b({status:200,datas:c})}).sort({created:-1})})};
module.exports.allreadyBuy=function(a,d,b){Userproducts.findOne({user_id:a,product_id:d},function(a,c){a?b({status:404,message:"NEVER_BUY"}):null===c?b({status:404,message:"NEVER_BUY",datas:c}):b({status:200,message:"ALREADY_BUY",datas:c})})};
module.exports.checkOrders=function(a,d,b){var e=this;Orders_model.get(a,d,function(c){if(200===c.status)for(var f=0;f<c.datas.length;f++)for(var g=0;g<c.datas[f].basketdatas.products.length;g++)e.create({user_id:a.user_id,product_id:c.datas[f].basketdatas.products[g].product_id},d,function(a){console.log(a)});b(c)})};
module.exports.create=function(a,d,b){Userproducts.find({user_id:a.user_id,product_id:a.product_id},function(e,c){e||0===c.length?Products_model.get({product_id:a.product_id},d,function(c){console.log("Products_model.get ::::::: ",c.datas);new_userproduct=new Userproducts({user_id:a.user_id,product_id:a.product_id,meta_datas:c.datas[0]});new_userproduct.save(function(a,c){a?b({status:405,message:a}):b({status:200,datas:c})})}):b({status:200,datas:c})})};
