const db=require("mongoose"),app=require("../app"),sha1=require("sha1"),jwt=require("jsonwebtoken"),validator=require("email-validator"),config=require("../config/config"),os=require("os"),gravatar=require("gravatar"),user_datas={email:{type:"string",unique:!0},password:{type:"string"},pseudo:{type:"string"},firstName:{type:"string"},avatar:{type:"string"},lastName:{type:"string"},phone:{type:"string"},mobile:{type:"string"},token:{type:"string"},secret:{type:"string"},qrcode:{type:"Object"},birthDate:{type:"Date"},civility:{type:"string","enum":["undefined","male","female"],defaults:"undefined"},address:{type:"Array"},relations:{type:"Array"},tags:{type:"Object"},devices:{type:"Object"},members:{type:"Object"},termAccept:{type:"Boolean"},newsletter:{type:"Boolean"},rights:{type:"Object"},newsletter_services:{type:"Object"},validated:{type:"Boolean"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const userSchemas=new db.Schema(user_datas),User=db.model("User",userSchemas);module.exports={attributes:user_datas},module.exports.login=function(t,e){return t.password?validator.validate(t.email)?User.find({email:t.email,password:sha1(t.password)},function(s,i){if(s)e({status:"error",code:s.code,error:s,message:s.message});else{if(0===i.length)return User.find({email:t.email},function(t,s){e(t?{status:"error",code:11,error:t,message:"user_not_found"}:0===s.length?{status:"error",code:11,error:t,message:"user_not_found",email_valid:s.length}:{status:"error",code:13,error:t,message:"wrong_pawword",email_valid:s.length})}),!1;var n={uid:t.device_uid,arch:os.arch(),name:os.hostname()},o=jwt.sign({secret:i[0].secret},config.secrets.global.secret);if(n.token=o,User.find({_id:i[0]._id,devices:{$elemMatch:{uid:t.device_uid}}},function(e,s){e?User.update({_id:i[0]._id},{$push:{devices:n}},function(t,e){t?console.log("impossible d insérer le new_device ",t):console.log("new_device ajouté success ",e)}):0===s.length?User.update({_id:i[0]._id},{$push:{devices:n}},function(t,e){t?console.log("impossible d insérer le new_device ",t):console.log("new_device ajouté success ",e)}):User.update({id:i[0]._id,devices:{$elemMatch:{uid:t.device_uid}}},{$set:{token:o}},function(t,e){t?console.log("update device token error ",t):console.log("update device token success ",e)},!0)}),""===i[0].avatar||null==i[0].avatar)var a=gravatar.url(i[0].email,{s:"200",r:"pg",d:"404"}).replace("//","http://");else var a=i[0].avatar;User.update({_id:i[0]._id},{$set:{token:o,updated:Date.now(),avatar:a}},function(s,n){s?e({status:"error",code:s.code,error:s,message:s.message}):User.find({_id:i[0]._id},function(s,i){if(s)e({status:"error",code:s.code,error:s,message:s.message});else{var n=JSON.parse(JSON.stringify(i[0]));n.current_device=t.device_uid,e({status:"success",idkids_user:n})}})})}}):e({message:"email invalide"},null):e([]),t},module.exports.logout=function(t,e){return e(),t},module.exports.register=function(t,e){db.connect(config.database.users,{useMongoClient:!0});var s={email:t.body.subscribe_email,password:sha1(t.body.subscribe_password),pseudo:t.body.pseudo,secret:jwt.sign({},config.secrets.global.secret,{}),termAccept:!0,rights:{type:"RWU",authorizations:["me"]}};return s.token=jwt.sign({secret:s.secret},config.secrets.global.secret),s.device=[{uid:t.body.device_uid,arch:os.arch(),name:os.hostname(),token:jwt.sign({secret:s.secret},config.secrets.global.secret),avatar:gravatar.url(t.body.subscribe_email,{s:"200",r:"pg",d:"404"}).replace("//","http://")}],console.log("---------------- new_user_datas avatar ------------------------ "),console.log("---------------- new_user_datas------------------------ "),console.log(s.avatar),console.log(gravatar.url(t.body.subscribe_email,{s:"200",r:"pg",d:"404"}).replace("//","http://")),console.log("---------------- new_user_datas------------------------ "),console.log("---------------- new_user_datas------------------------ "),t.body.subscribe_newsletter?(s.newsletter=!0,s.newsletter_services={},t.body.newsletter_okaidi&&(s.newsletter_services.okaidi=1),t.body.newsletter_obaibi&&(s.newsletter_services.obaibi=1),t.body.newsletter_jacadi&&(s.newsletter_services.jacadi=1),t.body.newsletter_oxybul&&(s.newsletter_services.oxybul=1),t.body.newsletter_rclv&&(s.newsletter_services.rclv=1),t.body.newsletter_njoy&&(s.newsletter_services.njoy=1),t.body.newsletter_joyvox&&(s.newsletter_services.joyvox=1)):(s.newsletter=!1,s.newsletter_services={}),new_user=new User(s),new_user.save(function(t){e(t?{status:"error",code:t.code,duplicated_value:t.message.split('{ : "')[1].replace('" }',""),error:t}:{status:"success",user:s})}),t.body},module.exports.unregister=function(t){return t},module.exports.update=function(t){return t},user_datas.getFullName=function(){return this.firstName+" "+this.lastName},user_datas.getAge=function(){return this.birthDate};