var $jscomp={scope:{},findInternal:function(a,c,b){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var g=a[e];if(c.call(b,g,e,a))return{i:e,v:g}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,b){if(b.get||b.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[c]=b.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,c,b,d){if(c){b=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in b||(b[e]={});b=b[e]}a=a[a.length-1];d=b[a];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6-impl","es3");
var db=require("mongoose"),config=require("../config/config"),basket_model=require("../models/basket_model"),wallets_model=require("../models/wallets_model"),coupon_model=require("../models/coupon_model"),order_datas={basket_id:{type:"string"},user_id:{type:"string"},stripeToken:{type:"string"},devise:{type:"string"},amount:{type:"Number"},reduced_amount:{type:"Number"},coupons_code:{type:"Object"},metadata:{type:"Object"},response:{type:"Object"},basketdatas:{type:"Object"},status:{type:"Boolean"},
created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}},keyPublishable="",keySecret="";0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});var ordersSchemas=new db.Schema(order_datas),Orders=db.model("Orders",ordersSchemas);module.exports={attributes:order_datas};
module.exports.get=function(a,c,b){c={};"undefined"!==typeof a.session.Auth?c={user_id:a.session.Auth._id}:"undefined"!==typeof a.query.user_id&&(c={user_id:datas.user_id});"undefined"===typeof c.user_id&&b({status:401,datas:{message:"UNAUTHORISED_NEED_USER"}});Orders.find(c,function(a,c){a?b({status:405,datas:a}):b({status:200,datas:c})}).sort({created:-1})};
module.exports.createCharge=function(a,c,b){app.locals.settings.StripeMode?(keyPublishable=app.locals.settings.StripekeyPublishable,keySecret=app.locals.settings.StripekeySecret):(keyPublishable=app.locals.settings.StripekeyPublishableTest,keySecret=app.locals.settings.StripekeySecretTest);var d=require("stripe")(keySecret);"undefined"===typeof a.basket_id&&b({status:401,message:"NEED_BASKET_ID"});"undefined"===typeof a.user_id&&b({status:401,message:"NEED_USER_ID"});var e=0,g=0,p=this;basket_model.get(a,
c,function(k){var q=k.datas[0];if(200===k.status){for(var f=0;f<k.datas[0].products.length;f++)e+=k.datas[0].products[f].price;g=e;if("undefined"!==typeof a.coupons_code&&""!==a.coupons_code)for(var h=JSON.parse(a.coupons_code),f=0;f<h.length;f++)console.log("coupons_code i :::: ",h[f]),g-=h[f].amount;0>g&&(g=0);var n=a.stripeToken;d.charges.create({amount:g,currency:"eur",description:"payment ",source:n},function(d,f){if(d)b({status:401,message:"BASKET_DOESNT_MATCH"});else{console.log("STRIPE CHARGES SUCCESS ",
f);var l={basket_id:a.basket_id,user_id:a.user_id,stripeToken:n,devise:"eur",amount:e,reduced_amount:g,coupons_code:h,metadata:q,response:f,basketdatas:k.datas[0],status:1};if("undefined"!==typeof h)for(var m=0;m<h.length;m++)coupon_model.useOne(h[m],function(a){console.log("coupon used : ",a)});basket_model.deleteUserBasket(a.user_id,function(a){console.log("BASKET DELETED ",a)});p.create(l,c,function(a){200===a.status?b({status:200,datas:l}):(a.datas=l,b(a))})}})}else b({status:401,message:"BASKET_DOESNT_MATCH"})})};
module.exports.create=function(a,c,b){new_order=new Orders(a);new_order.save(function(a,c){a?b({status:405,message:a}):b({status:200,datas:c})})};module.exports.update=function(a,c,b){a={};a.updated=Date.now();Orders.updateOne({_id:ORDER_ID},{$set:a},function(a,c){a?b({status:405,message:a}):b({status:200,apps:c})})};module.exports["delete"]=function(a,c,b){b({status:401,message:"UNAUTHORISED_METHOD"})};
