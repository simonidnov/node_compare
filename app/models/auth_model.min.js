var $jscomp={scope:{},findInternal:function(a,b,d){a instanceof String&&(a=String(a));for(var c=a.length,e=0;e<c;e++){var g=a[e];if(b.call(d,g,e,a))return{i:e,v:g}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,d){if(d.get||d.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=d.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,d,c){if(b){d=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var e=a[c];e in d||(d[e]={});d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,d){return $jscomp.findInternal(this,a,d).v}},"es6-impl","es3");
var db=require("mongoose"),app=require("../app"),http=require("http"),sha1=require("sha1"),jwt=require("jsonwebtoken"),validator=require("email-validator"),Members_model=require("../models/members_model"),Address_model=require("../models/address_model"),config=require("../config/config"),gravatar=require("gravatar"),urlExists=require("url-exists"),user_datas={email:{type:"string",unique:!0},password:{type:"string"},pseudo:{type:"string",unique:!0},firstName:{type:"string"},avatar:{type:"string"},
lastName:{type:"string"},phone:{type:"string"},mobile:{type:"string"},token:{type:"string"},validation_code:{type:"string"},secret:{type:"string"},qrcode:{type:"Object"},birthDate:{type:"Date"},gender:{type:"string","enum":["undefined","male","female"],defaults:"undefined"},address:{type:"Array"},friends:{type:"Array"},relations:{type:"Array"},apps:{type:"Array"},tags:{type:"Object"},authorized_apps:{type:"Object"},facebook:{id:{type:"string"},name:{type:"string"},email:{type:"string"},likes:{type:"array"},
friends:{type:"array"},pages:{type:"array"},shared:{type:"boolean"},accessToken:{type:"string"}},devices:{uid:"string",name:"string",arch:"string",appCodeName:"string",appName:"string",appVersion:"string",userAgent:"string",vendor:"string",last_connexion:"string",token:"string",ua_parser:{type:"Object"}},termAccept:{type:"Boolean"},newsletter:{type:"Boolean"},newsletter_services:{type:"Object"},sms:{type:"Boolean"},sms_services:{type:"Object"},notifications:{type:"Boolean"},notifications_services:{type:"Object"},
rights:{type:"Object"},validated:{type:"Boolean"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now},public_locale:{type:"Boolean"},public_profile:{type:"Boolean"},public_kids:{type:"Boolean"},public_created:{type:"Boolean"},public_gamification:{type:"Boolean"},public_interest:{type:"Boolean"}},machineId=require("node-machine-id"),ua_parser=require("ua-parser-js"),device_uid=machineId.machineIdSync({original:!0});
0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});var userSchemas=new db.Schema(user_datas),User=db.model("User",userSchemas);db.connection.on("open",function(a){});db.connection.on("error",function(a){});module.exports={attributes:user_datas};module.exports.getCount=function(){return User.find({}).count()};module.exports.getActive=function(){return User.find({updated:{$gte:new Date(ISODate().getTime()-2592E5)}}).count()};
module.exports.get=function(a,b,d){device_uid=a.query.device_uid;var c=this;User.find({},function(a,b){a?d({status:304,code:a.code,error:a,message:a.message}):d({status:200,users:b,total:c.getCount()})}).skip(50*parseInt(b.page)).limit(50)};module.exports.deleteDevice=function(a,b,d){User.update({_id:b.user_id},{$pull:{devices:{uid:a.query.device_uid}}},function(a,b){errr?d({status:403,message:"impossible de supprimer le device"}):d({status:200,message:"Device deleted"})})};
module.exports.login=function(a,b,d){var c=null;"undefined"!==typeof a.query.remember_me&&("undefined"!==typeof a.query.device_infos?(device_uid=a.query.device_infos.device_uid,c={uid:device_uid,appCodeName:a.query.device_infos.appCodeName,appName:a.query.device_infos.appName,appVersion:a.query.device_infos.appVersion,userAgent:a.query.device_infos.userAgent,vendor:a.query.device_infos.vendor,last_connexion:Date.now(),ua_parser:ua_parser(a.query.device_infos.userAgent)}):"undefined"!==typeof a.query.device_uid&&
(device_uid=a.query.device_uid,c={uid:device_uid,appCodeName:a.query.appCodeName,appName:a.query.appName,appVersion:a.query.appVersion,userAgent:a.query.userAgent,vendor:a.query.vendor,last_connexion:Date.now(),ua_parser:ua_parser(a.query.userAgent)}));var e=this;b.password?validator.validate(b.email)?User.find({email:b.email,password:sha1(b.password)},function(g,f){if(g)d({status:"error",code:g.code,error:g,message:g.message});else{if(0===f.length)return User.find({email:b.email},function(a,b){a?
d({status:"error",code:11,error:a,message:"user_not_found"}):0===b.length?d({status:"error",code:11,error:a,message:"user_not_found",email_valid:b.length}):d({status:"error",code:13,error:a,message:"wrong_pawword",email_valid:b.length})}),!1;var k=jwt.sign({secret:f[0].secret},config.secrets.global.secret,{expiresIn:"2 days"});"undefined"!==typeof a.query.remember_me&&(c.token=k,User.find({_id:f[0]._id,devices:{$elemMatch:{uid:device_uid}}},function(a,d){a?User.update({_id:f[0]._id},{$push:{devices:c}},
function(a,d){a?console.log("impossible d ins\u00e9rer le new_device ",a):console.log("new_device ajout\u00e9 success ",c)}):0===d.length?User.update({_id:f[0]._id},{$push:{devices:c}},function(a,d){a?console.log("impossible d ins\u00e9rer le new_device ",a):console.log("new_device ajout\u00e9 success ",c)}):User.update({id:f[0]._id,devices:{$elemMatch:{uid:device_uid}}},{$set:{token:k},device:{$set:c}},function(a,d){a?console.log("update device token error ",a):console.log("update device token success ",
d)},!0)}));var h=f[0].avatar,h=""===f[0].avatar||null==f[0].avatar?""===b.avatar||null==b.avatar||"undefined"==typeof b.avatar?gravatar.url(f[0].email,{s:"200",r:"pg",d:"404"}).replace("//","http://"):b.avatar:f[0].avatar;urlExists(h,function(b,c){c||(h="http://www.idkids-app.com/public/images/assets/account.svg");User.update({_id:f[0]._id},{$set:{token:k,updated:Date.now(),avatar:h,rights:{type:"RWO",authorizations:["me"]}}},function(b,c){b?d({status:"error",code:b.code,error:b,message:b.message}):
e.reset_session(a,f[0]._id,function(a){a.avatar=a.avatar;d({status:200,message:"User updated",idkids_user:a})})})})}}):d({message:"email invalide"},null):d([]);return b};module.exports.logout=function(a,b,d){a.session.destroy();d()};
module.exports.register=function(a,b){db.connect(config.database.users,{useMongoClient:!0});var d=this,c={email:a.body.subscribe_email,password:sha1(a.body.subscribe_password),pseudo:a.body.pseudo,secret:jwt.sign({},config.secrets.global.secret,{},{expiresIn:"2 days"}),termAccept:!0,rights:{type:"R",authorizations:["me"]}};c.token=jwt.sign({secret:c.secret},config.secrets.global.secret,{expiresIn:"2 days"});c.device=[{uid:device_uid,token:jwt.sign({secret:c.secret},config.secrets.global.secret,{expiresIn:"2 days"}),
avatar:gravatar.url(a.body.subscribe_email,{s:"200",r:"pg",d:"404"},!0).replace("//","http://")}];if(a.body.subscribe_newsletter){c.newsletter=!0;c.newsletter_services={};for(var e=0;e<app.locals.applications.length;e++)a.body["newsletter_"+app.locals.applications[e].short_name]&&(c.newsletter_services[app.locals.applications[e].short_name]=1)}else c.newsletter=!1,c.newsletter_services={};new_user=new User(c);new_user.save(function(c,e){c?b({status:"error",message:c}):d.reset_session(a,e._id,function(a){b({status:"success",
user:e})})});return a.body};module.exports.unregister=function(a,b,d){User.remove({_id:a.body.id},function(){d(a.body)});return a.body};
module.exports.update=function(a,b,d,c){device_uid=a.body.device_uid;var e=this;d.updated=Date.now();"undefined"!==typeof d.birthDate&&(d.birthDate=d.birthDate);User.update({_id:b},{$set:d},function(d,f){d?c({status:401,message:"Impossible de mettre \u00e0 jour le token WHY ?",datas:d}):e.reset_session(a,b,function(){c({status:200,message:"User updated",datas:f})})},!0)};module.exports.updatePassword=function(a,b){b({status:200,message:"password update progress"})};
module.exports.check_user=function(a,b){device_uid=a.device_uid;var d=jwt.sign({secret:a.options.user_secret},config.secrets.global.secret,{expiresIn:"2 days"});User.find({_id:a.options.user_id,secret:a.options.user_secret,devices:{$elemMatch:{uid:device_uid,token:a.options.user_token}}},function(c,e){c?b({status:401,message:"user token device doesn't match",datas:c}):User.update({id:a.options.user_id,devices:{$elemMatch:{uid:device_uid}}},{$set:{token:d,updated:Date.now()}},function(a,c){a?b({status:401,
message:"Impossible de mettre \u00e0 jour le token WHY ?",datas:a}):b({status:200,message:"User auth success",datas:e,updated_token:d})},!0)})};module.exports.checking_session=function(a,b,d){var c=this;User.findOne({_id:a.query._id,token:a.query.token,secret:a.query.secret},function(b,g){b?d({status:401,code:b.code,error:b,message:b.message}):c.reset_session(a,a.query._id,d)})};
module.exports.reset_session=function(a,b,d){User.findOne({_id:b},function(c,e){c?d({status:401,code:c.code,error:c,message:c.message}):(user_infos=JSON.parse(JSON.stringify(e)),user_infos.current_device=device_uid,Members_model.get(b,null,function(c){user_infos.members=c.datas;Address_model.get(b,null,function(b){user_infos.address=b.datas;a.session.Auth=user_infos;d({status:200,message:"Session Updated",datas:user_infos})})}))})};
module.exports.getPublicProfile=function(a,b){this.getFullUser(a,function(a){200===a.status?b({status:a.status,message:a.message,datas:{_id:a.datas._id,pseudo:a.datas.pseudo,email:a.datas.email,avatar:a.datas.avatar,created:a.datas.created,updated:a.datas.updated}}):b(a)})};module.exports.getServices=function(a,b){this.getFullUser(a,function(a){200===a.status?b({status:a.status,message:a.message,datas:a.datas.public_services}):b(a)})};
module.exports.getFullUser=function(a,b){User.findOne({_id:a},function(d,c){d?b({status:401,message:"This is no way to peace -> peace is the way. UNAUTHORIZED",datas:d}):null!==c?Members_model.get(a,null,function(a){c.members=a.datas;b({status:200,message:"success me",datas:c})}):b({status:404,message:"USER NOT FOUND",datas:c})})};
module.exports.getValidationCode=function(a,b){User.findOne({_id:a},function(a,c){if(a)b({status:401,message:"This is no way to peace -> peace is the way. UNAUTHORIZED",datas:a});else if(null!==c){var d=jwt.sign({secret:c.secret},config.secrets.global.secret,{expiresIn:"2 days"});User.update({_id:c._id},{$set:{validation_code:d}},function(a,e){a?console.log("impossible de mettre \u00e0 jour le code de validation ",a):b({status:200,validation_code:d,email:c.email,pseudo:c.pseudo,avatar:c.avatar})})}else b({status:304,
message:"USER NOT FOUND",datas:c})})};module.exports.validAccount=function(a,b){User.findOne({email:a.email,validation_code:a.validation_code},function(a,c){a||null===c?b({status:304,message:"Impossible de certifier l'utilisateur",datas:a}):User.update({_id:c._id},{$set:{validated:!0,certified:!0}},function(a,c){a?b({status:304,message:"Impossible de certifier l'utilisateur",datas:a}):b({status:200,message:"Utilisateur certifi\u00e9 valid\u00e9",datas:c})})})};
module.exports.getUsersDevice=function(a,b){User.find({devices:{$elemMatch:{uid:a}}},{email:1,avatar:1,pseudo:1},function(a,c){a||0===c.length?b({status:304,message:"Nouvel appareil",datas:a}):b({status:200,message:"liste des utilisateurs ayant utilis\u00e9 ce device",users_device:c})})};
module.exports.deleteDevice=function(a,b){var d=this;User.update({_id:a.session.Auth._id},{$pull:{devices:{uid:a.body.uid}}},function(c,e){c||0===e.length?b({status:304,message:"appareil inexistant",datas:c}):d.reset_session(a,a.session.Auth._id,function(a){a.avatar=a.avatar;b({status:200,message:"device supprim\u00e9",idkids_user:a})})})};user_datas.getAge=function(){return this.birthDate};
function checkAvatarExist(a){var b=require("http");b.request({},function(d){return 404!=b.status?a:"http://www.idkids-app.com/public/images/assets/account.svg"}).end()};
