var $jscomp={scope:{},findInternal:function(b,d,c){b instanceof String&&(b=String(b));for(var a=b.length,e=0;e<a;e++){var f=b[e];if(d.call(c,f,e,b))return{i:e,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(b,d,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");b!=Array.prototype&&b!=Object.prototype&&(b[d]=c.value)};
$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(b,d,c,a){if(d){c=$jscomp.global;b=b.split(".");for(a=0;a<b.length-1;a++){var e=b[a];e in c||(c[e]={});c=c[e]}b=b[b.length-1];a=c[b];d=d(a);d!=a&&null!=d&&$jscomp.defineProperty(c,b,{configurable:!0,writable:!0,value:d})}};
$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,c){return $jscomp.findInternal(this,b,c).v}},"es6-impl","es3");
var db=require("mongoose"),config=require("../config/config"),Orders_model=require("../models/orders_model"),Products_model=require("../models/products_model"),userproducts_datas={user_id:{type:"string"},product_id:{type:"string"},meta_datas:{type:"Object"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}},usershare_datas={user_id:{type:"string"},product_id:{type:"string"},share_name:{type:"string"},share_email:{type:"string"},share_message:{type:"string"},share_link:{type:"string"},
share_later:{type:"boolean","default":!1},share_date:{type:"Date"},share_sent:{type:"boolean","default":!1},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});var userproductsSchemas=new db.Schema(userproducts_datas),Userproducts=db.model("Userproducts",userproductsSchemas),usershareSchemas=new db.Schema(usershare_datas),Usershares=db.model("Usershares",usershareSchemas);
module.exports={attributes:userproducts_datas};
module.exports.get=function(b,d,c){var a={};"undefined"!==typeof b.session.Auth?a={user_id:b.session.Auth._id}:"undefined"!==typeof b.query.user_id?a={user_id:datas.user_id}:"undefined"!==typeof b.query.options&&(a={user_id:b.query.options.user_id});if("undefined"===typeof a.user_id)return c({status:401,datas:{message:"UNAUTHORISED_NEED_USER"}}),!1;b.user_id=a.user_id;this.checkOrders(b,d,function(b){Userproducts.find(a,function(b,a){b?c({status:405,datas:b}):c({status:200,datas:a});return!1}).sort({created:-1})})};
module.exports.allreadyBuy=function(b,d,c){Userproducts.findOne({user_id:b,product_id:d},function(b,e){b?c({status:404,message:"NEVER_BUY"}):null===e?c({status:404,message:"NEVER_BUY",datas:e}):c({status:200,message:"ALREADY_BUY",datas:e})})};
module.exports.checkOrders=function(b,d,c){var a=this;Orders_model.get(b,d,function(c){if(200===c.status)for(var e=0;e<c.datas.length;e++)for(var h=0;h<c.datas[e].basketdatas.products.length;h++)a.create({user_id:b.user_id,product_id:c.datas[e].basketdatas.products[h].product_id},d,function(b){})});c({status:200,message:"CHECKING"})};
module.exports.create=function(b,d,c){Userproducts.find({user_id:b.user_id,product_id:b.product_id},function(a,e){a||0===e.length?Products_model.get({product_id:b.product_id},d,function(a){new_userproduct=new Userproducts({user_id:b.user_id,product_id:b.product_id,meta_datas:a.datas[0]});new_userproduct.save(function(b,a){b?c({status:405,message:b}):c({status:200,datas:a})})}):c({status:201,datas:e,message:"ALREADY_ADDED_PRODUCT_ON_USER"})})};
module.exports.shares_of_the_day=function(b,d,c){var a=new Date;Usershares.find({share_date:{$not:{$type:9}}},function(b,a){a.forEach(function(b,a){null===b.share_date&&(b.share_date=new Date);b.share_date=new Date(b.share_date);Usershares.update({_id:b._id},{$set:{share_date:b.share_date}},function(b,a){console.log("err ",b);console.log("updates ",a)})})});Usershares.aggregate([{$project:{day:{$dayOfMonth:"$share_date"},month:{$month:"$share_date"},year:{$year:"$share_date"},user_id:"$user_id",product_id:"$product_id",
share_name:"$share_name",share_email:"$share_email",share_message:"$share_message",share_link:"$share_link",share_later:"$share_later",share_date:"$share_date",share_sent:"$share_sent",created:"$created",updated:"$updated"}},{$match:{day:a.getDate(),month:a.getMonth()+1,share_later:!0}}],function(a,f){if(a)c({status:500,message:"ERROR_OCCURED_REQUEST",err:a});else{var e=0,g=f.length,k=0;if(0===f.length)c({status:200,message:"NO_EMAILS_FOR_TODAY",shares:f});else{var l=require("../controllers/email_controller"),
m=require("../controllers/auth_controller");f.forEach(function(a,f){b.query.user={_id:a.user_id};m.getUserInfos(b,d,function(d){if(200===d.status){var f=d.user[0];(new Date(a.share_date)).toLocaleDateString("fr-FR",{month:"long",day:"numeric"});l.sendMaChansonEcard(b,{subject:"Bonjour "+a.share_name+", "+f.pseudo+" vous souhaites un joyeux anniversaire en chanson",title:"Bonjour "+a.share_name+", "+f.pseudo+" vous souhaites un joyeux anniversaire en chanson",name:a.share_name,friend:f.pseudo,friend_email:f.email,
default_message:"Bonjour "+a.share_name+",<br>votre ami(e) "+f.pseudo+" vous souhaites un joyeux anniversaire en chanson !",message:a.share_message,product_id:a.product_id,share_id:a._id,email:f.email,to:a.share_email},function(b){200===b.status&&(Usershares.update({_id:a._id},{$set:{share_sent:!0}},function(a,b){console.log("SUCCESS SAVE SENT DATAS TRUE")}),k++,l.send(null,{subject:"La chanson d'anniversaire personnalis\u00e9e pour "+a.share_name+" \u00e0 bien \u00e9t\u00e9 envoy\u00e9e",title:"La chanson d'anniversaire personnalis\u00e9e pour "+
a.share_name+" \u00e0 bien \u00e9t\u00e9 envoy\u00e9e",message:"Bonjour "+f.pseudo+"<br>Vous avez envoy\u00e9 une chanson d'anniversaire pour votre ami(e) "+a.share_name+".<br>Cet email confirme l'envoie de votre chanson sur l'adresse email de votre ami(e) : "+a.share_email+"<br>Voici votre message personnalis\u00e9 qui accompagnera la chanson :<br>"+a.share_message,email:"contact@joyvox.fr",share_id:a._id,to:f.email},function(a){}));e++;e===g-1&&c({status:200,message:"EMAILS_SENT",total:g,success:k})})}else e++,
e===g-1&&c({status:200,message:"EMAILS_SENT",total:g,success:k})})})}}})};
module.exports.share=function(b,d,c){var a=b.body.data;Userproducts.find({user_id:a.options.user_id,product_id:a.product_id},function(e,f){if(e)c({status:200,message:"ERROR_PRODUCT_GET",response_display:{title:"Erreur de partage",message:"Il semble que vous n'ayez pas achet\u00e9 le produit que vous souhaitez partager."}});else if(0===f.length)c({status:200,message:"UNKNOW_USER_PRODUCT",response_display:{title:"Erreur de Partage",message:"Il semble que vous n'ayez pas achet\u00e9 le produit que vous souhaitez partager."}});
else{var h=require("../controllers/email_controller"),g=require("../controllers/auth_controller");b.query.user={_id:a.options.user_id};g.getUserInfos(b,d,function(e){if(200===e.status){var d=e.user[0];new_shareproduct=new Usershares({user_id:e.user[0]._id,product_id:a.product_id,share_name:a.share_name,share_email:a.share_email,share_message:a.share_message,share_link:a.share_link,share_date:a.share_date?a.share_date:new Date,share_later:a.share_later});new_shareproduct.save(function(f,g){if(f)c({status:200,
datas:e.datas,response_display:{title:"Erreur de Partage",message:"Une erreur est survenue lors du partage de votre chanson personnalis\u00e9e, nous vous conseillons de la t\u00e9l\u00e9charger et de l'envoyer manuellement.<br>Il est possible que nous n'arrivions pas \u00e0 joindre la boite mail de votre ami(e)."}});else if("true"===a.share_later){var k=(new Date(a.share_date)).toLocaleDateString("fr-FR",{month:"long",day:"numeric"});h.send(null,{subject:"L'envoie de la chanson d'anniversaire personnalis\u00e9e pour "+
a.share_name+" \u00e0 bien \u00e9t\u00e9 configur\u00e9",title:"L'envoie de votre chanson d'anniversaire \u00e0 bien \u00e9t\u00e9 configur\u00e9",message:"Bonjour "+d.pseudo+"<br>Vous avez configur\u00e9 l'envoie d'une chanson d'anniversaire pour votre ami(e) "+a.share_name+" pour le "+k+".<br>Cet email confirme que l'email sera envoy\u00e9 \u00e0 9h00 ce jour pr\u00e9cis sur l'adresse email de votre ami(e) : "+a.share_email+"<br>Voici votre message personnalis\u00e9 qui accompagnera la chanson :<br>"+
a.share_message,email:"contact@joyvox.fr",share_id:g._id,to:d.email},function(b){c({status:200,datas:b.datas,response_display:{title:"Partager",message:"Le partage de la chanson d'anniversaire pour "+a.share_name+" a bien \u00e9t\u00e9 configur\u00e9e, elle sera envoy\u00e9 \u00e0 votre ami(e) sur son email "+a.share_email+" le "+k+" !"}})})}else h.sendMaChansonEcard(b,{subject:"Bonjour"+a.share_name+", "+d.pseudo+" vous souhaites un joyeux anniversaire en chanson",title:"Bonjour"+a.share_name+", "+
d.pseudo+" vous souhaites un joyeux anniversaire en chanson",default_message:"Bonjour "+a.share_name+",<br>votre ami(e) "+d.pseudo+" vous souhaites un joyeux anniversaire en chanson !",message:a.share_message,product_id:a.product_id,share_id:g._id,email:d.email,to:a.share_email},function(b){200===b.status?h.send(null,{subject:"La chanson d'anniversaire personnalis\u00e9e pour "+a.share_name+" \u00e0 bien \u00e9t\u00e9 envoy\u00e9e",title:"La chanson d'anniversaire personnalis\u00e9e pour "+a.share_name+
" \u00e0 bien \u00e9t\u00e9 envoy\u00e9e",message:"Bonjour "+d.pseudo+"<br>Vous avez envoy\u00e9 une chanson d'anniversaire pour votre ami(e) "+a.share_name+".<br>Cet email confirme l'envoie de votre chanson sur l'adresse email de votre ami(e) : "+a.share_email+"<br>Voici votre message personnalis\u00e9 qui accompagnera la chanson :<br>"+a.share_message,email:"contact@joyvox.fr",share_id:g._id,to:d.email},function(b){c({status:200,datas:b.datas,response_display:{title:"Partager ma chanson",message:"La chanson a bien \u00e9t\u00e9 envoy\u00e9e \u00e0 "+
a.share_name+" sur son adresse email "+a.share_email+" !"}})}):c({status:203,datas:b.datas,response_display:{title:"Erreur de Partage",message:"Nous n'avons pas r\u00e9ussi \u00e0 envoyer la chanson \u00e0 votre ami(e)."}})})})}else c({status:203,datas:e.datas,response_display:{title:"Erreur de Partage",message:"Nous n'avons pas r\u00e9ussi \u00e0 vous authentifier pour cr\u00e9er l'envoie de votre chanson."}})})}})};
