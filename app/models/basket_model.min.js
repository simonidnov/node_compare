var $jscomp={scope:{},findInternal:function(a,c,d){a instanceof String&&(a=String(a));for(var b=a.length,e=0;e<b;e++){var f=a[e];if(c.call(d,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,d){if(d.get||d.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[c]=d.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,c,d,b){if(c){d=$jscomp.global;a=a.split(".");for(b=0;b<a.length-1;b++){var e=a[b];e in d||(d[e]={});d=d[e]}a=a[a.length-1];b=d[a];c=c(b);c!=b&&null!=c&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,d){return $jscomp.findInternal(this,a,d).v}},"es6-impl","es3");
var db=require("mongoose"),products_controller=require("../controllers/products_controller"),config=require("../config/config"),_=require("underscore"),basket_datas={user_id:{type:"string"},products:{type:[],datas:{_id:{type:"Schema.ObjectId"},product_id:{type:"string",unique:!0},quantity:{type:"number","default":1},datas:{type:[]},price:{type:"Number"},total:{type:"Number"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}}},total:{type:"number","default":0},created:{type:"Date",
"default":Date.now},updated:{type:"Date","default":Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});var basketSchemas=new db.Schema(basket_datas),Baskets=db.model("Baskets",basketSchemas);module.exports={attributes:basket_datas};
module.exports.get=function(a,c,d){var b={};if(a.isAdmin&&"undefined"!==typeof a.basket_id)b={_id:a.basket_id};else if("undefined"!==typeof a.options)"undefined"!==typeof a.options.user_id&&(b={user_id:a.options.user_id});else if("undefined"!==typeof c.session.Auth)b={user_id:c.session.Auth._id};else if("undefined"!==typeof a.user_id)b={user_id:a.user_id};else return d({status:401,message:"NOT_LOGGED_IN"}),!1;Baskets.find(b,function(a,b){a?d({status:401,datas:a}):(0===b.length&&d({status:200,datas:b}),
b.forEach(function(a){var e=a.total_amount=0;0<a.products.length?a.products.forEach(function(g){products_controller.get({product_id:g.product_id},c,function(c){0===c.datas.length?g.infos={label:"DOSNT_EXIST",message:"PRODUIT_INTROUVABLE_OU_SUPPRIME"}:(g.infos=c.datas[0],a.total_amount+=g.price*("undefined"!==typeof g.quantity?g.quantity:1));e++;e>=a.products.length&&d({status:200,datas:b})})}):d({status:200,datas:b})}))})};
module.exports.getAmount=function(a,c,d){var b={};if(a.isAdmin&&"undefined"!==typeof a.basket_id)b={_id:a.basket_id};else if("undefined"!==typeof a.options)"undefined"!==typeof a.options.user_id&&(b={user_id:a.options.user_id});else if("undefined"!==typeof c.session.Auth)b={user_id:c.session.Auth._id};else if("undefined"!==typeof a.user_id)b={user_id:a.user_id};else return d({status:401,message:"NOT_LOGGED_IN"}),!1;Baskets.find(b,function(b,f){b?d({status:401,datas:b}):(0===f.length&&d({status:200,
datas:f}),f.forEach(function(b){var e=b.total_amount=0;0<b.products.length?b.products.forEach(function(g){products_controller.get({product_id:g.product_id},c,function(c){0===c.datas.length?g.infos={label:"DOSNT_EXIST",message:"PRODUIT_INTROUVABLE_OU_SUPPRIME"}:(g.infos=c.datas[0],b.total_amount+=g.price*("undefined"!==typeof g.quantity?g.quantity:1));e++;c={amount:b.total_amount,new_amount:b.total_amount,reduction:0,reduced_amount:0,dif_amount:0};for(var f=0;f<a.coupon_code.length;f++)c.reduction=
parseInt(c.reduction)+parseInt(a.coupon_code[f].amount);c.reduced_amount=b.total_amount-c.reduction;c.new_amount=c.reduced_amount;0>c.reduced_amount&&(c.new_amount=0,c.dif_amount=Math.abs(c.reduction-b.total_amount),c.wallet_infos=a.coupon_code[0],c.wallet_infos.amount=c.dif_amount);e>=b.products.length&&d({status:200,datas:c})})}):d({status:200,datas:f})}))})};
module.exports.create=function(a,c,d){var b=this,e=null;console.log("datas basket model create ",a);products_controller.get(a,c,function(f){if(200===f.status){e=f.datas[0];if("undefined"===typeof a.options.user_id)return d({status:405,message:"user not defined"}),!1;b.get(a,c,function(b){console.log("SELF GET ",b);if(200===b.status&&0<b.datas.length){if(b=b.datas[0],"undefined"!==typeof a.product_id){var c=_.where(b.products,{product_id:a.product_id});0<c.length?(c=c[0],c.quantity=1,c.total=parseFloat(c.price)*
parseInt(c.quantity),c.updated=Date.now()):b.products.push({product_id:a.product_id,datas:a.datas,price:e.price,total:(parseFloat(e.price)*parseInt(a.quantity)).toFixed(2),created:Date.now(),updated:Date.now()});b.updated=Date.now();Baskets.updateOne({_id:b._id},{$set:b},function(a,b){a?d({status:405,message:a}):d({status:200,datas:b})})}}else b={user_id:a.options.user_id,products:[{product_id:a.product_id,quantity:1,datas:a.datas,price:e.price,total:(parseFloat(e.price)*parseFloat(a.quantity)).toFixed(2),
created:Date.now(),updated:Date.now()}],total:(parseFloat(e.price)*parseFloat(a.quantity)).toFixed(2),created:Date.now(),updated:Date.now()},new_basket=new Baskets(b),new_basket.save(function(a,b){a?d({status:405,datas:{message:"ERROR",infos:a}}):d({status:200,datas:b})})})}else d(f)})};module.exports.update=function(a,c,d){delete datas.options;delete datas._id;datas.updated=Date.now();Baskets.updateOne({_id:a.body._id},{$set:datas},function(a,c){a?d({status:405,datas:a}):d({status:200,datas:c})})};
module.exports.deleteUserBasket=function(a,c){Baskets.deleteOne({user_id:a},function(a){c(a)})};module.exports["delete"]=function(a,c,d){"undefined"!==typeof a.body.product_id&&console.log("req.body.product_id ",a.body.product_id);"undefined"!==typeof a.body.basket_id&&console.log("req.body.basket_id ",a.body.basket_id);Baskets.update({_id:a.body.basket_id},{$pull:{products:{product_id:a.body.product_id}}},function(a,c){a?d({status:400,datas:{message:a}}):d({status:200,datas:c})})};
