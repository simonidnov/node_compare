var $jscomp={scope:{},findInternal:function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var g=a[e];if(b.call(c,g,e,a))return{i:e,v:g}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6-impl","es3");
var db=require("mongoose"),config=require("../config/config"),basket_model=require("../models/basket_model"),wallets_model=require("../models/wallets_model"),coupon_model=require("../models/coupon_model"),order_datas={basket_id:{type:"string"},user_id:{type:"string"},stripeToken:{type:"string"},devise:{type:"string"},amount:{type:"Number"},reduced_amount:{type:"Number"},coupons_code:{type:"Object"},bill_number:{type:"string"},metadata:{type:"Object"},response:{type:"Object"},basketdatas:{type:"Object"},
status:{type:"Boolean"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}},keyPublishable="",keySecret="";0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});var ordersSchemas=new db.Schema(order_datas),Orders=db.model("Orders",ordersSchemas);module.exports={attributes:order_datas};
module.exports.get=function(a,b,c){b={};"undefined"!==typeof a.session.Auth?b={user_id:a.session.Auth._id}:"undefined"!==typeof a.query.user_id&&(b={user_id:datas.user_id});"undefined"!==typeof a.query._id&&(b._id=a.query._id);"undefined"===typeof b.user_id&&c({status:401,datas:{message:"UNAUTHORISED_NEED_USER"}});Orders.find(b,function(a,b){a?c({status:405,datas:a}):c({status:200,datas:b})}).sort({created:-1})};
module.exports.getBill=function(a,b,c){var d={};b.is_admin||(d.user_id=a);"undefined"!==typeof b.bill_number&&(d.bill_number=b.bill_number);"undefined"!==typeof b._id&&(d._id=b._id);Orders.findOne(d,function(a,b){a?c({status:405,datas:a}):c({status:200,datas:b})})};
module.exports.createCharge=function(a,b,c){app.locals.settings.StripeMode?(keyPublishable=app.locals.settings.StripekeyPublishable,keySecret=app.locals.settings.StripekeySecret):(keyPublishable=app.locals.settings.StripekeyPublishableTest,keySecret=app.locals.settings.StripekeySecretTest);var d=require("stripe")(keySecret);"undefined"===typeof a.basket_id&&c({status:401,message:"NEED_BASKET_ID"});"undefined"===typeof a.user_id&&c({status:401,message:"NEED_USER_ID"});var e=0,g=0,p=this;basket_model.get(a,
b,function(l){var q=l.datas[0];if(200===l.status){for(var f=0;f<l.datas[0].products.length;f++)e+=l.datas[0].products[f].price;g=e;if("undefined"!==typeof a.coupons_code&&""!==a.coupons_code)for(var h=JSON.parse(a.coupons_code),f=0;f<h.length;f++)console.log("coupons_code i :::: ",h[f]),g-=h[f].amount;0>g&&(g=0);var n=a.stripeToken;d.charges.create({amount:g,currency:"eur",description:"payment ",source:n},function(d,f){d?c({status:401,message:"BASKET_DOESNT_MATCH"}):Orders.find().count().exec(function(d,
r){var k;k="FA"+(new Date(Date.now())).getFullYear().toString().substring(1,4);k+=(r/1E6).toString().replace("0.","");var m={basket_id:a.basket_id,user_id:a.user_id,stripeToken:n,devise:"eur",amount:e,reduced_amount:g,coupons_code:h,bill_number:k,metadata:q,response:f,basketdatas:l.datas[0],status:1};if("undefined"!==typeof h)for(k=0;k<h.length;k++)coupon_model.useOne({id:h[k].id,user_id:a.user_id},function(a){console.log("coupon used : ",a)});basket_model.deleteUserBasket(a.user_id,function(a){console.log("BASKET DELETED ",
a)});p.create(m,b,function(a){200===a.status?c({status:200,datas:m}):(a.datas=m,c(a))})})})}else c({status:401,message:"BASKET_DOESNT_MATCH"})})};module.exports.create=function(a,b,c){new_order=new Orders(a);new_order.save(function(a,b){a?c({status:405,message:a}):c({status:200,datas:b})})};module.exports.update=function(a,b,c){a={};a.updated=Date.now();Orders.updateOne({_id:ORDER_ID},{$set:a},function(a,b){a?c({status:405,message:a}):c({status:200,apps:b})})};
module.exports["delete"]=function(a,b,c){c({status:401,message:"UNAUTHORISED_METHOD"})};
