var $jscomp={scope:{},findInternal:function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(b.call(c,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6-impl","es3");
var db=require("mongoose"),app=require("../app"),http=require("http"),sha1=require("sha1"),jwt=require("jsonwebtoken"),validator=require("email-validator"),Members_model=require("../models/members_model"),Address_model=require("../models/address_model"),Email_controller=require("../controllers/email_controller"),config=require("../config/config"),gravatar=require("gravatar"),urlExists=require("url-exists"),user_datas={email:{type:"string",unique:!0},password:{type:"string"},pseudo:{type:"string"},
firstName:{type:"string"},avatar:{type:"string"},lastName:{type:"string"},phone:{type:"string"},mobile:{type:"string"},token:{type:"string"},validation_code:{type:"string"},secret:{type:"string"},qrcode:{type:"Object"},birthDate:{type:"Date"},gender:{type:"string","enum":["undefined","male","female"],defaults:"undefined"},address:{type:"Array"},friends:{type:"Array"},relations:{type:"Array"},apps:{type:"Array"},tags:{type:"Object"},authorized_apps:{type:"Object"},facebook:{id:{type:"string"},name:{type:"string"},
email:{type:"string"},likes:{type:"array"},friends:{type:"array"},pages:{type:"array"},shared:{type:"boolean"},accessToken:{type:"string"}},devices:{uid:"string",name:"string",arch:"string",appCodeName:"string",appName:"string",appVersion:"string",userAgent:"string",vendor:"string",last_connexion:"string",token:"string",ua_parser:{type:"Object"}},termAccept:{type:"Boolean"},newsletter:{type:"Boolean"},newsletter_services:{type:"Object"},sms:{type:"Boolean"},sms_services:{type:"Object"},notifications:{type:"Boolean"},
notifications_services:{type:"Object"},rights:{type:"Object"},validated:{type:"Boolean"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now},public_locale:{type:"Boolean"},public_profile:{type:"Boolean"},public_kids:{type:"Boolean"},public_created:{type:"Boolean"},public_gamification:{type:"Boolean"},public_interest:{type:"Boolean"}},machineId=require("node-machine-id"),ua_parser=require("ua-parser-js"),device_uid=machineId.machineIdSync({original:!0});
0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});var userSchemas=new db.Schema(user_datas),User=db.model("User",userSchemas);db.connection.on("open",function(a){});db.connection.on("error",function(a){});User.collection.dropIndexes();module.exports={attributes:user_datas};module.exports.getCount=function(){return User.find({}).count()};module.exports.getActive=function(){return User.find({updated:{$gte:new Date(ISODate().getTime()-2592E5)}}).count()};
module.exports.get=function(a,b,c){device_uid=a.query.device_uid;var d=this;User.find({},function(a,b){a?c({status:304,code:a.code,error:a,message:a.message}):c({status:200,users:b,total:d.getCount()})}).skip(50*parseInt(b.page)).limit(50)};
module.exports.getUserInfos=function(a,b,c){"undefined"!==typeof a.query.user&&""!==a.query.user||c({status:304,datas:{message:"NEED_USER"}});User.find({_id:a.query.user._id},function(a,b){a?c({status:304,code:a.code,error:a,message:"NEED_USER"}):c({status:200,user:b})})};module.exports.deleteDevice=function(a,b,c){User.update({_id:b.user_id},{$pull:{devices:{uid:a.query.device_uid}}},function(a,b){errr?c({status:403,message:"DEVICE_DELETE_ERROR"}):c({status:200,message:"DEVICE_DELETE_SUCCESS"})})};
module.exports.login=function(a,b,c){"undefined"!==typeof a.query.remember_me&&("undefined"!==typeof a.query.device_infos?(device_uid=a.query.device_infos.device_uid,Date.now(),ua_parser(a.query.device_infos.userAgent)):"undefined"!==typeof a.query.device_uid&&(device_uid=a.query.device_uid,Date.now(),ua_parser(a.query.userAgent)));var d=this;b.password?validator.validate(b.email)?User.find({email:b.email,password:sha1(b.password)},function(e,f){if(e)c({status:"error",code:e.code,error:e,message:e.message});
else{if(0===f.length)return User.find({email:b.email},function(a,b){a?c({status:400,code:11,error:a,message:"USER_WRONG_EMAIL"}):0===b.length?c({status:400,code:11,error:a,message:"USER_WRONG_EMAIL",email_valid:b.length}):c({status:400,code:13,error:a,message:"USER_WRONG_PASSWORD",email_valid:b.length})}),!1;var h=jwt.sign({secret:f[0].secret,email:f[0].email,password:b.password},config.secrets.global.secret,{expiresIn:"2 days"}),g=f[0].avatar,g=""===f[0].avatar||null===f[0].avatar?""===b.avatar||
null===b.avatar||"undefined"===typeof b.avatar?gravatar.url(f[0].email,{s:"200",r:"pg",d:"404"}).replace("//","http://"):b.avatar:f[0].avatar;urlExists(g,function(b,e){e||(g="/public/images/assets/account.svg");User.update({_id:f[0]._id},{$set:{updated:Date.now(),avatar:g,token:h}},function(b,e){b?c({status:400,code:b.code,error:b,message:"USER_LOGIN_ERROR"}):d.reset_session(a,f[0]._id,function(a){a.avatar=a.avatar;c({status:200,message:"USER_LOGIN_SUCCESS",idkids_user:a})})})})}}):c({status:400,
message:"USER_WRONG_EMAIL"}):c({status:400,message:"USER_LOGIN_ERROR"});return b};module.exports.logout=function(a,b,c){"undefined"!==typeof a.session.Auth&&a.session.destroy();c({status:200,datas:{message:"SESSION_DELETED"}})};
module.exports.register=function(a,b){"undefined"!==typeof a.body.data&&(a.body=a.body.data);if("undefined"===typeof a.body||"undefined"===typeof a.body.subscribe_password)return b({status:"error",message:"NO_BODY"}),!1;User.find({email:a.body.subscribe_email},function(a,c){if(!a&&0<c.length)return b({status:203,message:"SUBSCRIBE_EMAIL_EXIST",email_already_exist:c.length}),!1});var c=sha1(a.body.subscribe_password);db.connect(config.database.users,{useMongoClient:!0});var d=this,c={email:a.body.subscribe_email,
password:c,pseudo:a.body.pseudo,avatar:gravatar.url(a.body.subscribe_email,{s:"200",r:"pg",d:"404"},!0).replace("//","http://"),secret:jwt.sign({pseudo:a.body.pseudo+"_"+a.body.subscribe_email},config.secrets.global.secret,{expiresIn:"2 days"}),termAccept:!0,rights:{type:"R",authorizations:["me"]}};c.token=jwt.sign({secret:c.secret,email:a.body.subscribe_email,password:a.body.subscribe_password},config.secrets.global.secret,{expiresIn:"2 days"});c.device=[{uid:device_uid,token:c.token}];if(a.body.subscribe_newsletter){if(c.newsletter=
!0,c.newsletter_services={},"undefined"!==typeof app.locals&&"undefined"!==typeof app.locals.applications)for(var e=0;e<app.locals.applications.length;e++)a.body["newsletter_"+app.locals.applications[e].short_name]&&(c.newsletter_services[app.locals.applications[e].short_name]=1)}else c.newsletter=!1,c.newsletter_services={};new_user=new User(c);new_user.save(function(c,e){c?b({status:203,message:"SUBSCRIBE_EMAIL_EXIST",err:c}):d.reset_session(a,e._id,function(a){b({status:200,user:e})})})};
module.exports.lost_password=function(a,b,c){"unefined"!==typeof a.body.data&&(a.body=a.body.data);"unefined"===typeof a.body.email&&c({status:203,message:"UNKNOW_USER_EMAIL"});var d=this;User.findOne({email:a.body.email},function(b,f){b?c({status:403,datas:{message:b}}):null===f?c({status:403,message:"UNKNOW_USER_EMAIL"}):d.getValidationCode(f._id,function(b){200===b.status?Email_controller.lost_password(a,b,function(a){c({status:a.status,response_display:{message:"REQUEST_PASSWORD_MESSAGE",title:"REQUEST_PASSWORD_TITLE"},
message:"PASSWORD_SENDED"})}):c({status:b.status,datas:b})})})};module.exports.unregister=function(a,b,c){User.remove({_id:a.body.id},function(){c({status:200,message:"USER_DELETED",infos:a.body})});return a.body};
module.exports.update=function(a,b,c,d){device_uid=a.body.device_uid;var e=this;c.updated=Date.now();"undefined"!==typeof c.birthDate&&(c.birthDate=c.birthDate);User.update({_id:b},{$set:c},function(c,h){c?d({status:401,message:"CANT_UPDATE_TOKEN",datas:c}):e.reset_session(a,b,function(){d({status:200,message:"TOKEN_UPDATED",datas:h,response_display:{title:"Mis \u00e0 jour",message:"Votre profil vient d'\u00eatre mis \u00e0 jour."}})})},!0)};
module.exports.updatePassword=function(a,b,c){User.update({email:a.email},{$set:{password:sha1(a.password),updated:Date.now()}},function(a,b){a?c({status:401,message:"CANT_UPDATE_PASSWORD",error:a}):c({status:200,message:"PASSWORD_UPDATED",infos:b})})};module.exports.check_user_session=function(a,b){};
module.exports.check_user=function(a,b){jwt.verify(a.options.user_token,config.secrets.global.secret,function(c,d){if(c)b({status:203,message:"UNAUTHORISED_TOKEN",response_display:{title:"Connexion recquise",message:"Vous devez \u00earte connect\u00e9 pour effectuer cette action."},datas:c});else{a.decoded=d;if("undefined"===typeof d.password||"undefined"===typeof d.email)return b({status:203,message:"UNAUTHORISED",response_display:{title:"Connexion recquise",message:"Vous devez \u00earte connect\u00e9 pour effectuer cette action."}}),
!1;User.find({email:d.email,password:sha1(d.password)},function(c,f){if(c)b({status:203,message:"UNAUTHORISED_TOKEN",datas:c,response_display:{title:"Connexion recquise",message:"Vous devez \u00earte connect\u00e9 pour effectuer cette action."}});else if(0===f.length)b({status:203,message:"UNAUTHORISED",response_display:{title:"Connexion recquise",message:"Vous devez \u00earte connect\u00e9 pour effectuer cette action."}});else{var e=jwt.sign({secret:f[0].user_secret,email:f[0].email,password:d.password},
config.secrets.global.secret,{expiresIn:"2 days"});User.update({_id:f[0]._id},{$set:{updated:Date.now(),token:e}},function(c,d){c?b({status:401,message:"CANT_UPDATE_TOKEN",datas:c}):(a.updated_token=e,b({status:200,message:"TOKEN_UPDATED",datas:f,updated_token:e}))},!0)}})}})};
module.exports.checking_session=function(a,b,c){var d=this;User.findOne({_id:a.query._id,token:a.query.token,secret:a.query.secret},function(b,f){b?c({status:401,code:b.code,error:b,message:b.message}):d.reset_session(a,a.query._id,c)})};
module.exports.reset_session=function(a,b,c){console.log("--------------- reset_session ",b);User.findOne({_id:b},function(d,e){d?c({status:401,code:d.code,error:d,message:d.message}):(user_infos=JSON.parse(JSON.stringify(e)),user_infos.current_device=device_uid,Members_model.get(b,null,function(d){user_infos.members=d.datas;Address_model.get(b,null,function(b){user_infos.address=b.datas;console.log("--------------- user_infos RESET SESSION ",user_infos);a.session.Auth=user_infos;c({status:200,message:"SESSION_UPDATED",
datas:user_infos})})}))})};module.exports.getPublicProfile=function(a,b){this.getFullUser(a,function(a){200===a.status?b({status:a.status,message:a.message,datas:{_id:a.datas._id,pseudo:a.datas.pseudo,email:a.datas.email,avatar:a.datas.avatar,created:a.datas.created,updated:a.datas.updated}}):b(a)})};module.exports.getServices=function(a,b){this.getFullUser(a,function(a){200===a.status?b({status:a.status,message:a.message,datas:a.datas.public_services}):b(a)})};
module.exports.getFullUser=function(a,b){User.findOne({_id:a},function(c,d){c?b({status:401,message:"UNAUTHORISED_TOKEN",datas:c}):null!==d?Members_model.get(a,null,function(a){d.members=a.datas;b({status:200,message:"success me",datas:d})}):b({status:404,message:"USER_NOT_FOUND",datas:d})})};
module.exports.getValidationCode=function(a,b){User.findOne({_id:a},function(a,d){if(a)b({status:401,message:"UNAUTHORISED_TOKEN",datas:a});else if(null!==d){var c=jwt.sign({secret:d.secret},config.secrets.global.secret,{expiresIn:"2 days"});User.update({_id:d._id},{$set:{validation_code:c}},function(a,e){a?console.log("impossible de mettre \u00e0 jour le code de validation ",a):b({status:200,validation_code:c,email:d.email,pseudo:d.pseudo,avatar:d.avatar})})}else b({status:304,message:"USER_NOT_FOUND",
datas:d})})};module.exports.validCode=function(a,b){User.findOne({email:a.email,validation_code:a.validation_code},function(a,d){a||null===d?b({status:304,message:"INVALID_CODE",datas:a}):b({status:200,message:"CODE_VALID",datas:d})})};
module.exports.validAccount=function(a,b){User.findOne({email:a.email,validation_code:a.validation_code},function(a,d){a||null===d?b({status:304,message:"UNAUTHORISED_TOKEN",datas:a}):User.update({_id:d._id},{$set:{validated:!0,certified:!0}},function(a,c){a?b({status:304,message:"UNAUTHORISED_TOKEN",datas:a}):b({status:200,message:"USER_VALIDATED",datas:c})})})};
module.exports.getUsersDevice=function(a,b){User.find({devices:{$elemMatch:{uid:a}}},{email:1,avatar:1,pseudo:1},function(a,d){a||0===d.length?b({status:304,message:"NEW_DEVICE",datas:a}):b({status:200,message:"liste des utilisateurs ayant utilis\u00e9 ce device",users_device:d})})};
module.exports.deleteDevice=function(a,b){var c=this;User.update({_id:a.session.Auth._id},{$pull:{devices:{uid:a.body.uid}}},function(d,e){d||0===e.length?b({status:304,message:"DEVICE_DELETE_ERROR",datas:d}):c.reset_session(a,a.session.Auth._id,function(a){a.avatar=a.avatar;b({status:200,message:"DEVICE_DELETE_SUCCESS",idkids_user:a})})})};user_datas.getAge=function(){return this.birthDate};
function checkAvatarExist(a){var b=require("http");b.request({},function(c){return 404!=b.status?a:app.locals.settings.host+"/public/images/assets/account.svg"}).end()};
