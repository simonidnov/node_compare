const db=require("mongoose"),config=require("../config/config"),address_datas={user_id:{type:"string"},label:{type:"string"},first_name:{type:"string"},last_name:{type:"string"},AddressLine1:{type:"string"},AddressLine2:{type:"string"},AddressLine3:{type:"string"},city:{type:"string"},country:{type:"string"},country_code:{type:"string"},cp:{type:"string"},cp_id:{type:"string"},phone:{type:"string"},uniq_encoder:{type:"string"},geocoder:{latitude:{type:"string"},longitude:{type:"string"},country:{type:"string"},countryCode:{type:"string"},city:{type:"string"},zipcode:{type:"string"},streetName:{type:"string"},streetNumber:{type:"string"},administrativeLevels:{level1long:{type:"string"},level1short:{type:"string"},level2long:{type:"string"},level2short:{type:"string"}},provider:{type:"string"}},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now}},NodeGeocoder=require("node-geocoder"),options={provider:"google",httpAdapter:"http",apiKey:config.google.map,formatter:null},geocoder=NodeGeocoder(options);0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const addressSchemas=new db.Schema(address_datas),Address=db.model("Address",addressSchemas);module.exports={attributes:address_datas},module.exports.get=function(e,s,t){var d={};null!==e&&(d.user_id=e),null!==s&&(d.address_id=s),Address.find(d,function(e,s){t(e?{status:405,error:e}:{status:200,datas:s})})},module.exports.getById=function(e,s){Address.findOne({_id:e},function(e,t){s(e?{status:405,datas:e}:{status:200,datas:t})})},module.exports.create=function(e,s,t){s.user_id=e,geocoder.geocode(s.AddressLine1+" "+s.AddressLine2+" "+s.cp+" "+s.city+" "+s.country).then(function(e){s.geocoder=e[0],new_address=new Address(s),new_address.save(function(e,s){t(e?{status:405,message:e}:{status:200,datas:s})})}).catch(function(e){new_address=new Address(s),new_address.save(function(e,s){t(e?{status:405,message:e}:{status:200,datas:s})})})},module.exports.update=function(e,s,t,d){var r={label:t.label,first_name:t.first_name,last_name:t.last_name,AddressLine1:t.AddressLine1,AddressLine2:t.AddressLine2,city:t.city,cp:t.cp,country:t.country,phone:t.phone,AddressLine3:t.AddressLine3,more_datas:t.more_datas};geocoder.geocode(t.AddressLine1+" "+t.AddressLine2+" "+t.cp+" "+t.city+" "+t.country).then(function(e){r.geocoder=e[0],Address.update({_id:t._id},{$set:r},function(e,s){d(e?{status:405,message:e,response_display:{title:"Adresse",message:"Une erreur est survenur lors de la mise à jour de votre adresse."}}:{status:200,address:s,response_display:{title:"Adresse",message:"Votre adresse a bien été mise à jour."}})})}).catch(function(e){Address.update({_id:t._id},{$set:r},function(e,s){d(e?{status:405,message:e,response_display:{title:"Adresse",message:"Une erreur est survenur lors de la mise à jour de votre adresse."}}:{status:200,address:s,response_display:{title:"Adresse",message:"Votre adresse a bien été mise à jour."}})})})},module.exports.delete=function(e,s,t){Address.deleteOne({user_id:e,_id:s},function(e,s){t(e?{status:405,message:e}:{status:200,address:s})})};