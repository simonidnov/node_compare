function authorize(e,r){var s=e.installed.client_secret,t=e.installed.client_id,o=e.installed.redirect_uris[0],n=new googleAuth,i=new n.OAuth2(t,s,o);fs.readFile(TOKEN_PATH,function(e,s){e?getNewToken(i,r):(i.credentials=JSON.parse(s),r(i))})}function getNewToken(e,r){var s=e.generateAuthUrl({access_type:"offline",scope:SCOPES});console.log("Authorize this app by visiting this url: ",s);var t=readline.createInterface({input:process.stdin,output:process.stdout});t.question("Enter the code from that page here: ",function(s){t.close(),e.getToken(s,function(s,t){return s?void console.log("Error while trying to retrieve access token",s):(e.credentials=t,storeToken(t),void r(e))})})}function storeToken(e){try{fs.mkdirSync(TOKEN_DIR)}catch(r){if("EEXIST"!=r.code)throw r}fs.writeFile(TOKEN_PATH,JSON.stringify(e)),console.log("Token stored to "+TOKEN_PATH)}function listLabels(e){var r=google.gmail("v1");r.users.labels.list({auth:e,userId:"me"},function(e,r){if(e)return void console.log("The API returned an error: "+e);var s=r.labels;if(0==s.length)console.log("No labels found.");else{console.log("Labels:");for(var t=0;t<s.length;t++){var o=s[t];console.log("- %s",o.name)}}})}var express=require("express"),gmail=express.Router(),language_helper=require("../helpers/languages_helper"),uri_helper=require("../helpers/uri_helper"),auth_helper=require("../helpers/auth_helper"),lang=require("../public/languages/auth_lang"),machineId=require("node-machine-id"),device_uid=machineId.machineIdSync({original:!0}),Auth_model=require("../models/auth_model"),Members_model=require("../models/members_model"),Address_model=require("../models/address_model"),fs=require("fs"),readline=require("readline"),google=require("googleapis"),googleAuth=require("google-auth-library"),SCOPES=["https://www.googleapis.com/auth/gmail.readonly"],TOKEN_DIR=(process.env.HOME||process.env.HOMEPATH||process.env.USERPROFILE)+"/.credentials/",TOKEN_PATH=TOKEN_DIR+"gmail-nodejs-quickstart.json";gmail.use(function(e,r,s){r.setHeader("Access-Control-Allow-Origin","*"),r.setHeader("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),r.setHeader("Access-Control-Allow-Methods","GET, PUT, POST, DELETE"),r.setHeader("Content-Type","application/json");var t=e.query;("PUT"===e.method||"POST"===e.method||"DELETE"===e.method)&&(t=e.body),s()}),gmail.get("/",function(e,r,s){fs.readFile("client_secret.json",function(e,s){return e?(r.status(200).send({status:"error",err:e}).end(),void console.log("Error loading client secret file: "+e)):(r.status(200).send({status:"hello",content:s}).end(),void authorize(JSON.parse(s),listLabels))})}),module.exports=gmail;