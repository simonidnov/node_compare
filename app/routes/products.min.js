var express=require("express"),Mime=require("mime"),path=require("path"),mkdirp=require("mkdirp"),crypto=require("crypto"),product=express.Router(),UserProducts_controller=require("../controllers/userproducts_controller"),Products_controller=require("../controllers/products_controller"),Auth_helper=require("../helpers/auth_helper"),language_helper=require("../helpers/languages_helper"),uri_helper=require("../helpers/uri_helper"),lang=require("../public/languages/auth_lang"),multer=require("multer"),
storage=multer.diskStorage({destination:function(a,b,c){a=new Date;b=a.getUTCMonth()+1;var d=a.getUTCDate();a="./uploads/"+a.getUTCFullYear()+"-"+b+"-"+d;mkdirp.sync(a);c(null,a)},filename:function(a,b,c){a=new Date;var d=a.getUTCMonth()+1,e=a.getUTCDate(),f=a.getUTCFullYear();crypto.pseudoRandomBytes(16,function(a,g){c(null,f+"-"+d+"-"+e+"-"+g.toString("hex")+"."+Mime.getExtension(b.mimetype))})}}),upload=multer({storage:storage,dest:"./uploads/",inMemory:!0,includeEmptyFields:!0});
product.use(function(a,b,c){b.setHeader("Access-Control-Allow-Origin","*");b.setHeader("Access-Control-Allow-Methods","GET,PUT,POST,DELETE,OPTIONS");b.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization, Content-Length, X-Requested-With");c()});
product.get("/",function(a,b,c){Products_controller.get(a.query,b,function(a){b.status(a.status).send(a.datas)})}).get("/update_amount",function(a,b,c){}).get("/updatephonetik",function(a,b,c){Products_controller.updatePhonetik(a,b,function(a){b.status(a.status).send(a.datas)})}).get("/deleteallproducts",function(a,b,c){}).post("/",function(a,b,c){Auth_helper.validate_admin(a,function(d){200===d.status?Products_controller.create(a.body,b,function(a){b.status(a.status).send(a.datas)}):b.redirect(307,
"/auth?message=NO_ACCESS_RIGHTS")})}).put("/",function(a,b,c){Auth_helper.validate_admin(a,function(d){200===d.status?Products_controller.update(a,b,function(a){b.status(a.status).send(a.datas)}):b.redirect(307,"/auth?message=NO_ACCESS_RIGHTS")})})["delete"]("/",function(a,b,c){Auth_helper.validate_admin(a,function(d){200===d.status?Products_controller["delete"](a.body,b,function(a){b.status(a.status).send(a.datas)}):b.redirect(307,"/auth?message=NO_ACCESS_RIGHTS")})}).get("/medias/:filename",function(a,
b,c){b="";if(-1!==a.params.filename.indexOf("-"))for(var d=a.params.filename.split("-"),e=0;e<d.length-1;e++)b+=d[e],e===d.length-2?(a.params.fullpath=b,c()):b+="-";else a.params.fullpath=b,c()},function(a,b,c){var d=require("fs"),e=a.params.fullpath;d.existsSync("./uploads/"+e+"/"+a.params.filename.replace(".mp3","_shortcut15.mp3"))?(a.params.filename=e+"/"+a.params.filename.replace(".mp3","_shortcut15.mp3"),c()):require("fluent-ffmpeg")("./uploads/"+e+"/"+a.params.filename).duration(15).toFormat("mp3").audioFilters([{filter:"afade",
options:"t=out:st=13:d=2"}]).on("error",function(a){b.status("400").send(a)}).on("progress",function(a){}).on("end",function(){a.params.filename=e+"/"+a.params.filename.replace(".mp3","_shortcut15.mp3");setTimeout(function(){c()},500)}).save("./uploads/"+e+"/"+a.params.filename.replace(".mp3","_shortcut15.mp3"))},function(a,b,c){b.sendFile(a.params.filename,{root:path.join(__dirname,"../uploads")},function(a){})}).put("/medias",function(a,b,c){Auth_helper.validate_admin(a,function(d){200===d.status?
Products_controller.updateFileOrder(a,b,function(a){b.status(a.status).send(a.datas)}):b.status(403).send({message:"Vous n'avez pas les droits n\u00e9c\u00e9ssaires pour mettre a jour les fichiers"})})}).post("/medias",upload.single("file"),function(a,b,c){Auth_helper.validate_admin(a,function(d){200===d.status?Products_controller.addFile(a,a.file,function(a){b.status(a.status).send(a.datas)}):b.status(403).send({message:"Vous n'avez pas les droits n\u00e9c\u00e9ssaires pour uploader des fichiers"})})})["delete"]("/medias",
function(a,b,c){Auth_helper.validate_admin(a,function(d){200===d.status?Products_controller.removeFile(a,b,function(a){b.status(a.status).send(a.datas)}):b.status(403).send({message:"Vous n'avez pas les droits n\u00e9c\u00e9ssaires pour uploader des fichiers"})})}).post("/importFromFiles",upload.single("file"),function(a,b,c){Auth_helper.validate_admin(a,function(d){200===d.status?Products_controller.createProductFromFileName(a,a.file,function(a){b.status(a.status).send(a.datas)}):b.status(403).send({message:"Vous n'avez pas les droits n\u00e9c\u00e9ssaires pour uploader des fichiers"})})}).get(["/sharing",
"/sharing/:share_id","/sharing/:share_id/:product_id","/sharing/:share_id/:product_id/:user_email"],function(a,b,c){UserProducts_controller.getShare(a,b,function(a){b.status(a.status).send(a)})}).post("/share",function(a,b,c){Auth_helper.validate_user(a.body,a.get("host"),function(c){200===c.status?UserProducts_controller.shareProduct(a,b,function(a){b.status(a.status).send(a)}):b.status(203).send({message:"Vous n'avez pas les droits n\u00e9c\u00e9ssaires pour partager ce fichier"})})});
module.exports=product;
