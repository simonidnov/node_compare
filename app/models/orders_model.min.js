const db=require("mongoose"),config=require("../config/config"),basket_model=require("../models/basket_model"),wallets_model=require("../models/wallets_model"),coupon_model=require("../models/coupon_model"),Auth_model=require("../models/auth_model"),Products_controller=require("../controllers/products_controller"),Userproducts_controller=require("../controllers/userproducts_controller"),Email_controller=require("../controllers/email_controller"),order_datas={basket_id:{type:"string"},user_id:{type:"string"},stripeToken:{type:"string"},devise:{type:"string"},amount:{type:"Number"},reduced_amount:{type:"Number"},coupons_code:{type:"Object"},bill_number:{type:"string"},metadata:{type:"Object"},response:{type:"Object"},refund:{type:"Object"},basketdatas:{type:"Object"},status:{type:"Boolean"},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now}};var keyPublishable="",keySecret="";0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const ordersSchemas=new db.Schema(order_datas),Orders=db.model("Orders",ordersSchemas);module.exports={attributes:order_datas},module.exports.getUserOrders=function(e,t,s){void 0===e.current_user._id?s({status:401,message:{message:"UNAUTHORISED_NEED_USER"}}):Orders.find({user_id:e.current_user._id},function(e,t){s(e?{status:405,error:e}:{status:200,datas:t})}).sort({created:-1})},module.exports.get=function(e,t,s){var r={};e.is_admin||(void 0!==e.session.Auth?r={user_id:e.session.Auth._id}:void 0!==e.query.user_id?r={user_id:e.query.user_id}:void 0!==e.query.options&&(r={user_id:e.query.options.user_id})),void 0!==e.query._id&&(r._id=e.query._id),void 0===r.user_id&&void 0===e.is_admin&&s({status:401,datas:{message:"UNAUTHORISED_NEED_USER"}}),Orders.find(r,function(e,t){s(e?{status:405,datas:e}:{status:200,datas:t})}).sort({created:-1})},module.exports.getBill=function(e,t,s){var r={};t.is_admin||(r.user_id=e),void 0!==t.bill_number&&(r.bill_number=t.bill_number),void 0!==t._id&&(r._id=t._id),Orders.findOne(r,function(e,t){s(e?{status:405,datas:e}:{status:200,datas:t})})},module.exports.buy_with_coupon=function(e,t,s){if(void 0===e.body.data.coupon_code)return s({status:400,message:"NEED_COUPON_CODE",response_display:{title:"Code de téléchargement",message:"Vous devez renseigner un Code de téléchargement valide pour effectuer cette opération."}}),!1;if(void 0===e.body.data.coupon_id)return s({status:400,message:"NEED_COUPON_ID",response_display:{title:"Code de téléchargement",message:"Le coupon est incorrect ou mal renseigné, veuillez réessayer ultérieurement."}}),!1;if(void 0===e.body.data.product_id)return s({status:400,message:"NEED_PRODUCT_ID",response_display:{title:"Code de téléchargement",message:"Pour utiliser votre Code de téléchargement, vous devez choisir un produit."}}),!1;if(void 0===e.body.data.options.user_id)return s({status:400,message:"NEED_USER_ID",response_display:{title:"Code de téléchargement",message:"Vos identifiants sont incorrects, si le problème persiste veuillez vous déconnecter puis vous reconnecter"}}),!1;Products_controller.get(e.body.data,t,function(r){200===r.status&&Userproducts_controller.allreadyBuy(e.body.data.options.user_id,e.body.data.product_id,function(r){200===r.status?s({status:208,message:"PRODUCT_ALREADY_BUY",response_display:{title:"Coupon Code Produit déjà ajouté !",message:"Vous tentez d'ajouter un produit que vous avez déjà acheté !<br>rendez-vous sur votre compte pour le télécharger ou sur machanson.joyvox.fr/playlist pour l'écouter.",buttons:[{class:"btn-success",label:"MES ACHATS",href:app.locals.settings.host+"/account/orders",target:"_self",value:"/account/orders"},{class:"",label:"PLAYLIST",href:"/playlist",target:"_self",value:"/playlist"}]}}):coupon_model.is_valid(e.body.data.coupon_code,e.body.data.coupon_id,function(r){200===r.status?Userproducts_controller.create({user_id:e.body.data.options.user_id,product_id:e.body.data.product_id},t,function(t){200===t.status?coupon_model.useOne({_id:e.body.data.coupon_id,user_id:e.body.data.options.user_id},function(e){s(200===e.status?{status:200,message:"PRODUCT_ADDED",response_display:{title:"Votre chanson !",message:"Votre chanson est à présent disponible sur votre playlist !<br>Votre code de téléchargement est à présent validé et ne peut plus être utilisé.",buttons:[{class:"btn-success",label:"PLAYLIST",href:"http://machanson.joyvox.fr/playlist",target:"_self",value:"/playlist"}]}}:{status:208,message:"UNABLE_TO_USE_COUPON_CODE",response_display:{title:"ERREUR",message:"une erreur est survenur, pas d'inquiètude, votre coupon code de téléchargement est toujours valide."}})}):(t.response_display={title:"Coupon Code",message:"une erreur est survenur mais pas d'inquiètudes !<br>votre coupon code de téléchargement est toujours valide, vous pouvez toujours l'utiliser."},s(t))}):s({status:208,message:"WRONG_COUPON_CODE",response_display:{title:"Coupon Code",message:"Le coupon renseigné est invalide, veuillez en utiliser un autre.<br>Si vous n'avez jamais utilisé ce coupon, veuillez nous contacter pour en obtenir un nouveau.",buttons:[{class:"btn-warning",label:"NOUS CONTACTER",href:app.locals.settings.host+"/contact",target:"_self",value:"/account/contact"}]}})})})})},module.exports.refundCharge=function(e,t,s){void 0!==e.data&&(e=e.data),app.locals.settings.StripeMode?(keyPublishable=app.locals.settings.StripekeyPublishable,keySecret=app.locals.settings.StripekeySecret):(keyPublishable=app.locals.settings.StripekeyPublishableTest,keySecret=app.locals.settings.StripekeySecretTest);var r=require("stripe")(keySecret);void 0===e.order_id&&s({status:401,message:"NEED_ORDER_ID"}),Orders.findOne({_id:e.order_id},function(t,o){t?s({status:403,message:"ORDER_DOESNT_MATCH",response_display:{title:"Remboursement",message:"La transaction que vous tentez de rembourser est introuvable, assurez-vous de ne pas faire nimporte quoi avant de contacter un administrateur."}}):r.refunds.create({charge:o.response.id},function(t,r){t?"charge_already_refunded"===t.code?Orders.updateOne({_id:e.order_id},{refund:t},function(e,t){e?s({status:403,message:"ALREADY_REFUNDED_BY_STRIPE",response_display:{title:"Attention Remboursement",message:"Il semble que la commande soit déjà remboursée par Stripe, pour plus d'informations rendez-vous sur Stripe."}}):(Email_controller.send(null,{subject:"Votre remboursement Joyvox",title:"Votre paiement vient d'être remboursé !",message:"Votre remboursement pour la commande "+o.bill_number+" d'un montant de "+o.reduced_amount/100+"€ a bien été pris en charge.<br>Le remboursement est en cours de traitement par votre banque et sera bientôt effectif sur votre compte bancaire.<br><br>Le statu de votre facture est à présent marqué comme étant remboursé et les produits en téléchargement concernant cette commande ne sont à présent plus accéssibles via votre compte utilisateur Joyvox.<br><br>Cordialiement,<br> l'équipe Joyvox.<br>",buttons:[{title:"Mon compte",url:"http://auth.joyvox.fr/account"}],email:o.response.source.name,to:o.response.source.name},function(e){}),s({status:200,message:"ALREADY_REFUNDED_BY_STRIPE_AND_UPDATED_BY_JOYVOX",response_display:{title:"Remboursement",message:"Le remboursement que vous tentez d'effectuer est déjà effectif sur la console Stripe. Nous venons de mofidier le status de la commande en REMBOURSÉ."}}))}):s({status:403,message:"REFUND_IMPOSSIBLE",response_display:{title:"Remboursement",message:"Stripe refuse d'effectuer le remboursement, vous trouverez plus d'informations dans la console, si le problème perciste veuillez contacter un administrateur ayant accès à la console Stripe."},err:t}):Orders.updateOne({_id:e.order_id},{refund:r},function(e,t){e?s({status:403,message:"CANT_UPDATE_ORDER_STATUS",response_display:{title:"Attention Remboursement",message:"Le remboursement est bien effectif sur stripe mais nous n'avons pas réussi à mettre à jour le status de la facture. Veuillez contacter un administrateur pour le changer manuellement."}}):(Email_controller.send(null,{subject:"Votre remboursement Joyvox",title:"Votre paiement vient d'être remboursé !",message:"Votre remboursement pour la commande "+o.bill_number+" d'un montant de "+o.reduced_amount/100+"€ a bien été pris en charge.<br>Le remboursement est en cours de traitement par votre banque et sera bientôt effectif sur votre compte bancaire.<br>Vos produits concernant cette commande ne sont à présent plus accéssibles.<br>À bientôt sur joyvox !<br>",buttons:[{title:"Mon compte",url:"http://auth.joyvox.fr/account"}],email:o.response.source.name,to:o.response.source.name},function(e){}),s({status:200,message:"ORDER_REFUND_STATUS_UPDATED",response_display:{title:"Remboursement",message:"Le remboursement a bien été pris en charge, il sera effectif après traitement de la plateforme de paiement Stripe, le statu de la facture du client a égélament bien été mis à jour et le client sera averti lorsque son remboursement sera effectif."}}))})})})},module.exports.createCharge=function(e,t,s){app.locals.settings.StripeMode?(keyPublishable=app.locals.settings.StripekeyPublishable,keySecret=app.locals.settings.StripekeySecret):(keyPublishable=app.locals.settings.StripekeyPublishableTest,keySecret=app.locals.settings.StripekeySecretTest);var r=require("stripe")(keySecret);void 0===e.basket_id&&s({status:401,message:"NEED_BASKET_ID"}),void 0===e.user_id&&s({status:401,message:"NEED_USER_ID"});var o=0,a=0,n=this;basket_model.get(e,t,function(u){var i=u.datas[0];if(200===u.status){for(var d=0;d<u.datas[0].products.length;d++)o+=u.datas[0].products[d].price;if(a=o,void 0!==e.coupons_code&&""!==e.coupons_code)for(var l=JSON.parse(e.coupons_code),d=0;d<l.length;d++)a-=l[d].amount;a<0&&(a=0);const c=e.stripeToken;r.charges.create({amount:a,currency:"eur",description:"payment ",source:c},function(r,d){r?s({status:401,message:"BASKET_DOESNT_MATCH",response_display:{title:"Paiement",message:"Un problème est survenu lors du règlement de votre commande. Celle-ci n’a pas été validée et votre compte ne sera pas débité.<br>Nous vous prions de nous excuser et vous invitons à renouveler l’opération ultérieurement."}}):Orders.find().count().exec(function(r,p){var m=p,_="FA";_+=new Date(Date.now()).getFullYear().toString().substring(1,4),_+=(m/1e6).toString().replace("0.","");var b={basket_id:e.basket_id,user_id:e.user_id,stripeToken:c,devise:"eur",amount:o,reduced_amount:a,coupons_code:l,bill_number:_,metadata:i,response:d,basketdatas:u.datas[0],status:1};if(void 0!==l)for(var v=0;v<l.length;v++)coupon_model.useOne({_id:l[v].id,user_id:e.user_id},function(e){});basket_model.deleteUserBasket(e.user_id,function(e){}),n.create(b,t,function(t){200===t.status?(Auth_model.getUserInfosFromOrderController(e.user_id,function(e){200===e.status&&(Email_controller.send(null,{subject:"Votre facture Joyvox",title:"Votre commande vient d'être validée !",message:"Votre réglement pour la commande "+_+" d'un montant de "+d.amount/100+'€ a bien été pris en charge.<br>Pour plus d\'informations et obetenir votre facture, rendez-vous sur <a href="https://auth.joyvox.fr/account/orders">votre compte client dans la rubrique Achats</a>.<br>Pour écouter votre chanson, rendez-vous dans votre playlist !<br>Merci et à bientôt sur joyvox !<br>',buttons:[{title:"Ma playlist",url:"http://machanson.joyvox.fr/playlist"}],email:e.user.email,to:e.user.email},function(e){}),Email_controller.send(null,{subject:"Nouvelle commande sur JOYVOX",title:"UNE NOUVELLE COMMANDE VIENT D'ÊTRE RÉGLÉE SUR JOYVOX",message:"Numéro de commande : "+_+"<br>Montant : "+d.amount/100+'€<br>a bien été pris en charge.<br>Pour plus d\'informations et obetenir la facture, rendez-vous sur <a href="https://auth.joyvox.fr/admin">Dans la rubrique facturation</a>.<br>',email:"service.transaction@joyvox.fr",to:"service.transaction@joyvox.fr"},function(e){}))}),s({status:200,datas:b})):(t.datas=b,s(t))})})})}else s({status:401,message:"BASKET_DOESNT_MATCH",response_display:{title:"Mon Panier",message:"Impossible de continuer car les paramètres de votre requête sont invalides."}})})},module.exports.create=function(e,t,s){new_order=new Orders(e),new_order.save(function(e,t){s(e?{status:405,message:e}:{status:200,datas:t})})},module.exports.update=function(e,t,s){var r={};r.updated=Date.now(),Orders.updateOne({_id:ORDER_ID},{$set:r},function(e,t){s(e?{status:405,message:e}:{status:200,apps:t})})},module.exports.delete=function(e,t,s){s({status:401,message:"UNAUTHORISED_METHOD"})};