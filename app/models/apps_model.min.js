const db=require("mongoose"),config=require("../config/config"),jwt=require("jsonwebtoken"),apps_datas={icon:{type:"string"},logo:{type:"string"},splash:{type:"string"},color:{type:"string"},label:{type:"string"},name:{type:"string",unique:!0},short_name:{type:"string"},bundle:{type:"string",unique:!0},description:{type:"string"},short_desc:{type:"string"},host:{type:"string"},aliases:{type:"Object"},redirect_url:{type:"string"},tags:{type:"Array"},secret:{type:"string"},token:{type:"string"},authorizations:{user_public:{type:"boolean"},user_private:{type:"boolean"}},certificats:{apple:{type:"string"},android:{type:"string"},osx:{type:"string"},windows:{type:"string"}},terms_url:{type:"String"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const appsSchemas=new db.Schema(apps_datas),Apps=db.model("Apps",appsSchemas);module.exports={attributes:apps_datas},module.exports.validate=function(e,t,s){Apps.find({host:t,secret:e,$or:{aliases:{$indexOfArray:[t]},secret:e}},function(e,t){s(e?{status:405,datas:e}:{status:200,datas:t})})},module.exports.get=function(e,t,s){console.log("APP MODEL GET");var a={};Apps.find(a,function(e,t){console.log("APP MODEL RESULT ",e,t),s(e?{status:405,datas:e}:{status:200,datas:t})})},module.exports.create=function(e,t,s){t.secret=jwt.sign({secret:e},config.secrets.global.secret),t.token=jwt.sign({secret:e+Date.now()},config.secrets.global.secret),new_apps=new Apps(t),new_apps.save(function(e,t){s(e?{status:405,message:e}:{status:200,datas:t})})},module.exports.update=function(e,t,s,a){delete s.options,delete s._id,s.updated=Date.now(),Apps.updateOne({_id:t},{$set:s},function(e,t){a(e?{status:405,message:e}:{status:200,apps:t})})},module.exports["delete"]=function(e,t,s){Apps.deleteOne({_id:t},function(e,t){s(e?{status:405,message:e}:{status:200,apps:t})})};