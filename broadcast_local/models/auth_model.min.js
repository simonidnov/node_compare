const db=require("mongoose"),app=require("../app"),sha1=require("sha1"),jwt=require("jsonwebtoken"),validator=require("email-validator"),config=require("../config/config"),os=require("os"),user_datas={email:{type:"string",unique:!0},password:{type:"string"},pseudo:{type:"string"},firstName:{type:"string"},lastName:{type:"string"},token:{type:"string"},secret:{type:"string"},birthDate:{type:"Date"},civility:{type:"string","enum":["undefined","male","female"],defaults:"undefined"},address:{type:"Array"},members:{type:"Array"},relations:{type:"Array"},tags:{type:"Object"},devices:{type:"Object"},members:{type:"Object"},termAccept:{type:"Boolean"},newsletter:{type:"Boolean"},newsletter_services:{type:"Object"},validated:{type:"Boolean"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const userSchemas=new db.Schema(user_datas),User=db.model("User",userSchemas);module.exports={attributes:user_datas},module.exports.login=function(e,t){return e.password?validator.validate(e.email)?User.find({email:e.email,password:sha1(e.password)},function(s,a){if(s)t({status:"error",code:s.code,error:s,message:s.message});else{if(0===a.length)return User.find({email:e.email},function(e,s){t(e?{status:"error",code:11,error:e,message:"user_not_found"}:0===s.length?{status:"error",code:11,error:e,message:"user_not_found",email_valid:s.length}:{status:"error",code:13,error:e,message:"wrong_pawword",email_valid:s.length})}),!1;var r={uid:e.device_uid,arch:os.arch(),name:os.hostname()},i=jwt.sign({secret:a[0].secret},config.secrets.global.secret);r.token=i,User.find({_id:a[0]._id,devices:{$elemMatch:{uid:e.device_uid}}},function(t,s){t?User.update({_id:a[0]._id},{$push:{devices:r}},function(e,t){e?console.log("impossible d insérer le new_device ",e):console.log("new_device ajouté success ",t)}):0===s.length?User.update({_id:a[0]._id},{$push:{devices:r}},function(e,t){e?console.log("impossible d insérer le new_device ",e):console.log("new_device ajouté success ",t)}):User.update({id:a[0]._id,devices:{$elemMatch:{uid:e.device_uid}}},{$set:{token:i}},function(e,t){e?console.log("update device token error ",e):console.log("update device token success ",t)},!0)}),User.update({_id:a[0]._id},{$set:{token:i,updated:Date.now()}},function(s,r){s?t({status:"error",code:s.code,error:s,message:s.message}):User.find({_id:a[0]._id},function(s,a){if(s)t({status:"error",code:s.code,error:s,message:s.message});else{var r=JSON.parse(JSON.stringify(a[0]));delete r.password,delete r.relations,delete r.address,r.current_device=e.device_uid,t({status:"success",idkids_user:r})}})})}}):t({message:"email invalide"},null):t([]),e},module.exports.logout=function(e,t){return t(),e},module.exports.register=function(e,t){db.connect(config.database.users,{useMongoClient:!0});var s={email:e.body.subscribe_email,password:sha1(e.body.subscribe_password),pseudo:e.body.pseudo,secret:jwt.sign({},config.secret,{}),termAccept:!0};return s.token=jwt.sign({secret:s.secret},config.secrets.global.secret),s.device=[{uid:e.body.device_uid,arch:os.arch(),name:os.hostname(),token:jwt.sign({secret:s.secret},config.secrets.global.secret)}],e.body.subscribe_newsletter?(s.newsletter=!0,s.newsletter_services={},e.body.newsletter_okaidi&&(s.newsletter_services.okaidi=1),e.body.newsletter_obaibi&&(s.newsletter_services.obaibi=1),e.body.newsletter_jacadi&&(s.newsletter_services.jacadi=1),e.body.newsletter_oxybul&&(s.newsletter_services.oxybul=1),e.body.newsletter_rclv&&(s.newsletter_services.rclv=1),e.body.newsletter_njoy&&(s.newsletter_services.njoy=1),e.body.newsletter_joyvox&&(s.newsletter_services.joyvox=1)):(s.newsletter=!1,s.newsletter_services={}),new_user=new User(s),new_user.save(function(e){t(e?{status:"error",code:e.code,duplicated_value:e.message.split('{ : "')[1].replace('" }',""),error:e}:{status:"success",infos:new_user})}),e.body},module.exports.unregister=function(e){return e},module.exports.update=function(e){return e},user_datas.getFullName=function(){return this.firstName+" "+this.lastName},user_datas.getAge=function(){return this.birthDate};