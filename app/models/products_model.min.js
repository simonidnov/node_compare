var $jscomp={scope:{},findInternal:function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(b.call(c,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6-impl","es3");var db=require("mongoose"),_=require("underscore"),Apps_model=require("../models/apps_model"),config=require("../config/config"),language_helper=require("../helpers/languages_helper");
products_datas={label:{type:"string",unique:!1},description:{type:"string"},keywords:{type:"string"},category:{type:"string"},sub_category:{type:"string"},extra_category:{type:"string"},public_target:{type:"string"},typology:{type:"string"},app_id:{type:"ObjectId"},app_icon:{type:"string"},app_label:{type:"string"},phonetik:{type:[]},thumb:{type:"string"},picture:{type:"string"},details:{type:"string"},price:{type:"number"},devise:{type:"string","enum":["\u20ac","\u00a3","$"]},type:{type:"string",
"enum":["physical","demateralized"]},attributs:{type:"Array"},medias:{type:"Array"},created:{type:"Date","default":Date.now},updated:{type:"Date","default":Date.now}};fs=require("fs");0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0},function(a,b){});var productsSchemas=new db.Schema(products_datas);productsSchemas.pre("find",function(a){a()});var Products=db.model("Products",productsSchemas);module.exports={attributes:products_datas,Products:Products};
module.exports.get=function(a,b,c){b={};"undefined"!==typeof a.product_id&&(b._id=a.product_id);"undefined"!==typeof a.label&&(b.label=a.label);"undefined"!==typeof a.phonetik&&(b.phonetik={$in:language_helper.wordlab(a.phonetik).split("-")});var d=0;"undefined"!==typeof a.skip&&(d=parseInt(a.skip));console.log("GET PRODUCT :::: ",b);Products.find(b).limit(50).skip(d).sort({label:1}).exec(function(a,d){if(a)c({status:304,datas:{title:"PRODUCT_GET_ERROR",message:"PRODUCT_GET_ERROR_MESSAGE",media:"PRODUCT_GET_ERROR_MEDIA",
code:a.code,errmsg:a.errmsg}});else{var b=0;0===d.length&&c({status:200,datas:d});d.forEach(function(a){Apps_model.get(null,{_id:a.app_id},function(e){0<e.datas.length?(a.app_icon=e.datas[0].icon,a.app_label=e.datas[0].label,a.app_infos=[],b++,b===d.length&&c({status:200,datas:d})):c({status:200,datas:d})})})}})};
module.exports.create=function(a,b,c){delete b.options;delete b.device_infos;b.label=b.label.toUpperCase();a=language_helper.wordlab(b.label+" "+b.description).split("-");b.phonetik=a.filter(function(a,c,b){return b.indexOf(a)===c});new_product=new Products(b);new_product.save(function(a,b){a?c({status:304,datas:{title:"PRODUCT_CREATED_ERROR",message:"PRODUCT_CREATED_ERROR_MESSAGE",media:"PRODUCT_CREATED_ERROR_MEDIA",code:a.code,errmsg:a.errmsg}}):c({status:200,datas:{infos:b,title:"PRODUCT_CREATED",
message:"PRODUCT_CREATED_MESSAGE",media:"PRODUCT_CREATED_MEDIA"}})})};
module.exports.update=function(a,b,c,d){delete c.options;delete c.device_infos;delete c._id;"undefined"!==typeof c.label&&(c.label=c.label.toUpperCase());c.updated=Date.now();a=language_helper.wordlab(c.label+" "+c.description).split("-").filter(function(a,c,b){return b.indexOf(a)===c});Products.updateOne({_id:b},{$set:c,phonetik:a},function(a,c){a?d({status:304,datas:{title:"PRODUCT_UPDATED_ERROR",message:"PRODUCT_UPDATED_ERROR_MESSAGE",media:"PRODUCT_UPDATED_ERROR_MEDIA",code:a.code,errmsg:a.errmsg}}):
d({status:200,datas:{infos:c,title:"PRODUCT_UPDATED",message:"PRODUCT_UPDATED_MESSAGE",media:"PRODUCT_UPDATED_MEDIA"}})})};module.exports["delete"]=function(a,b,c){Products.deleteOne({_id:b},function(a,b){a?c({status:304,datas:{title:"PRODUCT_DELETED_ERROR",message:"PRODUCT_DELETED_ERROR_MESSAGE",media:"PRODUCT_DELETED_ERROR_MEDIA",code:a.code,errmsg:a.errmsg}}):c({status:200,datas:{infos:b,title:"PRODUCT_DELETED",message:"PRODUCT_DELETED_MESSAGE",media:"PRODUCT_DELETED_MEDIA"}})})};
module.exports.getFile=function(a,b,c){fs.readFile("./uploads/"+a.params.filename,function(a,b){if(a)throw a;content=b;c({status:200,datas:content})})};
module.exports.updatePhonetik=function(a,b,c){Products.find({},function(a,b){if(a)c({status:304,datas:{title:"PRODUCT_GET_ERROR",message:"PRODUCT_GET_ERROR_MESSAGE",media:"PRODUCT_GET_ERROR_MEDIA",code:a.code,errmsg:a.errmsg}});else{var d=0;0===b.length&&c({status:200,datas:b});b.forEach(function(a){a.label=a.label.toUpperCase();var e=language_helper.wordlab(a.label+" "+a.description).split("-");a.phonetik=e.filter(function(a,b,c){return c.indexOf(a)===b});console.log(e);console.log(a.phonetik);Products.updateOne({_id:a._id},
{$set:a},function(a,b){a?console.log("----------------- ERROR PHONETIK -----------------",a):console.log("updated ",b)});d++;d===b.length&&c({status:200,datas:b})})}})};
module.exports.createProductFromFile=function(a,b,c){for(var d={},e=a.parse_string_file_name.split(";"),f=b.originalname.split(".")[0].split(a.separator),g=0;g<e.length;g++)d[e[g]]=f[g];_.templateSettings={interpolate:/\{\{(.+?)\}\}/g};e=_.template(a.description);d.description=e(d);d.app_id=a.app_id;a=language_helper.wordlab(a.label+" "+a.description).split("-");d.phonetik=a.filter(function(a,b,c){return c.indexOf(a)===b});d.label=d.label.toUpperCase();var h=this;new_product=new Products(d);new_product.save(function(a,
d){a?c({status:304,datas:{title:"PRODUCT_CREATED_ERROR",message:"PRODUCT_CREATED_ERROR_MESSAGE",media:"PRODUCT_CREATED_ERROR_MEDIA",code:a.code,errmsg:a.errmsg}}):(console.log(d),h.addFile(d._id,b,function(){c({status:200,datas:{infos:d,title:"PRODUCT_CREATED",message:"PRODUCT_CREATED_MESSAGE",media:"PRODUCT_CREATED_MEDIA"}})}))})};module.exports.deleteAllProducts=function(a,b,c){Products.remove({},function(a,b){c({status:200,error:a,datas:b})})};
module.exports.addFile=function(a,b,c){Products.updateOne({_id:a},{$push:{medias:{fieldname:b.filedname,originalname:b.originalname,encoding:b.encoding,mimetype:b.mimetype,destination:b.destination,filename:b.filename,path:b.path,size:b.size}}},function(a,b){a?c({status:403,datas:{title:"PRODUCT_UPDATED_ERROR",message:"PRODUCT_UPDATED_ERROR_MESSAGE",media:"PRODUCT_UPDATED_ERROR_MEDIA",code:a.code,errmsg:a.errmsg}}):c({status:200,datas:{infos:b,title:"PRODUCT_UPDATED",message:"PRODUCT_UPDATED_MESSAGE",
media:"PRODUCT_UPDATED_MEDIA"}})})};
module.exports.removeFile=function(a,b,c){fs.unlink("./uploads/"+b,function(){});this.get(null,{_id:a},function(d){if(200===d.status){for(var e=[],f=0;f<d.datas[0].medias.length;f++)"undefined"!==typeof d.datas[0].medias[f]&&"undefined"!==typeof d.datas[0].medias[f][0]&&null!==d.datas[0].medias[f][0]&&d.datas[0].medias[f][0].filename!==b&&e.push(d.datas[0].medias[f]);Products.updateOne({_id:a},{medias:e},function(a,b){a?c({status:403,datas:{title:"PRODUCT_UPDATED_ERROR",message:"PRODUCT_UPDATED_ERROR_MESSAGE",
media:"PRODUCT_UPDATED_ERROR_MEDIA",code:a.code,errmsg:a.errmsg}}):c({status:200,datas:{infos:b,title:"MEDIA_DELETED",message:"MEDIA_DELETED",media:"MEDIA_DELETED"}})})}else c({status:403,datas:{title:"PRODUCT_UPDATED_ERROR",message:"PRODUCT_UPDATED_ERROR_MESSAGE",media:"PRODUCT_UPDATED_ERROR_MEDIA",code:err.code,errmsg:err.errmsg}})})};
