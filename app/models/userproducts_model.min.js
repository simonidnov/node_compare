const db=require("mongoose"),config=require("../config/config"),Orders_model=require("../models/orders_model"),Products_model=require("../models/products_model"),userproducts_datas={user_id:{type:"string"},product_id:{type:"string"},meta_datas:{type:"Object"},created:{type:"Date",default:Date.now},updated:{type:"Date",default:Date.now}};0===db.connection.readyState&&db.connect(config.database.users,{useMongoClient:!0});const userproductsSchemas=new db.Schema(userproducts_datas),Userproducts=db.model("Userproducts",userproductsSchemas);module.exports={attributes:userproducts_datas},module.exports.get=function(s,e,t){var d={},r=this;if(void 0!==s.session.Auth?d={user_id:s.session.Auth._id}:void 0!==s.query.user_id?d={user_id:datas.user_id}:void 0!==s.query.options&&(d={user_id:s.query.options.user_id}),void 0===d.user_id)return t({status:401,datas:{message:"UNAUTHORISED_NEED_USER"}}),!1;s.user_id=d.user_id,r.checkOrders(s,e,function(s){Userproducts.find(d,function(s,e){return s?(t({status:405,datas:s}),!1):(t({status:200,datas:e}),!1)}).sort({created:-1})})},module.exports.allreadyBuy=function(s,e,t){Userproducts.findOne({user_id:s,product_id:e},function(s,e){t(s?{status:404,message:"NEVER_BUY"}:null===e?{status:404,message:"NEVER_BUY",datas:e}:{status:200,message:"ALREADY_BUY",datas:e})})},module.exports.checkOrders=function(s,e,t){var d=this;Orders_model.get(s,e,function(t){if(200===t.status)for(var r=0;r<t.datas.length;r++)for(var u=0;u<t.datas[r].basketdatas.products.length;u++)d.create({user_id:s.user_id,product_id:t.datas[r].basketdatas.products[u].product_id},e,function(s){console.log("checkOrders ::: ",s)})}),t({status:200,message:"CHECKING"})},module.exports.create=function(s,e,t){Userproducts.find({user_id:s.user_id,product_id:s.product_id},function(d,r){d||0===r.length?Products_model.get({product_id:s.product_id},e,function(e){new_userproduct=new Userproducts({user_id:s.user_id,product_id:s.product_id,meta_datas:e.datas[0]}),new_userproduct.save(function(s,e){t(s?{status:405,message:s}:{status:200,datas:e})})}):t({status:200,datas:r})})};